{{ if not .SkipLayout }}{{ template "header.html" . }}{{ end }}

<div class="space-y-6">
    <h2 class="text-2xl font-bold text-gray-700">æ•°æ®å¤‡ä»½ä¸è¿˜åŸ</h2>

    <div class="space-y-6 text-gray-800">
        <!-- Backup Section -->
        <div class="bg-white/60 p-6 rounded-xl border border-white/70 shadow-sm relative overflow-hidden group">
            <div class="relative z-10">
                <h3 class="text-lg font-semibold mb-2 flex items-center gap-2">
                    <span>ğŸ“¦</span> å¤‡ä»½æ•°æ®
                </h3>
                <div class="mb-4 text-sm text-gray-600 space-y-1 bg-white/50 p-3 rounded-lg border border-gray-100">
                    <div class="flex justify-between"><span>è®¢é˜…æ€»æ•°:</span> <span class="font-bold">{{
                            .Stats.SubscriptionCount }}</span></div>
                    <div class="flex justify-between"><span>å†å²è®°å½•:</span> <span class="font-bold">{{
                            .Stats.DownloadLogCount }}</span></div>
                    <div class="flex justify-between"><span>ç”¨æˆ·è´¦å·:</span> <span class="font-bold">{{
                            .Stats.UserCount }}</span></div>
                    <!-- Local Anime not backed up anymore, but this view shows Current DB stats. Keep it? -->
                    <!-- Wait, if we export filtered, this stat might be misleading if user thinks it IS backed up. -->
                    <!-- But this card shows "Current DB Stats". Export button creates backup. -->
                    <div class="flex justify-between text-gray-400"><span>æœ¬åœ°ç•ªå‰§:</span> <span class="font-bold">{{
                            .Stats.LocalAnimeCount }} (ä»…æœ¬åœ°)</span></div>
                    <div class="flex justify-between"><span>æ•°æ®åº“å¤§å°:</span> <span class="font-bold">{{ .Stats.DatabaseSize
                            }}</span></div>
                    <div class="flex justify-between"><span>æœ€åä¿®æ”¹:</span> <span class="font-mono text-xs">{{
                            .Stats.LastModified }}</span></div>

                    {{ if .Stats.SubscriptionTitles }}
                    <div class="mt-2 pt-2 border-t border-gray-200">
                        <div class="text-xs text-gray-500 mb-1">åŒ…å«çš„è®¢é˜…:</div>
                        <div class="max-h-[100px] overflow-y-auto space-y-1 pr-1 custom-scrollbar">
                            {{ range .Stats.SubscriptionTitles }}
                            <div class="text-xs bg-white px-2 py-1 rounded border border-gray-100 truncate">{{ . }}
                            </div>
                            {{ end }}
                        </div>
                    </div>
                    {{ end }}
                </div>
                <p class="text-sm text-gray-600 mb-4">
                    ä¸‹è½½ç»è¿‡ç­›é€‰çš„æ•°æ®åº“æ–‡ä»¶ (ä»…åŒ…å«è®¢é˜…ã€æ—¥å¿—å’Œè®¾ç½®ï¼Œä¸å«æœ¬åœ°ç•ªå‰§ç´¢å¼•)ã€‚
                </p>
                <a href="/api/backup/export" target="_blank"
                    class="inline-flex items-center gap-2 px-6 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition shadow-lg shadow-emerald-200">
                    <span>â¬‡ï¸</span> ä¸‹è½½å¤‡ä»½
                </a>
            </div>
            <div
                class="absolute -right-10 -bottom-10 text-9xl text-emerald-100 opacity-50 group-hover:scale-110 transition duration-500 select-none">
                ğŸ’¾
            </div>
        </div>

        <!-- Restore Section -->
        <div class="bg-white/60 p-6 rounded-xl border border-white/70 shadow-sm relative overflow-hidden group">
            <div class="relative z-10">
                <h3 class="text-lg font-semibold mb-2 flex items-center gap-2 text-red-600">
                    <span>âš ï¸</span> è¿˜åŸæ•°æ®
                </h3>
                <p class="text-sm text-gray-600 mb-4">
                    ä¸Šä¼ å¤‡ä»½æ–‡ä»¶è¿›è¡Œåˆ†æï¼Œé¢„è§ˆæ•°æ®åå†ç¡®è®¤è¿˜åŸã€‚
                </p>

                <form hx-post="/api/backup/analyze" hx-encoding="multipart/form-data" hx-target="#restore-preview"
                    hx-indicator="#analyze-btn" class="flex items-end gap-4 mb-4">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">é€‰æ‹©å¤‡ä»½æ–‡ä»¶ (.db)</label>
                        <input type="file" name="backup_file" accept=".db" required
                            class="w-full px-4 py-2 bg-white/50 rounded-lg border border-gray-300 focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100">
                    </div>
                    <div>
                        <button type="submit" id="analyze-btn"
                            class="inline-flex items-center gap-2 px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition shadow-lg shadow-blue-200 cursor-pointer h-[42px]">
                            <span class="[.htmx-request_&]:hidden">ğŸ”</span>
                            <span class="hidden [.htmx-request_&]:inline animate-spin">âŒ›</span>
                            åˆ†ææ–‡ä»¶
                        </button>
                    </div>
                </form>

                <!-- Preview Container -->
                <div id="restore-preview" class="mt-4"></div>
            </div>
            <div
                class="absolute -right-6 -bottom-6 text-9xl text-red-100 opacity-50 group-hover:rotate-12 transition duration-500 select-none">
                â™»ï¸
            </div>
        </div>

        <!-- Cloudflare R2 Section -->
        <div class="bg-white/60 p-6 rounded-xl border border-white/70 shadow-sm relative overflow-hidden group">
            <div class="relative z-10">
                <h3 class="text-lg font-semibold mb-2 flex items-center gap-2 text-orange-600">
                    <span>â˜ï¸</span> Cloudflare R2 äº‘å¤‡ä»½
                </h3>

                <div x-data="r2BackupData()" class="space-y-4">

                    <!-- Config Form -->
                    <div
                        class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-white/50 p-4 rounded-lg border border-gray-100">
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">R2 Endpoint (ç«¯ç‚¹åœ°å€)</label>
                            <input type="text" x-model="config.endpoint"
                                placeholder="https://<account>.r2.cloudflarestorage.com"
                                class="w-full text-sm px-3 py-2 bg-white rounded border border-gray-200 focus:border-orange-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">Bucket Name (å­˜å‚¨æ¡¶åç§°)</label>
                            <input type="text" x-model="config.bucket" placeholder="animate-backup"
                                class="w-full text-sm px-3 py-2 bg-white rounded border border-gray-200 focus:border-orange-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">Access Key ID</label>
                            <input type="text" x-model="config.access_key"
                                class="w-full text-sm px-3 py-2 bg-white rounded border border-gray-200 focus:border-orange-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">Secret Access Key</label>
                            <input type="password" x-model="config.secret_key" placeholder="********"
                                class="w-full text-sm px-3 py-2 bg-white rounded border border-gray-200 focus:border-orange-500 outline-none">
                        </div>
                        <div class="md:col-span-2 text-right space-x-2 flex items-center justify-end gap-2">
                            <span x-show="testMessage" x-text="testMessage"
                                :class="testError ? 'text-red-500' : 'text-green-500'"
                                class="text-xs font-semibold transition-opacity duration-500"></span>
                            <button @click="testConnection" :disabled="loading"
                                :class="loading ? 'bg-blue-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-500'"
                                class="text-xs text-white px-3 py-1.5 rounded transition flex items-center gap-1">
                                <span x-show="loading && testMessage === 'æµ‹è¯•ä¸­...'"
                                    class="animate-spin h-3 w-3 border-2 border-white rounded-full border-t-transparent"></span>
                                <span x-text="loading && testMessage === 'æµ‹è¯•ä¸­...' ? 'æµ‹è¯•ä¸­...' : 'æµ‹è¯•è¿æ¥'"></span>
                            </button>
                            <button @click="saveConfig"
                                class="text-xs bg-gray-800 text-white px-3 py-1.5 rounded hover:bg-gray-700 transition">ä¿å­˜é…ç½®</button>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex items-center justify-between border-b border-gray-200 pb-2">
                        <h4 class="text-sm font-semibold text-gray-700">äº‘ç«¯å¤‡ä»½åˆ—è¡¨</h4>
                        <div class="flex items-center gap-2">
                            <span x-show="uploadMessage" x-text="uploadMessage"
                                :class="uploadError ? 'text-red-500' : 'text-green-500'"
                                class="text-xs font-semibold transition-opacity duration-500"></span>
                            <button @click="upload" :disabled="loading"
                                :class="loading ? 'bg-orange-400 cursor-not-allowed' : 'bg-orange-500 hover:bg-orange-600'"
                                class="text-sm flex items-center gap-1 text-white px-4 py-1.5 rounded-lg transition shadow-lg shadow-orange-200">
                                <span x-show="loading && uploadMessage === 'ä¸Šä¼ ä¸­...'"
                                    class="animate-spin h-3 w-3 border-2 border-white rounded-full border-t-transparent inline-block"></span>
                                <span x-show="!(loading && uploadMessage === 'ä¸Šä¼ ä¸­...')">â˜ï¸</span>
                                ç«‹å³ä¸Šä¼ 
                            </button>
                        </div>
                    </div>

                    <!-- Backup List -->
                    <div
                        class="bg-white/50 rounded-lg border border-gray-100 min-h-[100px] max-h-[300px] overflow-y-auto custom-scrollbar p-2">
                        <template x-if="loading">
                            <div class="flex items-center justify-center h-20 text-gray-400 text-sm">åŠ è½½ä¸­...</div>
                        </template>
                        <template x-if="!loading && backups.length === 0">
                            <div class="flex items-center justify-center h-20 text-gray-400 text-sm">æš‚æ— å¤‡ä»½</div>
                        </template>

                        <div class="space-y-2">
                            <template x-for="file in backups" :key="file.key">
                                <div
                                    class="flex items-center justify-between bg-white p-3 rounded border border-gray-100 hover:border-orange-200 transition">
                                    <div class="flex items-center gap-3">
                                        <div class="text-xl">ğŸ“¦</div>
                                        <div>
                                            <div class="text-sm font-medium text-gray-800"
                                                x-text="file.key.replace('animate_backup_', '').replace('.db', '')">
                                            </div>
                                            <div class="text-xs text-gray-400 mt-0.5">
                                                <span x-text="file.last_modified"></span> â€¢ <span
                                                    x-text="(file.size / 1024 / 1024).toFixed(2) + ' MB'"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button @click="confirmRestore(file.key)"
                                            class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100 transition border border-blue-200">
                                            é¢„è§ˆ / è¿˜åŸ
                                        </button>
                                        <button @click="confirmDelete(file.key)"
                                            class="text-xs bg-red-50 text-red-600 px-2 py-1.5 rounded hover:bg-red-100 transition border border-red-200"
                                            title="åˆ é™¤">
                                            ğŸ—‘ï¸
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Delete Confirm Modal (Simplified, only for Delete) -->
                    <div x-show="showConfirm" style="display: none;"
                        class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
                        x-transition.opacity>
                        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6 space-y-4"
                            @click.outside="showConfirm = false">
                            <h3 class="text-lg font-bold text-gray-800" x-text="confirmTitle"></h3>
                            <p class="text-sm text-gray-600" x-text="confirmMessage"></p>

                            <!-- Loading Spinner inside Modal -->
                            <div x-show="modalLoading" class="flex justify-center py-2">
                                <span
                                    class="animate-spin h-6 w-6 border-2 border-orange-500 rounded-full border-t-transparent"></span>
                            </div>

                            <div x-show="!modalLoading" class="flex justify-end gap-3 pt-2">
                                <button @click="showConfirm = false"
                                    class="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded transition">å–æ¶ˆ</button>
                                <button @click="executeConfirmAction"
                                    class="bg-red-500 hover:bg-red-600 px-4 py-2 text-sm text-white rounded transition shadow-md"
                                    x-text="confirmButtonText"></button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <div
                class="absolute -right-8 -bottom-8 text-9xl text-orange-100 opacity-50 group-hover:scale-105 transition duration-500 select-none">
                â˜ï¸
            </div>
        </div>

    </div>
</div>

<script>
    // Defined as a global function to ensure availability during HTMX swaps
    // Defined as a global function to ensure availability during HTMX swaps
    window.r2BackupData = function () {
        return {
            config: { endpoint: '', access_key: '', secret_key: '', bucket: '' },
            backups: [],
            loading: true,

            init() {
                this.loadConfig();
                this.loadBackups();
            },

            loadConfig() {
                fetch('/api/backup/r2/config')
                    .then(r => r.json())
                    .then(data => {
                        this.config = data;
                    });
            },

            testMessage: '',
            testError: false,
            testConnection() {
                this.loading = true;
                this.testMessage = 'æµ‹è¯•ä¸­...';
                this.testError = false;

                fetch('/api/backup/r2/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.config)
                })
                    .then(r => r.json())
                    .then(data => {
                        this.loading = false;
                        if (data.error) {
                            this.testError = true;
                            this.testMessage = 'è¿æ¥å¤±è´¥: ' + data.error;
                        } else {
                            this.testError = false;
                            this.testMessage = 'è¿æ¥æˆåŠŸ: ' + data.message;
                        }
                        setTimeout(() => this.testMessage = '', 5000);
                    })
                    .catch(e => {
                        this.loading = false;
                        this.testError = true;
                        this.testMessage = 'è¯·æ±‚é”™è¯¯: ' + e;
                        setTimeout(() => this.testMessage = '', 5000);
                    });
            },

            saveConfig() {
                this.testMessage = 'ä¿å­˜ä¸­...';
                fetch('/api/backup/r2/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.config)
                })
                    .then(r => r.json())
                    .then(() => {
                        this.testError = false;
                        this.testMessage = 'é…ç½®å·²ä¿å­˜';
                        this.loadBackups();
                        setTimeout(() => this.testMessage = '', 3000);
                    })
                    .catch(e => {
                        this.testError = true;
                        this.testMessage = 'ä¿å­˜å¤±è´¥: ' + e;
                        setTimeout(() => this.testMessage = '', 5000);
                    });
            },

            uploadMessage: '',
            uploadError: false,
            upload() {
                this.loading = true;
                this.uploadMessage = 'ä¸Šä¼ ä¸­...';
                this.uploadError = false;

                fetch('/api/backup/r2/upload', { method: 'POST' })
                    .then(r => r.json())
                    .then(data => {
                        if (data.error) {
                            this.uploadError = true;
                            this.uploadMessage = 'ä¸Šä¼ å¤±è´¥: ' + data.error;
                        } else {
                            this.uploadError = false;
                            this.uploadMessage = 'ä¸Šä¼ æˆåŠŸ';
                            this.loadBackups();
                        }
                        setTimeout(() => this.uploadMessage = '', 5000);
                    })
                    .catch(e => {
                        this.uploadError = true;
                        this.uploadMessage = 'ä¸Šä¼ é”™è¯¯: ' + e;
                        setTimeout(() => this.uploadMessage = '', 5000);
                    })
                    .finally(() => this.loading = false);
            },

            loadBackups() {
                this.loading = true;
                fetch('/api/backup/r2/list')
                    .then(r => r.json())
                    .then(data => {
                        if (data.error) console.error(data.error);
                        else this.backups = data.backups || [];
                    })
                    .catch(console.error)
                    .finally(() => this.loading = false);
            },

            showConfirm: false,
            confirmTitle: '',
            confirmMessage: '',
            confirmButtonText: '',
            confirmType: '',
            currentKey: '',
            modalLoading: false,

            confirmRestore(key) {
                this.loading = true;

                // Scroll to preview area
                const previewEl = document.getElementById('restore-preview');
                previewEl.scrollIntoView({ behavior: 'smooth' });

                // Initial State
                this.renderProgress(previewEl, key, 0, 'starting');

                const formData = new FormData();
                formData.append('key', key);

                fetch('/api/backup/r2/stage', {
                    method: 'POST',
                    body: formData
                })
                    .then(r => r.json())
                    .then(data => {
                        if (data.error) throw new Error(data.error);
                        if (!data.task_id) throw new Error("No Task ID returned");
                        this.startPolling(data.task_id, key, previewEl);
                    })
                    .catch(e => {
                        this.renderError(previewEl, e);
                        this.loading = false;
                    });
            },

            startPolling(taskId, key, previewEl) {
                const interval = setInterval(() => {
                    fetch('/api/backup/r2/progress/' + taskId)
                        .then(r => r.json())
                        .then(data => {
                            if (data.status === 'completed') {
                                clearInterval(interval);
                                previewEl.innerHTML = data.result_html;
                                if (window.htmx) htmx.process(previewEl);
                                this.loading = false;
                            } else if (data.status === 'error') {
                                clearInterval(interval);
                                throw new Error(data.error || 'Unknown error');
                            } else {
                                // Update Progress
                                let percent = 0;
                                if (data.total_bytes > 0) {
                                    percent = (data.downloaded / data.total_bytes) * 100;
                                }
                                this.renderProgress(previewEl, key, percent, data.status);
                            }
                        })
                        .catch(e => {
                            clearInterval(interval);
                            this.renderError(previewEl, "Progress check failed: " + e);
                            this.loading = false;
                        });
                }, 1000);
            },

            renderProgress(el, key, percent, status) {
                const statusText = status === 'analyzing' ? 'æ­£åœ¨åˆ†ææ•°æ®...' : (status === 'starting' ? 'æ­£åœ¨å¯åŠ¨ä»»åŠ¡...' : `å·²ä¸‹è½½ ${percent.toFixed(1)}%`);

                el.innerHTML = `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 text-center animate-fade-in-up">
                        <div class="mb-3">
                            <span class="inline-block animate-bounce text-3xl">â˜ï¸</span>
                        </div>
                        <h4 class="text-blue-800 font-bold text-lg mb-1">æ­£åœ¨ä»äº‘ç«¯ä¸‹è½½å¤‡ä»½...</h4>
                        <p class="text-blue-600 text-sm mb-4">æ–‡ä»¶å: ${key}</p>
                        
                        <div class="w-full max-w-xs mx-auto bg-blue-200 rounded-full h-4 overflow-hidden relative">
                            <div class="bg-blue-500 h-full rounded-full transition-all duration-500 ease-out" style="width: ${percent}%"></div>
                        </div>
                        <div class="mt-2 flex justify-between text-xs text-blue-500 max-w-xs mx-auto">
                            <span>${statusText}</span>
                            <span>${percent.toFixed(0)}%</span>
                        </div>
                    </div>
                `;
            },

            renderError(el, error) {
                el.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                        <div class="text-red-500 font-bold mb-1">ä¸‹è½½/åˆ†æå¤±è´¥</div>
                        <div class="text-sm text-red-600">${error}</div>
                    </div>
                `;
            },

            confirmDelete(key) {
                this.currentKey = key;
                this.confirmType = 'delete';
                this.confirmTitle = 'ç¡®è®¤åˆ é™¤';
                this.confirmMessage = 'ç¡®å®šè¦åˆ é™¤å¤‡ä»½ ' + key + ' å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼';
                this.confirmButtonText = 'ç¡®è®¤åˆ é™¤';
                this.showConfirm = true;
            },

            executeConfirmAction() {
                this.modalLoading = true;
                if (this.confirmType === 'delete') {
                    this.doDelete();
                }
            },

            doDelete() {
                const formData = new FormData();
                formData.append('key', this.currentKey);
                fetch('/api/backup/r2/delete', { method: 'POST', body: formData })
                    .then(r => r.json())
                    .then(data => {
                        if (data.error) {
                            this.confirmMessage = 'åˆ é™¤å¤±è´¥: ' + data.error;
                            this.confirmTitle = 'é”™è¯¯';
                        } else {
                            this.showConfirm = false;
                            this.loadBackups();
                        }
                    })
                    .catch(e => {
                        this.confirmMessage = 'åˆ é™¤é”™è¯¯: ' + e;
                        this.confirmTitle = 'é”™è¯¯';
                    })
                    .finally(() => this.modalLoading = false);
            }
        };
    }
</script>



{{ if not .SkipLayout }}{{ template "footer.html" . }}{{ end }}