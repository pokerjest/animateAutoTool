{{ define "subscription_card.html" }}
<div id="sub-card-{{.ID}}"
    class="bg-white/60 backdrop-blur-md rounded-2xl shadow-sm border border-white/70 hover:shadow-xl transition-all duration-300 hover:-translate-y-1 relative group overflow-hidden flex flex-col">

    <div class="p-5 flex gap-5">
        <!-- Image Section -->
        <div class="w-24 h-32 shrink-0 rounded-xl overflow-hidden shadow-lg bg-gray-100 relative group/poster cursor-pointer"
            @click.stop="$dispatch('show-anime-details', { 
                subId: {{ .ID }},
                bangumiId: {{ if .Metadata }}{{ .Metadata.BangumiID }}{{ else }}0{{ end }}, 
                title: '{{ .Title }}', 
                image: '{{ .Image }}',
                tmdbId: {{ if .Metadata }}{{ .Metadata.TMDBID }}{{ else }}0{{ end }},
                tmdbTitle: '{{ if .Metadata }}{{ .Metadata.TMDBTitle }}{{ end }}',
                tmdbImage: '{{ if .Metadata }}{{ .Metadata.TMDBImage }}{{ end }}',
                tmdbSummary: `{{ if .Metadata }}{{ .Metadata.TMDBSummary }}{{ end }}`,
                bangumiTitle: '{{ if .Metadata }}{{ .Metadata.BangumiTitle }}{{ end }}',
                bangumiImage: '{{ if .Metadata }}{{ .Metadata.BangumiImage }}{{ end }}',
                bangumiSummary: `{{ if .Metadata }}{{ .Metadata.BangumiSummary }}{{ end }}`,
                bangumiRating: {{ if .Metadata }}{{ .Metadata.BangumiRating }}{{ else }}0{{ end }},
                tmdbRating: {{ if .Metadata }}{{ .Metadata.TMDBRating }}{{ else }}0{{ end }},
                anilistId: {{ if .Metadata }}{{ .Metadata.AniListID }}{{ else }}0{{ end }},
                anilistTitle: `{{ if .Metadata }}{{ .Metadata.AniListTitle }}{{ end }}`,
                anilistImage: `{{ if .Metadata }}{{ .Metadata.AniListImage }}{{ end }}`,
                anilistSummary: `{{ if .Metadata }}{{ .Metadata.AniListSummary }}{{ end }}`,
                anilistRating: {{ if .Metadata }}{{ .Metadata.AniListRating }}{{ else }}0{{ end }},
                titleCN: `{{ if .Metadata }}{{ .Metadata.TitleCN }}{{ end }}`,
                titleEN: `{{ if .Metadata }}{{ .Metadata.TitleEN }}{{ end }}`,
                titleJP: `{{ if .Metadata }}{{ .Metadata.TitleJP }}{{ end }}`
            })">
            {{ if .Image }}
            <img src="{{ .Image }}"
                class="w-full h-full object-cover transition-transform duration-500 group-hover/poster:scale-110"
                loading="lazy" alt="{{.Title}}">
            {{ else }}
            <div class="w-full h-full flex items-center justify-center text-gray-300 text-3xl bg-gray-50">ğŸ“º</div>
            {{ end }}
            <!-- Detail Overlay -->
            <div
                class="absolute inset-0 bg-black/40 opacity-0 group-hover/poster:opacity-100 transition-opacity flex items-center justify-center">
                <span
                    class="text-white text-xs font-bold bg-black/40 px-2 py-1 rounded-lg backdrop-blur-sm border border-white/20">è¯¦æƒ…</span>
            </div>
        </div>

        <!-- Content Section -->
        <div class="flex-1 min-w-0 flex flex-col">
            <h3 class="font-black text-lg text-gray-800 line-clamp-2 leading-tight mb-2 hover:text-primary transition-colors cursor-pointer"
                title="ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…" @click.stop="$dispatch('show-anime-details', { 
                    subId: {{ .ID }},
                    bangumiId: {{ if .Metadata }}{{ .Metadata.BangumiID }}{{ else }}0{{ end }}, 
                    title: '{{ .Title }}', 
                    image: '{{ .Image }}',
                    tmdbId: {{ if .Metadata }}{{ .Metadata.TMDBID }}{{ else }}0{{ end }},
                    tmdbTitle: '{{ if .Metadata }}{{ .Metadata.TMDBTitle }}{{ end }}',
                    tmdbImage: '{{ if .Metadata }}{{ .Metadata.TMDBImage }}{{ end }}',
                    tmdbSummary: `{{ if .Metadata }}{{ .Metadata.TMDBSummary }}{{ end }}`,
                    bangumiTitle: '{{ if .Metadata }}{{ .Metadata.BangumiTitle }}{{ end }}',
                    bangumiImage: '{{ if .Metadata }}{{ .Metadata.BangumiImage }}{{ end }}',
                    bangumiSummary: `{{ if .Metadata }}{{ .Metadata.BangumiSummary }}{{ end }}`,
                    bangumiRating: {{ if .Metadata }}{{ .Metadata.BangumiRating }}{{ else }}0{{ end }},
                    tmdbRating: {{ if .Metadata }}{{ .Metadata.TMDBRating }}{{ else }}0{{ end }},
                    anilistId: {{ if .Metadata }}{{ .Metadata.AniListID }}{{ else }}0{{ end }},
                    anilistTitle: `{{ if .Metadata }}{{ .Metadata.AniListTitle }}{{ end }}`,
                    anilistImage: `{{ if .Metadata }}{{ .Metadata.AniListImage }}{{ end }}`,
                    anilistSummary: `{{ if .Metadata }}{{ .Metadata.AniListSummary }}{{ end }}`,
                    anilistRating: {{ if .Metadata }}{{ .Metadata.AniListRating }}{{ else }}0{{ end }},
                    titleCN: `{{ if .Metadata }}{{ .Metadata.TitleCN }}{{ end }}`,
                    titleEN: `{{ if .Metadata }}{{ .Metadata.TitleEN }}{{ end }}`,
                    titleJP: `{{ if .Metadata }}{{ .Metadata.TitleJP }}{{ end }}`
                })">
                {{ .Title }}
            </h3>

            <!-- Quick Metadata Tags -->
            <div class="flex flex-wrap gap-1.5 mb-3">
                {{ if .SubtitleGroup }}
                <span
                    class="inline-flex items-center px-2 py-0.5 rounded-lg text-[10px] bg-indigo-50/80 text-indigo-600 border border-indigo-100 font-bold max-w-[120px] truncate"
                    title="{{ .SubtitleGroup }}">
                    {{ .SubtitleGroup }}
                </span>
                {{ end }}
                {{ if .Season }}
                <span
                    class="inline-flex items-center px-2 py-0.5 rounded-lg text-[10px] bg-rose-50/80 text-rose-600 border border-rose-100 font-bold">
                    {{ .Season }}
                </span>
                {{ end }}
            </div>

            <!-- Stats -->
            <div class="mt-auto flex items-center gap-3">
                <div class="flex items-center gap-1.5 text-xs text-gray-500 bg-gray-50/50 px-2.5 py-1 rounded-lg border border-gray-100"
                    title="RSS: {{.RSSUrl}}">
                    <span class="opacity-70">ğŸ¬</span>
                    <span class="font-medium">å·²ä¸‹è½½: <b class="text-gray-900 font-black">{{ .DownloadedCount }}</b>
                        é›†</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Tech Details (Compact) -->
    <div class="px-5 pb-3">
        <div class="space-y-1.5 p-2.5 bg-gray-50/50 rounded-xl border border-gray-100/50">
            {{ if .FilterRule }}
            <div class="flex items-center gap-2 text-[10px] text-gray-500" title="åŒ…å«è§„åˆ™: {{ .FilterRule }}">
                <span class="w-4 h-4 flex items-center justify-center bg-white rounded shadow-sm text-[8px]">ğŸ”</span>
                <span class="font-mono truncate flex-1">{{ .FilterRule }}</span>
            </div>
            {{ end }}
            {{ if .ExcludeRule }}
            <div class="flex items-center gap-2 text-[10px] text-gray-500" title="æ’é™¤è§„åˆ™: {{ .ExcludeRule }}">
                <span class="w-4 h-4 flex items-center justify-center bg-white rounded shadow-sm text-[8px]">ğŸš«</span>
                <span class="font-mono truncate flex-1">{{ .ExcludeRule }}</span>
            </div>
            {{ end }}
            {{ if and (not .FilterRule) (not .ExcludeRule) }}
            <div class="text-[10px] text-gray-400 italic text-center py-1">æ— è¿‡æ»¤è§„åˆ™</div>
            {{ end }}
        </div>
    </div>

    <!-- Footer Actions -->
    <div
        class="mt-auto bg-gray-50/80 backdrop-blur-sm px-4 py-3 border-t border-gray-100 flex items-center justify-between">
        <!-- Status -->
        <div class="flex items-center">
            {{ if .IsActive }}
            <button id="toggle-{{.ID}}" hx-post="/api/subscriptions/{{ .ID }}/toggle" hx-swap="outerHTML"
                hx-indicator="#toggle-{{.ID}}"
                class="px-3 py-1 rounded-full text-[10px] font-black tracking-tight text-emerald-600 bg-emerald-50 border border-emerald-100 hover:bg-emerald-100 transition shadow-sm flex items-center gap-1.5 cursor-pointer">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                <span>è¿è¡Œä¸­</span>
                <span class="htmx-indicator hidden animate-spin">âŒ›</span>
            </button>
            {{ else }}
            <button id="toggle-{{.ID}}" hx-post="/api/subscriptions/{{ .ID }}/toggle" hx-swap="outerHTML"
                hx-indicator="#toggle-{{.ID}}"
                class="px-3 py-1 rounded-full text-[10px] font-black tracking-tight text-gray-500 bg-gray-100 border border-gray-200 hover:bg-gray-200 transition shadow-sm flex items-center gap-1.5 cursor-pointer">
                <span class="w-1.5 h-1.5 rounded-full bg-gray-400"></span>
                <span>å·²æš‚åœ</span>
                <span class="htmx-indicator hidden animate-spin">âŒ›</span>
            </button>
            {{ end }}
        </div>

        <!-- Actions -->
        <div class="flex items-center gap-0.5">
            <button hx-post="/api/subscriptions/{{ .ID }}/run" hx-swap="none"
                class="p-2 text-gray-400 hover:text-blue-600 hover:bg-white rounded-xl transition-all hover:shadow-sm"
                title="ç«‹å³è¿è¡Œ">
                <span class="text-sm">â–¶ï¸</span>
            </button>

            <button data-id="{{.ID}}" data-title="{{.Title}}" data-rss="{{.RSSUrl}}" data-filter="{{.FilterRule}}"
                data-exclude="{{.ExcludeRule}}" @click.stop="$dispatch('edit-subscription', { 
                    id: $el.dataset.id, 
                    title: $el.dataset.title, 
                    rss: $el.dataset.rss, 
                    filter: $el.dataset.filter, 
                    exclude: $el.dataset.exclude 
                })"
                class="p-2 text-gray-400 hover:text-amber-600 hover:bg-white rounded-xl transition-all hover:shadow-sm"
                title="ç¼–è¾‘">
                <span class="text-sm">âœï¸</span>
            </button>

            <button hx-post="/api/subscriptions/{{ .ID }}/refresh-metadata" hx-swap="outerHTML"
                hx-target="#sub-card-{{.ID}}"
                class="p-2 text-gray-400 hover:text-purple-600 hover:bg-white rounded-xl transition-all hover:shadow-sm"
                title="åˆ·æ–°å…ƒæ•°æ®">
                <span class="text-sm">ğŸ”„</span>
            </button>

            <div class="w-px h-4 bg-gray-200 mx-1"></div>

            <button data-id="{{.ID}}" @click.stop="$dispatch('delete-subscription', { id: $el.dataset.id })"
                class="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-xl transition-all" title="åˆ é™¤">
                <span class="text-sm">ğŸ—‘ï¸</span>
            </button>
        </div>
    </div>
</div>
{{ end }}