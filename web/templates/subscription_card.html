{{ define "subscription_card.html" }}
<div id="sub-card-{{.ID}}"
    class="bg-white rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-all duration-300 relative group overflow-hidden flex flex-col">

    <div class="p-4 flex gap-4">
        <!-- Image Section -->
        {{ if .Image }}
        <div class="w-20 h-28 shrink-0 rounded-lg overflow-hidden shadow-inner bg-gray-100 relative">
            <img src="{{ .Image }}"
                class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                loading="lazy" alt="{{.Title}}">
        </div>
        {{ else }}
        <div
            class="w-20 h-28 shrink-0 rounded-lg overflow-hidden shadow-inner bg-gray-50 flex items-center justify-center text-gray-300 relative">
            <span class="text-2xl">ğŸ“º</span>
        </div>
        {{ end }}

        <!-- Content Section -->
        <div class="flex-1 min-w-0 flex flex-col">
            <div class="flex justify-between items-start gap-2">
                <h3 class="font-bold text-base text-gray-800 line-clamp-2 leading-snug mb-2 hover:text-primary transition-colors cursor-pointer hover:underline"
                    title="ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…" @click.stop="$dispatch('show-anime-details', { 
                        subId: {{ .ID }},
                        bangumiId: {{ if .Metadata }}{{ .Metadata.BangumiID }}{{ else }}0{{ end }}, 
                        title: '{{ .Title }}', 
                        image: '{{ .Image }}',
                        tmdbId: {{ if .Metadata }}{{ .Metadata.TMDBID }}{{ else }}0{{ end }},
                        tmdbTitle: '{{ if .Metadata }}{{ .Metadata.TMDBTitle }}{{ end }}',
                        tmdbImage: '{{ if .Metadata }}{{ .Metadata.TMDBImage }}{{ end }}',
                        tmdbSummary: `{{ if .Metadata }}{{ .Metadata.TMDBSummary }}{{ end }}`,
                        bangumiTitle: '{{ if .Metadata }}{{ .Metadata.BangumiTitle }}{{ end }}',
                        bangumiImage: '{{ if .Metadata }}{{ .Metadata.BangumiImage }}{{ end }}',
                        bangumiSummary: `{{ if .Metadata }}{{ .Metadata.BangumiSummary }}{{ end }}`,
                        bangumiRating: {{ if .Metadata }}{{ .Metadata.BangumiRating }}{{ else }}0{{ end }},
                        
                        tmdbTitle: '{{ if .Metadata }}{{ .Metadata.TMDBTitle }}{{ end }}',
                        tmdbImage: '{{ if .Metadata }}{{ .Metadata.TMDBImage }}{{ end }}',
                        tmdbSummary: `{{ if .Metadata }}{{ .Metadata.TMDBSummary }}{{ end }}`,
                        tmdbRating: {{ if .Metadata }}{{ .Metadata.TMDBRating }}{{ else }}0{{ end }},
                        
                        anilistId: {{ if .Metadata }}{{ .Metadata.AniListID }}{{ else }}0{{ end }},
                        anilistTitle: `{{ if .Metadata }}{{ .Metadata.AniListTitle }}{{ end }}`,
                        anilistImage: `{{ if .Metadata }}{{ .Metadata.AniListImage }}{{ end }}`,
                        anilistSummary: `{{ if .Metadata }}{{ .Metadata.AniListSummary }}{{ end }}`,
                        anilistRating: {{ if .Metadata }}{{ .Metadata.AniListRating }}{{ else }}0{{ end }},

                        titleCN: `{{ if .Metadata }}{{ .Metadata.TitleCN }}{{ end }}`,
                        titleEN: `{{ if .Metadata }}{{ .Metadata.TitleEN }}{{ end }}`,
                        titleJP: `{{ if .Metadata }}{{ .Metadata.TitleJP }}{{ end }}`
                    })">
                    {{ .Title }}
                </h3>
            </div>

            <!-- Quick Metadata Tags -->
            <div class="flex flex-wrap gap-1.5 mb-2">
                {{ if .SubtitleGroup }}
                <span
                    class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] bg-indigo-50 text-indigo-600 border border-indigo-100 font-medium truncate max-w-[100px]"
                    title="{{ .SubtitleGroup }}">
                    {{ .SubtitleGroup }}
                </span>
                {{ end }}
                {{ if .Season }}
                <span
                    class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] bg-rose-50 text-rose-600 border border-rose-100 font-medium whitespace-nowrap">
                    {{ .Season }}
                </span>
                {{ end }}
                {{ if and .Metadata (gt .Metadata.BangumiID 0) }}
                <a href="https://bgm.tv/subject/{{ .Metadata.BangumiID }}" target="_blank"
                    class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] bg-pink-50 text-pink-600 border border-pink-100 font-medium whitespace-nowrap hover:bg-pink-100 transition-colors"
                    title="Bangumi ID: {{ .Metadata.BangumiID }}" @click.stop>
                    BGM: {{ .Metadata.BangumiID }}
                </a>
                {{ end }}
            </div>

            <!-- Tech Details (Compact) -->
            <div class="space-y-0.5 mb-2 hidden group-hover:block animate-fade-in">
                {{ if .FilterRule }}
                <div class="flex items-center gap-1 text-[10px] text-gray-500" title="åŒ…å«è§„åˆ™: {{ .FilterRule }}">
                    <span class="text-gray-400">ğŸ”</span> <span
                        class="bg-gray-50 px-1 rounded truncate max-w-[150px]">{{ .FilterRule }}</span>
                </div>
                {{ end }}
                {{ if .ExcludeRule }}
                <div class="flex items-center gap-1 text-[10px] text-gray-500" title="æ’é™¤è§„åˆ™: {{ .ExcludeRule }}">
                    <span class="text-gray-400">ğŸš«</span> <span
                        class="bg-gray-50 px-1 rounded truncate max-w-[150px]">{{ .ExcludeRule }}</span>
                </div>
                {{ end }}
            </div>

            <!-- Progress / Stats -->
            <div class="mt-auto flex items-center justify-between">
                <div class="flex items-center gap-2 text-xs text-gray-500 bg-gray-50 px-2 py-1 rounded-md"
                    title="RSS: {{.RSSUrl}}">
                    <span>ğŸ¬</span>
                    <span>å·²ä¸‹è½½: <b class="text-gray-900">{{ .DownloadedCount }}</b> é›†</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer Actions -->
    <div class="bg-gray-50/50 px-3 py-2 border-t border-gray-100 flex items-center justify-between mx-1">
        <!-- Status / ID -->
        <div class="flex items-center gap-2">
            {{ if .IsActive }}
            <button id="toggle-{{.ID}}" hx-post="/api/subscriptions/{{ .ID }}/toggle" hx-swap="outerHTML"
                hx-indicator="#toggle-{{.ID}}"
                class="px-2 py-0.5 rounded-full text-[10px] font-bold text-green-600 bg-green-100 border border-green-200 hover:bg-green-200 transition flex items-center gap-1 cursor-pointer">
                <span>ğŸŸ¢ è¿è¡Œä¸­</span>
                <span class="htmx-indicator hidden animate-spin">âŒ›</span>
            </button>
            {{ else }}
            <button id="toggle-{{.ID}}" hx-post="/api/subscriptions/{{ .ID }}/toggle" hx-swap="outerHTML"
                hx-indicator="#toggle-{{.ID}}"
                class="px-2 py-0.5 rounded-full text-[10px] font-bold text-gray-500 bg-gray-200 border border-gray-300 hover:bg-gray-300 transition flex items-center gap-1 cursor-pointer">
                <span>â¸ï¸ å·²æš‚åœ</span>
                <span class="htmx-indicator hidden animate-spin">âŒ›</span>
            </button>
            {{ end }}
        </div>

        <!-- Right: Actions -->
        <div class="flex items-center gap-1">
            <!-- Run -->
            <button hx-post="/api/subscriptions/{{ .ID }}/run" hx-swap="none"
                class="p-1.5 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded-md transition-colors"
                title="ç«‹å³è¿è¡Œ">
                <span class="text-sm">â–¶ï¸</span>
            </button>

            <!-- Edit -->
            <button data-id="{{.ID}}" data-title="{{.Title}}" data-rss="{{.RSSUrl}}" data-filter="{{.FilterRule}}"
                data-exclude="{{.ExcludeRule}}" @click.stop="$dispatch('edit-subscription', { 
                    id: $el.dataset.id, 
                    title: $el.dataset.title, 
                    rss: $el.dataset.rss, 
                    filter: $el.dataset.filter, 
                    exclude: $el.dataset.exclude 
                })"
                class="p-1.5 text-gray-400 hover:text-amber-500 hover:bg-amber-50 rounded-md transition-colors mr-1"
                title="ç¼–è¾‘">
                <span class="text-sm">âœï¸</span>
            </button>
            <button hx-post="/api/subscriptions/{{ .ID }}/refresh-metadata" hx-swap="outerHTML"
                hx-target="#sub-card-{{.ID}}"
                class="p-1.5 text-gray-400 hover:text-purple-500 hover:bg-purple-50 rounded-md transition-colors mr-1"
                title="åˆ·æ–°å…ƒæ•°æ®">
                <span class="text-sm">ğŸ”„</span>
            </button>

            <span class="text-gray-200">|</span>

            <!-- Delete -->
            <button data-id="{{.ID}}" @click.stop="$dispatch('delete-subscription', { id: $el.dataset.id })"
                class="p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-md transition-colors ml-1"
                title="åˆ é™¤">
                <span class="text-sm">ğŸ—‘ï¸</span>
            </button>
        </div>
    </div>
</div>
{{ end }}