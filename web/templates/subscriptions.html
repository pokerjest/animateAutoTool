{{ if not .SkipLayout }}{{ template "header.html" . }}{{ end }}

<div class="space-y-6" x-data="{ showModal: false }">
    <div class="flex justify-between items-center">
        <h2 class="text-2xl font-bold text-gray-700">è®¢é˜…ç®¡ç†</h2>
        <button @click="showModal = true"
            class="bg-accent text-white px-4 py-2 rounded-lg hover:bg-pink-600 transition shadow-md flex items-center gap-2">
            <span>â•</span> æ–°å¢è®¢é˜…
        </button>
    </div>

    <!-- Subscription List -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="subscription-list">
        {{ range .Subscriptions }}
        <div
            class="bg-white/60 p-5 rounded-xl border border-white/70 shadow-sm hover:shadow-md transition relative group">
            <div class="flex justify-between items-start mb-2">
                <h3 class="font-bold text-lg text-gray-800 line-clamp-1" title="{{ .Title }}">{{ .Title }}</h3>
                <div class="flex gap-2">
                    <!-- Toggle Button -->
                    {{ if .IsActive }}
                    <button id="toggle-{{.ID}}" hx-post="/api/subscriptions/{{ .ID }}/toggle" hx-swap="outerHTML"
                        hx-indicator="#toggle-{{.ID}}"
                        class="px-3 py-1 rounded text-white text-xs bg-green-500 hover:bg-green-600 transition-colors flex items-center gap-1 disabled:opacity-50">
                        <span class="htmx-indicator hidden animate-spin">âŒ›</span>
                        <span class="htmx-request:hidden">Running</span>
                    </button>
                    {{ else }}
                    <button id="toggle-{{.ID}}" hx-post="/api/subscriptions/{{ .ID }}/toggle" hx-swap="outerHTML"
                        hx-indicator="#toggle-{{.ID}}"
                        class="px-3 py-1 rounded text-white text-xs bg-gray-400 hover:bg-gray-500 transition-colors flex items-center gap-1 disabled:opacity-50">
                        <span class="htmx-indicator hidden animate-spin">âŒ›</span>
                        <span class="htmx-request:hidden">Paused</span>
                    </button>
                    {{ end }}
                </div>
            </div>

            <div class="text-xs text-gray-500 space-y-1 mb-4">
                <p>RSS: <span class="text-blue-500 break-all select-all">{{ .RSSUrl }}</span></p>
                <p>Filter: <span class="bg-gray-200 px-1 rounded">{{ .FilterRule }}</span></p>
                <p>Last Ep: {{ .LastEp }}</p>
            </div>

            <!-- Delete Button (Hidden by default, shown on hover) -->
            <button id="del-{{.ID}}" hx-delete="/api/subscriptions/{{ .ID }}" hx-confirm="ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ"
                hx-target="closest div.group" hx-swap="outerHTML" hx-indicator="#del-{{.ID}}"
                class="absolute bottom-2 right-2 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1 disabled:opacity-50">
                <span class="htmx-indicator hidden animate-spin">âŒ›</span>
                <span class="htmx-request:hidden">ğŸ—‘ï¸</span>
            </button>
        </div>
        {{ else }}
        <div class="col-span-full text-center py-12 text-gray-400">
            æš‚æ— è®¢é˜…ï¼Œç‚¹å‡»å³ä¸Šè§’æ·»åŠ 
        </div>
        {{ end }}
    </div>

    <!-- Add Subscription Modal -->
    <div x-show="showModal" style="display: none;"
        class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm"
        x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">

        <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-6 relative" @click.away="showModal = false">
            <h3 class="text-xl font-bold mb-4 text-gray-800">æ–°å¢ RSS è®¢é˜…</h3>

            <form hx-post="/api/subscriptions" hx-swap="none"
                @htmx:after-request="if(event.detail.successful) { showModal = false; window.location.reload() }">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ç•ªå‰§æ ‡é¢˜</label>
                        <input type="text" name="Title" required
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
                            placeholder="ä¾‹å¦‚ï¼šFrieren">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">RSS é“¾æ¥</label>
                        <input type="url" name="RSSUrl" required
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
                            placeholder="Mikan RSS URL">
                        <p class="text-xs text-gray-400 mt-1">ä»èœœæŸ‘è®¡åˆ’å¤åˆ¶ RSS é“¾æ¥ç²˜è´´è‡³æ­¤</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">è¿‡æ»¤è§„åˆ™</label>
                            <input type="text" name="FilterRule" value="1080p,ç®€ä½“"
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ’é™¤è§„åˆ™</label>
                            <input type="text" name="ExcludeRule"
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
                        </div>
                    </div>
                </div>

                <div class="flex justify-end gap-3">
                    <button type="button" @click="showModal = false"
                        class="px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100">å–æ¶ˆ</button>
                    <button type="submit" id="add-sub-btn" hx-indicator="#add-sub-btn"
                        class="px-6 py-2 rounded-lg bg-primary text-white hover:bg-accent shadow-lg shadow-pink-200 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                        <span class="htmx-indicator hidden animate-spin">âŒ›</span>
                        <span class="htmx-indicator hidden">æ·»åŠ ä¸­...</span>
                        <span class="htmx-request:hidden">ç¡®å®šæ·»åŠ </span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{{ if not .SkipLayout }}{{ template "footer.html" . }}{{ end }}