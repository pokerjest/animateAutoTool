{{ if not .SkipLayout }}{{ template "header.html" . }}{{ end }}

<!-- Wrap in Alpine data for modal and toast -->
<div x-data="{
    showModal: false,
    editingAnime: null,
    rating: 0,
    comment: '',
    tags: '',
    updating: false,
    toast: { show: false, message: '', type: 'success' },
    
    showToast(msg, type = 'success') {
        this.toast.message = msg;
        this.toast.type = type;
        this.toast.show = true;
        setTimeout(() => { this.toast.show = false }, 3000);
    },

    openModal(anime) {
        this.editingAnime = anime;
        this.rating = anime.rate || 0;
        this.comment = anime.comment || '';
        this.tags = (anime.tags || []).join(' ');
        this.showModal = true;
    },
    
    saveChanges() {
        if (!this.editingAnime) return;
        this.updating = true;
        
        const payload = {
            status: this.editingAnime.type, // Keep current status
            rating: parseInt(this.rating),
            comment: this.comment,
            tags: this.tags.split(' ').filter(t => t.trim() !== '')
        };
        
        fetch('/api/bangumi/subject/' + this.editingAnime.subject_id + '/collection', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        .then(r => r.json())
        .then(d => {
            if(d.error) {
                this.showToast('‚ùå ' + d.error, 'error');
            } else {
                // Optimistic UI Update (Partial)
                this.editingAnime.rate = payload.rating;
                this.editingAnime.comment = payload.comment;
                this.editingAnime.tags = payload.tags;
                this.showModal = false;
                this.showToast('‚úÖ ' + d.message, 'success');
                // Reload page to reflect changes fully (lazy way)
                 setTimeout(() => window.location.reload(), 1000);
            }
        })
        .catch(err => {
             this.showToast('‚ùå ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•', 'error');
        })
        .finally(() => this.updating = false);
    }
}" class="space-y-8 relative">

    <!-- Toast Notification -->
    <div x-show="toast.show" x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 transform translate-y-2"
        x-transition:enter-end="opacity-100 transform translate-y-0"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 transform translate-y-0"
        x-transition:leave-end="opacity-0 transform translate-y-2"
        class="fixed top-24 right-8 z-[60] px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3 min-w-[300px]"
        :class="toast.type === 'error' ? 'bg-red-50 text-red-600 border border-red-100' : 'bg-white text-gray-800 border border-gray-100'">

        <div class="text-2xl" x-text="toast.type === 'error' ? '‚ö†Ô∏è' : 'üéâ'"></div>
        <div>
            <div class="font-bold text-sm" x-text="toast.type === 'error' ? 'Êìç‰ΩúÂ§±Ë¥•' : 'Êìç‰ΩúÊàêÂäü'"></div>
            <div class="text-xs opacity-80 mt-0.5" x-text="toast.message"></div>
        </div>
    </div>

    <!-- Top Bar -->
    <div class="flex justify-between items-center">
        <h2 class="text-2xl font-bold text-gray-700">‰ª™Ë°®Áõò</h2>
        <button id="sync-btn"
            class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-accent transition transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
            hx-post="/api/sync" hx-swap="none" hx-indicator="#sync-btn">
            <span class="htmx-indicator hidden animate-spin">üîÑ</span>
            <span class="htmx-indicator hidden">ÂêåÊ≠•‰∏≠...</span>
            <span class="htmx-request:hidden">üîÑ Á´ãÂç≥ÂêåÊ≠•</span>
        </button>
    </div>

    <!-- Status Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Status Card 1 -->
        <div
            class="bg-white/60 backdrop-blur-md p-6 rounded-2xl border border-white/70 shadow-sm hover:shadow-md transition-all">
            <div class="text-gray-500 text-xs font-bold uppercase tracking-wider">Ê¥ªË∑ÉËÆ¢ÈòÖ</div>
            <div class="text-4xl font-black text-gray-800 mt-2 flex items-baseline gap-2">
                {{ .ActiveSubs }}
                <span class="text-sm font-medium text-gray-400">‰∏™ËÆ¢ÈòÖ</span>
            </div>
        </div>
        <!-- Status Card 2 -->
        <div
            class="bg-white/60 backdrop-blur-md p-6 rounded-2xl border border-white/70 shadow-sm hover:shadow-md transition-all">
            <div class="text-gray-500 text-xs font-bold uppercase tracking-wider">‰ªäÊó•‰∏ãËΩΩ</div>
            <div class="text-4xl font-black text-gray-800 mt-2 flex items-baseline gap-2">
                {{ .TodayDownloads }}
                <span class="text-sm font-medium text-gray-400">‰∏™Êñá‰ª∂</span>
            </div>
        </div>
        <!-- Status Card 3 -->
        <div
            class="bg-white/60 backdrop-blur-md p-6 rounded-2xl border border-white/70 shadow-sm hover:shadow-md transition-all">
            <div class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-3">Á≥ªÁªüÁä∂ÊÄÅ</div>
            <div class="space-y-3">
                <!-- Service Status -->
                <div class="flex items-center justify-between text-sm py-1 border-b border-gray-100/50 last:border-0">
                    <span class="text-gray-600 font-medium">ÊúçÂä°ËøêË°å</span>
                    <span
                        class="text-emerald-500 font-bold flex items-center gap-1.5 bg-emerald-50 px-2 py-0.5 rounded-full text-xs">
                        <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span> Ê≠£Â∏∏
                    </span>
                </div>
                <!-- QB Status -->
                <div class="flex items-center justify-between text-sm py-1 border-b border-gray-100/50 last:border-0">
                    <span class="text-gray-600 font-medium">qBittorrent</span>
                    {{ if .QBConnected }}
                    <span
                        class="text-emerald-600 font-bold flex items-center gap-1.5 bg-emerald-50 px-2 py-0.5 rounded-full text-xs"
                        title="{{.QBVersion}}">
                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span> Â∑≤ËøûÊé•
                    </span>
                    {{ else }}
                    <span
                        class="text-red-500 font-bold flex items-center gap-1.5 bg-red-50 px-2 py-0.5 rounded-full text-xs">
                        <span class="w-1.5 h-1.5 rounded-full bg-red-500"></span> Êú™ËøûÊé•
                    </span>
                    {{ end }}
                </div>
                <!-- Bangumi Status -->
                <div class="flex items-center justify-between text-sm py-1 border-b border-gray-100/50 last:border-0">
                    <span class="text-gray-600 font-medium">Bangumi</span>
                    {{ if .BangumiLogin }}
                    <span
                        class="text-pink-600 font-bold flex items-center gap-1.5 bg-pink-50 px-2 py-0.5 rounded-full text-xs">
                        <span class="w-1.5 h-1.5 rounded-full bg-pink-500"></span> Â∑≤ÁôªÂΩï
                    </span>
                    {{ else }}
                    <span
                        class="text-gray-400 font-bold flex items-center gap-1.5 bg-gray-50 px-2 py-0.5 rounded-full text-xs">
                        <span class="w-1.5 h-1.5 rounded-full bg-gray-300"></span> Êú™ÁôªÂΩï
                    </span>
                    {{ end }}
                </div>
                <!-- TMDB Status -->
                <div class="flex items-center justify-between text-sm py-1 border-b border-gray-100/50 last:border-0">
                    <span class="text-gray-600 font-medium">TMDB</span>
                    <div id="tmdb-status" hx-get="/api/settings/tmdb-status?style=dashboard" hx-trigger="load"
                        hx-swap="outerHTML">
                        <span
                            class="text-gray-400 font-bold flex items-center gap-1.5 bg-gray-50 px-2 py-0.5 rounded-full text-xs">
                            <span class="w-1.5 h-1.5 rounded-full bg-gray-300 animate-pulse"></span> Ê£ÄÊü•‰∏≠
                        </span>
                    </div>
                </div>
                <!-- AniList Status -->
                <div class="flex items-center justify-between text-sm py-1 border-b border-gray-100/50 last:border-0">
                    <span class="text-gray-600 font-medium">AniList</span>
                    <div id="anilist-status" hx-get="/api/settings/anilist-status?style=dashboard" hx-trigger="load"
                        hx-swap="outerHTML">
                        <span
                            class="text-gray-400 font-bold flex items-center gap-1.5 bg-gray-50 px-2 py-0.5 rounded-full text-xs">
                            <span class="w-1.5 h-1.5 rounded-full bg-gray-300 animate-pulse"></span> Ê£ÄÊü•‰∏≠
                        </span>
                    </div>
                </div>
                <!-- Jellyfin Status -->
                <div class="flex items-center justify-between text-sm py-1 border-b border-gray-100/50 last:border-0">
                    <span class="text-gray-600 font-medium">Jellyfin</span>
                    <div id="jellyfin-status" hx-get="/api/settings/jellyfin-status?style=dashboard" hx-trigger="load"
                        hx-swap="outerHTML">
                        <span
                            class="text-gray-400 font-bold flex items-center gap-1.5 bg-gray-50 px-2 py-0.5 rounded-full text-xs">
                            <span class="w-1.5 h-1.5 rounded-full bg-gray-300 animate-pulse"></span> Ê£ÄÊü•‰∏≠
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bangumi Sections Template -->
    {{ define "anime_grid" }}
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6">
        {{ range . }}
        <div @click="openModal({{ . | json }})"
            class="group bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-xl transition-all duration-300 hover:-translate-y-1 cursor-pointer relative">
            <div class="aspect-[2/3] relative overflow-hidden bg-gray-100">
                <!-- Badge -->
                <div class="absolute top-2 right-2 z-20">
                    {{ if eq .Type 3 }}<span
                        class="bg-pink-500 text-white text-[10px] font-black px-2 py-1 rounded-lg shadow-lg backdrop-blur-md">Âú®Áúã</span>{{
                    end }}
                    {{ if eq .Type 2 }}<span
                        class="bg-emerald-500 text-white text-[10px] font-black px-2 py-1 rounded-lg shadow-lg backdrop-blur-md">Â∑≤Áúã</span>{{
                    end }}
                </div>
                <!-- Cover -->
                {{ if .Subject.Images.Common }}
                <img src="{{ .Subject.Images.Common }}" loading="lazy"
                    class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                {{ else }}
                <div class="w-full h-full flex items-center justify-center text-gray-300 text-2xl bg-gray-50">?</div>
                {{ end }}
                <!-- Info Overlay -->
                <div
                    class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-4">
                    <div class="text-white text-sm font-bold line-clamp-2 leading-tight">{{ if .Subject.NameCN }}{{
                        .Subject.NameCN }}{{
                        else }}{{ .Subject.Name }}{{ end }}</div>
                    <div class="text-white/80 text-[10px] mt-2 flex items-center gap-2">
                        {{ if eq .Type 2 }}
                        <span
                            class="flex items-center gap-0.5 {{ if gt .Rate 0 }}text-yellow-400{{ else }}text-gray-400{{ end }}">‚òÖ
                            {{ if gt
                            .Rate 0 }}{{ .Rate }}{{ else }}-{{ end }}</span>
                        {{ else }}
                        <span class="bg-white/20 px-1.5 py-0.5 rounded">
                            {{ .EpStatus }} / {{ if .Subject.Eps }}{{ .Subject.Eps }}{{ else }}?{{ end }} ÈõÜ
                        </span>
                        {{ end }}
                    </div>
                </div>
                <!-- Standard Label (Always shown) -->
                <div
                    class="absolute bottom-0 inset-x-0 bg-gradient-to-t from-black/60 to-transparent p-3 pt-6 group-hover:hidden transition-all duration-300">
                    <div class="text-white text-[11px] font-bold truncate">{{ if .Subject.NameCN }}{{ .Subject.NameCN
                        }}{{
                        else }}{{ .Subject.Name }}{{ end }}</div>
                </div>
            </div>
        </div>
        {{ end }}
    </div>
    {{ end }}

    <!-- 1. Watching List -->
    {{ if .WatchingList }}
    <div class="space-y-4">
        <h3 class="text-xl font-black text-gray-800 flex items-center gap-3">
            <span class="w-1.5 h-6 bg-pink-500 rounded-full"></span>
            Âú®Áúã
            <span class="text-xs font-bold text-gray-400 bg-gray-100 px-3 py-1 rounded-full">{{ len .WatchingList
                }}</span>
        </h3>
        {{ template "anime_grid" .WatchingList }}
    </div>
    {{ end }}

    <!-- 2. Completed List -->
    {{ if .CompletedList }}
    <div class="space-y-4">
        <h3 class="text-xl font-black text-gray-800 flex items-center gap-3">
            <span class="w-1.5 h-6 bg-emerald-500 rounded-full"></span>
            Â∑≤Áúã
            <span class="text-xs font-bold text-gray-400 bg-gray-100 px-3 py-1 rounded-full">{{ len .CompletedList
                }}</span>
        </h3>
        {{ template "anime_grid" .CompletedList }}
    </div>
    {{ end }}

    {{ if and (not .WatchingList) (not .CompletedList) .BangumiLogin }}
    <div class="text-center py-20 bg-white/40 rounded-3xl border-2 border-dashed border-gray-200">
        <div class="text-4xl mb-3 opacity-30">üì¶</div>
        <p class="text-gray-400 font-medium">ÊöÇÊó†Áõ∏ÂÖ≥Âä®ÁîªÊï∞ÊçÆ</p>
    </div>
    {{ end }}

    <!-- Edit Modal -->
    <div x-show="showModal" style="display: none;" class="fixed inset-0 z-50 overflow-y-auto"
        aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen px-4 pb-20 text-center sm:block sm:p-0">
            <!-- Background overlay -->
            <div x-show="showModal" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0"
                x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200"
                x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
                class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity" @click="showModal = false"
                aria-hidden="true"></div>

            <!-- This element is to trick the browser into centering the modal contents. -->
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

            <!-- Modal panel -->
            <div x-show="showModal" x-transition:enter="ease-out duration-300"
                x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                x-transition:leave="ease-in duration-200"
                x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                class="inline-block align-middle bg-white/95 backdrop-blur-md rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:max-w-lg w-full border border-white/50">

                <!-- Modal Header with Image Background effect -->
                <div class="relative h-24 bg-gray-100 overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-b from-transparent to-white/90 z-10"></div>
                    <!-- Use Grid image if available, else common -->
                    <img :src="editingAnime?.subject?.images?.grid || editingAnime?.subject?.images?.common"
                        class="w-full h-full object-cover opacity-50 blur-sm">

                    <div class="absolute bottom-4 left-6 z-20">
                        <h3 class="text-xl font-bold text-gray-800 drop-shadow-sm" id="modal-title">
                            <span x-text="editingAnime?.subject?.name_cn || editingAnime?.subject?.name"></span>
                        </h3>
                    </div>
                </div>

                <div class="px-6 pt-6 pb-2">
                    <!-- Rating -->
                    <div class="mb-6">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">ËØÑÂàÜ
                            Rating</label>
                        <div class="flex items-center gap-1">
                            <template x-for="i in 10">
                                <button type="button" @click="rating = i"
                                    class="text-2xl transition transform hover:scale-110 focus:outline-none"
                                    :class="i <= rating ? 'text-yellow-400 drop-shadow-md' : 'text-gray-200 hover:text-gray-300'">‚òÖ</button>
                            </template>
                            <span x-text="rating > 0 ? rating : '-'"
                                class="ml-3 text-2xl font-bold text-gray-700 w-8 text-center bg-gray-100 rounded-lg"></span>
                        </div>
                    </div>

                    <!-- Comment -->
                    <div class="mb-6">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">ÂêêÊßΩ
                            Comment</label>
                        <textarea x-model="comment" rows="3"
                            class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all resize-none shadow-inner"
                            placeholder="ÂÜôÁÇπ‰ªÄ‰πà..."></textarea>
                    </div>

                    <!-- Tags -->
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Ê†áÁ≠æ
                            Tags</label>
                        <input type="text" x-model="tags"
                            class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all shadow-inner"
                            placeholder="Á©∫Ê†ºÂàÜÈöîÔºåÂ¶ÇÔºöTV ÊêûÁ¨ë Ê≤ªÊÑà">
                    </div>
                </div>

                <div class="bg-gray-50/50 px-6 py-4 flex flex-row-reverse gap-3 border-t border-gray-100">
                    <button type="button" @click="saveChanges()" :disabled="updating"
                        class="w-full sm:w-auto inline-flex justify-center items-center rounded-xl px-6 py-2.5 bg-primary text-white font-bold hover:bg-accent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-all shadow-lg shadow-primary/30 disabled:opacity-50 disabled:shadow-none">
                        <span x-show="!updating">‰øùÂ≠ò‰øÆÊîπ</span>
                        <span x-show="updating" class="flex items-center gap-2">
                            <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                            ‰øùÂ≠ò‰∏≠
                        </span>
                    </button>
                    <button type="button" @click="showModal = false"
                        class="mt-3 sm:mt-0 w-full sm:w-auto inline-flex justify-center rounded-xl border border-gray-200 px-6 py-2.5 bg-white text-gray-600 font-medium hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-200 transition-all">
                        ÂèñÊ∂à
                    </button>
                    <a :href="'https://bgm.tv/subject/' + editingAnime?.subject_id" target="_blank"
                        class="mt-3 sm:mt-0 w-full sm:w-auto inline-flex justify-center items-center gap-1 rounded-xl border border-transparent px-4 py-2 text-gray-400 hover:text-primary transition-colors text-sm">
                        <span>Bangumi</span>
                        <span class="text-xs">‚Üó</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{{ if not .SkipLayout }}{{ template "footer.html" . }}{{ end }}