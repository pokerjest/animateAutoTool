{{ if not .SkipLayout }}{{ template "header.html" . }}{{ end }}

<div class="space-y-6" x-data="{ 
    showAddModal: false,
    showDeleteModal: false,
    deleteId: null,
    loadingDetails: false,
    showDetailsModal: false,
    detailsData: null,
    currentFileCount: 0,
    currentLocalId: 0, // Store Local DB ID
    inputProgress: 0,
    updatingCollection: false,
    updatingComplete: false,
    updatingProgress: false,
    toast: { show: false, message: '', type: 'success' },
    showToast(msg, type = 'success') {
        this.toast.message = msg;
        this.toast.type = type;
        this.toast.show = true;
        setTimeout(() => { this.toast.show = false }, 3000);
    },
    async deleteDirectory(id) {
        if (!confirm('确定要移除该目录吗？')) return;
        try {
            const resp = await fetch('/api/local-directories/' + id, { method: 'DELETE' });
            if (resp.ok) {
                this.showToast('✅ 目录已移除');
                setTimeout(() => window.location.reload(), 500);
            } else {
                this.showToast('❌ 移除失败', 'error');
            }
        } catch (e) {
            this.showToast('❌ 网络错误', 'error');
        }
    },
    async scanDirectory() {
        try {
            const resp = await fetch('/api/local-directories/scan', { method: 'POST' });
            if (resp.ok) {
                this.showToast('✅ 扫描任务已启动');
                setTimeout(() => window.location.reload(), 2000);
            } else {
                this.showToast('❌ 启动扫描失败', 'error');
            }
        } catch (e) {
            this.showToast('❌ 网络错误', 'error');
        }
    },
    // Rename Logic
    showRenameModal: false,
    renameState: {
        id: 0,
        title: '',
        pattern: '{Title} - S{Season}E{Ep}',
        season: '01',
        loading: false,
        preview: null, // Array of {original, new, path}
    },
    async openRenameModal(id, title) {
        this.renameState.id = id;
        this.renameState.title = title;
        this.renameState.season = '01'; // Reset default
        this.renameState.preview = null;
        this.showDetailsModal = false; // Close details
        this.showRenameModal = true;
        this.previewRename(); // Auto preview on open with default
    },
    async previewRename() {
        if (!this.renameState.id) return;
        this.renameState.loading = true;
        try {
            const resp = await fetch(`/api/local-directories/${this.renameState.id}/rename-preview`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    pattern: this.renameState.pattern,
                    season: this.renameState.season
                })
            });
            if (resp.ok) {
                this.renameState.preview = await resp.json();
            } else {
                this.showToast('❌ 预览失败', 'error');
            }
        } catch (e) {
            this.showToast('❌ 网络错误', 'error');
        } finally {
            this.renameState.loading = false;
        }
    },
    async applyRename() {
        if (!confirm('确定要重命名这些文件吗？此操作不可撤销。')) return;
        this.renameState.loading = true;
        try {
            const resp = await fetch(`/api/local-directories/${this.renameState.id}/rename`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    pattern: this.renameState.pattern,
                    season: this.renameState.season
                })
            });
            const data = await resp.json();
            if (resp.ok) {
                this.showToast(`✅ ${data.message}`);
                this.showRenameModal = false;
                // Optional: Refresh details if needed, or just toast
            } else {
                this.showToast('❌ ' + (data.error || '重命名失败'), 'error');
            }
        } catch (e) {
            this.showToast('❌ 网络错误', 'error');
        } finally {
            this.renameState.loading = false;
        }
    },
    getLivePreview() {
        let p = this.renameState.pattern || '{Title} - S{Season}E{Ep}';
        const s = this.renameState.season || '01';
        p = p.replace('{Title}', 'Example Anime');
        p = p.replace('{Season}', s);
        p = p.replace('{Ep}', '01');
        p = p.replace('{SubGroup}', 'SubGroup');
        p = p.replace('{Year}', '2024');
        p = p.replace('{Ext}', 'mp4');
        if (!p.endsWith('.mp4')) p += '.mp4';
        return p;
    }
}" @show-anime-details.window="
    $event.stopPropagation();
    showDetailsModal = true;
    // Set fallback data immediately
    detailsData = {
        id: $event.detail.bangumiId,
        name: $event.detail.title,
        name_cn: $event.detail.title,
        images: { large: $event.detail.image },
        summary: '正在加载详细信息...',
        tags: []
    };
    currentFileCount = $event.detail.fileCount || 0;
    currentLocalId = $event.detail.localId || 0;
    loadingDetails = false; // Show fallback immediately

    fetch('/api/bangumi/subject/' + $event.detail.bangumiId)
        .then(res => {
            if (!res.ok) throw new Error('API Error');
            return res.json();
        })
        .then(data => {
            if (data.error) throw new Error(data.error);
            detailsData = data;
        })
        .catch(err => {
            console.error(err);
            // Keep fallback data
            showToast('获取详情失败，仅显示本地信息', 'error');
        })
">
    <!-- Header Section -->
    <div class="flex justify-between items-center">
        <h2 class="text-2xl font-bold text-gray-700 flex items-center gap-2">
            <span>📂</span> 本地番剧目录
        </h2>
        <div class="flex gap-2">
            <button @click="scanDirectory()"
                class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition shadow-md flex items-center gap-2">
                <span>🔄</span> 重新扫描
            </button>
            <button @click="showAddModal = true"
                class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-accent transition shadow-md flex items-center gap-2">
                <span>➕</span> 添加目录
            </button>
        </div>
    </div>

    <!-- Naming Rules Configuration -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
        <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
            <span>📏</span> 命名规则配置
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="col-span-2">
                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">默认规则模板</label>
                <div class="relative">
                    <span
                        class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400 font-mono text-sm">Example:</span>
                    <input type="text" x-model="renameState.pattern"
                        class="w-full pl-20 pr-4 py-2 rounded-lg bg-gray-50 border border-gray-200 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none font-mono text-sm transition-all shadow-inner"
                        placeholder="{Title} - S{Season}E{Ep}">
                </div>
                <p class="text-[10px] text-gray-400 mt-1 ml-1">支持变量: <code
                        class="bg-gray-100 px-1 rounded text-gray-600">{Title}</code>, <code
                        class="bg-gray-100 px-1 rounded text-gray-600">{Season}</code>, <code
                        class="bg-gray-100 px-1 rounded text-gray-600">{Ep}</code>, <code
                        class="bg-gray-100 px-1 rounded text-gray-600">{SubGroup}</code>, <code
                        class="bg-gray-100 px-1 rounded text-gray-600">{Year}</code>, <code
                        class="bg-gray-100 px-1 rounded text-gray-600">{Ext}</code></p>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">默认季度 (Sxx)</label>
                <input type="text" x-model="renameState.season"
                    class="w-full px-4 py-2 rounded-lg bg-gray-50 border border-gray-200 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none font-mono text-sm transition-all shadow-inner"
                    placeholder="01">
            </div>
        </div>

        <!-- Live Preview Box -->
        <div class="mt-4 pt-4 border-t border-gray-50">
            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">效果预览</label>
            <div
                class="flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-4 text-sm font-mono bg-gray-50 rounded-lg p-3 border border-gray-100">
                <div class="flex items-center gap-2 text-gray-500">
                    <span class="text-xs border border-gray-200 rounded px-1.5 py-0.5 bg-white">原文件名</span>
                    <span>[SubGroup] Example Anime - 01 [1080p].mp4</span>
                </div>
                <div class="hidden sm:block text-gray-300">➜</div>
                <div class="flex items-center gap-2 text-green-600 font-medium">
                    <span
                        class="text-xs border border-green-200 rounded px-1.5 py-0.5 bg-green-50 text-green-700">新文件名</span>
                    <span x-text="getLivePreview()"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Directories List -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
        <h3 class="text-lg font-bold text-gray-800 mb-3">已配置目录</h3>
        <div class="space-y-2">
            {{ range .Directories }}
            <div
                class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-100 group hover:border-blue-200 transition">
                <div class="flex items-center gap-3">
                    <span class="text-xl">📁</span>
                    <span class="font-mono text-sm text-gray-600 tracking-tight">{{ .Path }}</span>
                </div>
                <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button @click="openRenameModal({{ .ID }}, '{{ .Path }}')"
                        class="text-gray-400 hover:text-indigo-600 p-2 rounded-full hover:bg-indigo-50 transition"
                        title="整理/重命名">
                        ✏️
                    </button>
                    <button @click="deleteDirectory({{ .ID }})"
                        class="text-gray-400 hover:text-red-500 p-2 rounded-full hover:bg-red-50 transition">
                        🗑️
                    </button>
                </div>
            </div>
            {{ else }}
            <p class="text-gray-400 text-sm italic">暂未配置任何本地目录</p>
            {{ end }}
        </div>
    </div>

    <!-- Anime List Grid -->
    <div>
        <h3 class="text-lg font-bold text-gray-800 mb-4">扫描到的番剧 ({{ len .AnimeList }})</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            {{ range .AnimeList }}
            {{ template "local_anime_card.html" . }}
            {{ else }}
            <div
                class="col-span-full py-16 text-center text-gray-400 border-2 border-dashed border-gray-100 rounded-xl">
                <div class="text-6xl mb-4 grayscale opacity-20">📦</div>
                <p class="text-lg">暂无本地番剧</p>
                <p class="text-sm mt-2">请先添加目录并点击“重新扫描”</p>
            </div>
            {{ end }}
        </div>
    </div>

    <!-- Add Directory Modal -->
    <div x-show="showAddModal" style="display: none;"
        class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900/60 backdrop-blur-sm"
        x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">

        <div class="bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl w-full max-w-md p-8 relative border border-white/50"
            @click.away="showAddModal = false">
            <h3 class="text-2xl font-bold mb-6 text-gray-800 flex items-center gap-2">
                <span class="bg-primary/10 text-primary p-2 rounded-lg">📂</span> 添加本地目录
            </h3>

            <form hx-post="/api/local-directories" hx-swap="none"
                @htmx:after-request="if(event.detail.successful) { showAddModal = false; window.location.reload() }">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">目录路径</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">/</span>
                        <input type="text" name="path" required
                            class="w-full pl-6 pr-4 py-3 rounded-xl bg-gray-50 border border-gray-200 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none font-mono text-sm transition-all shadow-inner"
                            placeholder="path/to/anime/library">
                    </div>
                    <p class="text-xs text-gray-400 mt-2 ml-1">💡 请输入服务器上的绝对路径，应用将扫描该目录下的子文件夹。</p>
                </div>

                <div class="flex justify-end gap-3 mt-8 pt-6 border-t border-gray-100">
                    <button type="button" @click="showAddModal = false"
                        class="px-6 py-2.5 rounded-xl border border-gray-200 text-gray-600 font-medium hover:bg-gray-50 transition-all">取消</button>
                    <button type="submit" id="add-dir-btn" hx-indicator="#add-dir-btn"
                        class="px-6 py-2.5 rounded-xl bg-primary text-white font-bold hover:bg-accent shadow-lg shadow-pink-200 transition-all active:scale-95 disabled:opacity-70 flex items-center gap-2">
                        <span class="htmx-indicator hidden animate-spin">⌛</span>
                        <span>确定添加</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div x-show="toast.show" x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0"
        x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0"
        x-transition:leave-end="opacity-0 translate-y-2"
        class="fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg text-white font-medium z-50 flex items-center gap-2 max-w-sm break-all"
        :class="toast.type === 'success' ? 'bg-green-500' : 'bg-red-500'" style="display: none;">
        <span x-text="toast.type === 'success' ? '✅' : '❌'"></span>
        <span x-text="toast.message"></span>
    </div>

    <!-- Anime Details Modal -->
    <div x-show="showDetailsModal" style="display: none;"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm p-4"
        x-transition.opacity>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col"
            @click.away="showDetailsModal = false">
            <!-- Header -->
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h3 class="text-lg font-bold text-gray-800">番剧详情</h3>
                <button @click="showDetailsModal = false" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <!-- Content -->
            <div class="p-6 overflow-y-auto custom-scrollbar">
                <div x-show="loadingDetails" class="flex flex-col items-center justify-center py-12">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mb-4"></div>
                    <span class="text-gray-500">正在从 Bangumi 获取信息...</span>
                </div>

                <div x-show="!loadingDetails && detailsData" class="flex flex-col md:flex-row gap-6">
                    <!-- Cover -->
                    <div class="w-full md:w-1/3 flex-shrink-0">
                        <img :src="detailsData?.images?.large" alt="Cover"
                            class="w-full rounded-lg shadow-md object-cover aspect-[2/3]">
                    </div>

                    <!-- Info -->
                    <div class="flex-1 space-y-4">
                        <div>
                            <h2 x-text="detailsData?.name" class="text-2xl font-bold text-gray-900 leading-tight"></h2>
                            <h3 x-text="detailsData?.name_cn" class="text-lg text-gray-600 mt-1"></h3>
                        </div>

                        <div class="flex items-center gap-4">
                            <div
                                class="flex items-center gap-1 bg-amber-50 px-2 py-1 rounded-md border border-amber-100">
                                <span class="text-amber-500 text-lg">★</span>
                                <span x-text="detailsData?.rating?.score" class="font-bold text-gray-800"></span>
                            </div>
                            <span class="text-sm text-gray-500" x-text="detailsData?.air_date"></span>
                        </div>

                        <!-- Tags -->
                        <div class="flex flex-wrap gap-2">
                            <template x-for="tag in (detailsData?.tags || []).slice(0, 5)">
                                <span x-text="tag.name"
                                    class="text-xs px-2 py-1 bg-indigo-50 text-indigo-600 rounded-full"></span>
                            </template>
                        </div>

                        <div class="prose prose-sm text-gray-600 max-h-40 overflow-y-auto pr-2">
                            <p x-text="detailsData?.summary" class="whitespace-pre-line"></p>
                        </div>

                        <!-- Actions Area -->
                        <div class="pt-4 mt-auto border-t border-gray-100">

                            <!-- 1. Collection Status -->
                            <div class="mb-4">
                                <label
                                    class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 block">收藏状态</label>
                                <div class="flex gap-2">
                                    <!-- Watching (Status 3) -->
                                    <button type="button" :disabled="updatingCollection" @click="
                                                updatingCollection = true;
                                                fetch('/api/bangumi/subject/' + detailsData?.id + '/collection', { 
                                                    method: 'POST',
                                                    headers: {'Content-Type': 'application/json'},
                                                    body: JSON.stringify({status: 3}) 
                                                })
                                                .then(r => r.json())
                                                .then(d => {
                                                    if(d.error) showToast(d.error, 'error');
                                                    else showToast('✅ ' + (d.message || '已标记为在看'));
                                                })
                                                .catch(e => showToast('❌ 请求失败', 'error'))
                                                .finally(() => updatingCollection = false)
                                            "
                                        class="flex-1 bg-pink-100 text-pink-600 px-3 py-2 rounded-lg hover:bg-pink-200 transition flex items-center justify-center gap-2 disabled:opacity-50 font-medium text-sm">
                                        <span x-show="!updatingCollection">📺</span>
                                        <span x-show="updatingCollection" class="animate-spin">⏳</span>
                                        <span>在看</span>
                                    </button>

                                    <!-- Completed (Status 2) -->
                                    <button type="button" :disabled="updatingComplete" @click="
                                                updatingComplete = true;
                                                // 1. Update Collection Status to 2 (Collect)
                                                fetch('/api/bangumi/subject/' + detailsData?.id + '/collection', { 
                                                    method: 'POST',
                                                    headers: {'Content-Type': 'application/json'},
                                                    body: JSON.stringify({status: 2}) 
                                                })
                                                .then(r => r.json())
                                                .then(d => {
                                                    if(d.error) throw new Error(d.error);
                                                    showToast('✅ 已标记为看过');
                                                    
                                                    // 2. Auto Update Progress to Max (if eps > 0)
                                                    const totalEps = detailsData?.eps || 0;
                                                    if (totalEps > 0) {
                                                        return fetch('/api/bangumi/subject/' + detailsData?.id + '/progress', { 
                                                            method: 'POST', 
                                                            headers: {'Content-Type': 'application/json'},
                                                            body: JSON.stringify({episode_count: totalEps}) 
                                                        });
                                                    }
                                                })
                                                .then(r => r ? r.json() : null)
                                                .then(d => {
                                                    if(d && d.error) showToast('⚠️ 状态更新成功但进度同步失败: ' + d.error, 'error');
                                                    else if(d) showToast('✅ 已自动同步进度至 ' + (detailsData?.eps || 0) + ' 集');
                                                })
                                                .catch(e => showToast('❌ ' + e.message, 'error'))
                                                .finally(() => updatingComplete = false)
                                            "
                                        class="flex-1 bg-green-100 text-green-600 px-3 py-2 rounded-lg hover:bg-green-200 transition flex items-center justify-center gap-2 disabled:opacity-50 font-medium text-sm">
                                        <span x-show="!updatingComplete">✅</span>
                                        <span x-show="updatingComplete" class="animate-spin">⏳</span>
                                        <span>看过 (完成)</span>
                                    </button>
                                </div>
                            </div>

                            <!-- 2. Progress Control -->
                            <div>
                                <label
                                    class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 block">观看进度</label>
                                <div class="flex gap-2 items-center">
                                    <!-- Input -->
                                    <div class="relative w-24">
                                        <input type="number" x-model="inputProgress" min="0"
                                            class="w-full px-3 py-2 border rounded-lg text-center font-mono focus:ring-2 focus:ring-indigo-500 outline-none">
                                    </div>

                                    <!-- Update Button -->
                                    <button type="button" :disabled="updatingProgress" @click="
                                                updatingProgress = true;
                                                fetch('/api/bangumi/subject/' + detailsData?.id + '/progress', { 
                                                    method: 'POST', 
                                                    headers: {'Content-Type': 'application/json'},
                                                    body: JSON.stringify({episode_count: parseInt(inputProgress)}) 
                                                })
                                                .then(r => r.json())
                                                .then(d => {
                                                    if(d.error) showToast(d.error, 'error');
                                                    else showToast('✅ ' + d.message);
                                                })
                                                .catch(e => showToast('❌ 请求失败', 'error'))
                                                .finally(() => updatingProgress = false)
                                            "
                                        class="flex-1 bg-indigo-500 text-white px-3 py-2 rounded-lg hover:bg-indigo-600 transition flex items-center justify-center gap-2 disabled:opacity-70 shadow-sm text-sm font-medium">
                                        <span x-show="updatingProgress" class="animate-spin">⏳</span>
                                        <span>同步</span>
                                    </button>

                                    <!-- Reset Button -->
                                    <button type="button" @click="
                                                if(!confirm('确定要重置观看进度为 0 吗？')) return;
                                                inputProgress = 0;
                                                updatingProgress = true;
                                                fetch('/api/bangumi/subject/' + detailsData?.id + '/progress', { 
                                                    method: 'POST', 
                                                    headers: {'Content-Type': 'application/json'},
                                                    body: JSON.stringify({episode_count: 0}) 
                                                })
                                                .then(r => r.json())
                                                .then(d => {
                                                    if(d.error) showToast(d.error, 'error');
                                                    else showToast('🔄 已重置进度');
                                                })
                                                .catch(e => showToast('❌ 请求失败', 'error'))
                                                .finally(() => updatingProgress = false)
                                            "
                                        class="px-3 py-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition"
                                        title="重置进度">
                                        <span class="text-lg">↺</span>
                                    </button>
                                </div>
                                <p class="text-[10px] text-gray-400 mt-1 pl-1"> * 默认为本地文件数量，可手动修改并同步</p>
                            </div>
                        </div>

                        <!-- 3. File Actions (Rename) -->
                        <div class="pt-4 mt-4 border-t border-gray-100">
                            <button @click="openRenameModal(currentLocalId, detailsData?.name)"
                                class="w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition flex items-center justify-center gap-2 font-medium">
                                <span>✏️</span> 文件整理 & 重命名
                            </button>
                        </div>



                        <a :href="'https://bgm.tv/subject/' + detailsData?.id" target="_blank"
                            class="block text-center text-xs text-indigo-400 hover:text-indigo-600 mt-2 transition-colors">
                            在 Bangumi 上查看详情 &rarr;
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rename Modal -->
<div x-show="showRenameModal" style="display: none;"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm p-4"
    x-transition.opacity>
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col"
        @click.away="showRenameModal = false">
        <!-- Header -->
        <div class="p-4 border-b flex justify-between items-center bg-gray-50">
            <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                <span>✏️</span> 批量重命名 - <span x-text="renameState.title"
                    class="text-primary truncate max-w-md block"></span>
            </h3>
            <button @click="showRenameModal = false" class="text-gray-400 hover:text-gray-600">✕</button>
        </div>

        <!-- Content -->
        <div class="p-6 overflow-y-auto custom-scrollbar flex-1">
            <!-- Rules -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="col-span-2">
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">命名规则模板</label>
                    <input type="text" x-model="renameState.pattern" @input.debounce.500ms="previewRename()"
                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none font-mono text-sm"
                        placeholder="{Title} - S{Season}E{Ep}">
                    <p class="text-[10px] text-gray-400 mt-1">支持变量: {Title}, {Season}, {Ep}, {Ext}</p>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">季度 (Sxx)</label>
                    <input type="text" x-model="renameState.season" @input.debounce.500ms="previewRename()"
                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none font-mono text-sm"
                        placeholder="01">
                </div>
            </div>

            <!-- Preview Table -->
            <div class="bg-gray-50 rounded-xl border border-gray-100 overflow-hidden">
                <div
                    class="p-3 bg-gray-100/50 border-b border-gray-200 text-xs font-bold text-gray-500 flex justify-between items-center">
                    <span>预览结果</span>
                    <span x-show="renameState.loading" class="flex items-center gap-1 text-primary">
                        <span class="animate-spin">⏳</span> 生成预览中...
                    </span>
                </div>
                <div class="max-h-[300px] overflow-y-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-500 bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 font-medium w-32">所属番剧</th>
                                <th class="px-4 py-2 font-medium w-1/3">原文件名</th>
                                <th class="px-4 py-2 font-medium w-1/3">新文件名</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <template x-for="(item, idx) in renameState.preview" :key="idx">
                                <tr class="hover:bg-white transition-colors">
                                    <td class="px-4 py-2 font-medium text-indigo-600 truncate max-w-[150px]"
                                        :title="item.anime_name" x-text="item.anime_name"></td>
                                    <td class="px-4 py-2 font-mono text-gray-600 truncate max-w-[200px]"
                                        :title="item.original" x-text="item.original"></td>
                                    <td class="px-4 py-2 font-mono truncate max-w-[200px]"
                                        :class="item.original === item.new ? 'text-gray-400 italic' : 'text-green-600 font-medium'"
                                        :title="item.new" x-text="item.new"></td>
                                </tr>
                            </template>
                            <template x-if="!renameState.preview || renameState.preview.length === 0">
                                <tr>
                                    <td colspan="2" class="px-4 py-8 text-center text-gray-400 italic">
                                        暂无预览，请检查规则或等待加载...
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="p-4 border-t bg-gray-50 flex justify-end gap-3">
            <button @click="showRenameModal = false"
                class="px-4 py-2 rounded-lg border border-gray-200 text-gray-600 hover:bg-white transition">取消</button>
            <button @click="applyRename()" :disabled="renameState.loading || !renameState.preview"
                class="px-6 py-2 rounded-lg bg-primary text-white font-bold hover:bg-accent transition shadow-lg shadow-pink-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                <span x-show="renameState.loading" class="animate-spin">⏳</span>
                <span>确认重命名</span>
            </button>
        </div>
    </div>
</div>

</div>
</div>
</div>

{{ if not .SkipLayout }}
</main>
</div>
</body>

</html>
{{ end }}