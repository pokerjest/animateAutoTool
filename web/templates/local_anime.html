{{ if not .SkipLayout }}{{ template "header.html" . }}{{ end }}

<div class="space-y-6" x-data="{ 
    showAddModal: false,
    showDeleteModal: false,
    deleteId: null,
    loadingDetails: false,
    showDetailsModal: false,
    detailsData: null,
    currentFileCount: 0,
    inputProgress: 0,
    updatingCollection: false,
    updatingComplete: false,
    updatingProgress: false,
    toast: { show: false, message: '', type: 'success' },
    showToast(msg, type = 'success') {
        this.toast.message = msg;
        this.toast.type = type;
        this.toast.show = true;
        setTimeout(() => { this.toast.show = false }, 3000);
    },
    async deleteDirectory(id) {
        if (!confirm('ç¡®å®šè¦ç§»é™¤è¯¥ç›®å½•å—ï¼Ÿ')) return;
        try {
            const resp = await fetch('/api/local-directories/' + id, { method: 'DELETE' });
            if (resp.ok) {
                this.showToast('âœ… ç›®å½•å·²ç§»é™¤');
                setTimeout(() => window.location.reload(), 500);
            } else {
                this.showToast('âŒ ç§»é™¤å¤±è´¥', 'error');
            }
        } catch (e) {
            this.showToast('âŒ ç½‘ç»œé”™è¯¯', 'error');
        }
    },
    async scanDirectory() {
        try {
            const resp = await fetch('/api/local-directories/scan', { method: 'POST' });
            if (resp.ok) {
                this.showToast('âœ… æ‰«æä»»åŠ¡å·²å¯åŠ¨');
                setTimeout(() => window.location.reload(), 2000);
            } else {
                this.showToast('âŒ å¯åŠ¨æ‰«æå¤±è´¥', 'error');
            }
        } catch (e) {
            this.showToast('âŒ ç½‘ç»œé”™è¯¯', 'error');
        }
    }
}" @show-anime-details.window="
    $event.stopPropagation();
    showDetailsModal = true;
    detailsData = null;
    currentFileCount = $event.detail.fileCount || 0;
    loadingDetails = true;
    fetch('/api/bangumi/subject/' + $event.detail.bangumiId)
        .then(res => res.json())
        .then(data => {
            detailsData = data;
            loadingDetails = false;
        })
        .catch(err => {
            console.error(err);
            loadingDetails = false;
            showToast('è·å–è¯¦æƒ…å¤±è´¥', 'error');
        })
">
    <!-- Header Section -->
    <div class="flex justify-between items-center">
        <h2 class="text-2xl font-bold text-gray-700 flex items-center gap-2">
            <span>ğŸ“‚</span> æœ¬åœ°ç•ªå‰§ç›®å½•
        </h2>
        <div class="flex gap-2">
            <button @click="scanDirectory()"
                class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition shadow-md flex items-center gap-2">
                <span>ğŸ”„</span> é‡æ–°æ‰«æ
            </button>
            <button @click="showAddModal = true"
                class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-accent transition shadow-md flex items-center gap-2">
                <span>â•</span> æ·»åŠ ç›®å½•
            </button>
        </div>
    </div>

    <!-- Directories List -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
        <h3 class="text-lg font-bold text-gray-800 mb-3">å·²é…ç½®ç›®å½•</h3>
        <div class="space-y-2">
            {{ range .Directories }}
            <div
                class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-100 group hover:border-blue-200 transition">
                <div class="flex items-center gap-3">
                    <span class="text-xl">ğŸ“</span>
                    <span class="font-mono text-sm text-gray-600 tracking-tight">{{ .Path }}</span>
                </div>
                <button @click="deleteDirectory({{ .ID }})"
                    class="text-gray-400 hover:text-red-500 p-2 rounded-full hover:bg-red-50 transition opacity-0 group-hover:opacity-100">
                    ğŸ—‘ï¸
                </button>
            </div>
            {{ else }}
            <p class="text-gray-400 text-sm italic">æš‚æœªé…ç½®ä»»ä½•æœ¬åœ°ç›®å½•</p>
            {{ end }}
        </div>
    </div>

    <!-- Anime List Grid -->
    <div>
        <h3 class="text-lg font-bold text-gray-800 mb-4">æ‰«æåˆ°çš„ç•ªå‰§ ({{ len .AnimeList }})</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            {{ range .AnimeList }}
            <div
                class="bg-white rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow overflow-hidden flex flex-col h-full group">
                <!-- Card Header/Cover -->
                <div class="relative h-48 bg-gray-100 overflow-hidden cursor-pointer"
                    @click="$dispatch('show-anime-details', { bangumiId: {{ .BangumiID }}, fileCount: {{ .FileCount }} })">
                    {{ if .Image }}
                    <img src="{{ .Image }}" alt="{{ .Title }}"
                        class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105">
                    {{ else }}
                    <div class="w-full h-full flex items-center justify-center text-4xl opacity-10">ğŸ“º</div>
                    {{ end }}

                    <!-- Overlay Gradient -->
                    <div
                        class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                    </div>
                </div>

                <!-- Card Body -->
                <div class="p-4 flex flex-col flex-grow">
                    <!-- Title -->
                    <div class="flex justify-between items-start gap-2 mb-2">
                        <h3 class="font-bold text-gray-800 text-lg line-clamp-2 leading-tight cursor-pointer hover:text-indigo-600 transition-colors"
                            @click="$dispatch('show-anime-details', { bangumiId: {{ .BangumiID }}, fileCount: {{ .FileCount }} })">
                            {{ .Title }}
                        </h3>
                    </div>

                    <!-- Tags/Info -->
                    <div class="flex flex-wrap gap-2 mb-4">
                        {{ if gt .BangumiID 0 }}
                        <span
                            class="px-2 py-0.5 rounded text-xs font-medium bg-pink-50 text-pink-600 flex items-center gap-1">
                            ğŸŒ¸ Bangumi
                        </span>
                        {{ else }}
                        <span
                            class="px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-500 flex items-center gap-1">
                            âšª æœªå…³è”
                        </span>
                        {{ end }}
                    </div>

                    <!-- Stats -->
                    <div
                        class="mt-auto pt-3 border-t border-gray-50 flex justify-between items-center text-sm text-gray-500">
                        <div class="flex items-center gap-1.5" title="æ–‡ä»¶æ•°é‡">
                            <span>ğŸ“„</span>
                            <span class="font-medium">{{ .FileCount }}</span>
                        </div>
                        <div class="flex items-center gap-1.5" title="æ€»å¤§å°">
                            <span>ğŸ’¾</span>
                            <span class="font-medium">{{ .TotalSize | toGB }}</span>
                        </div>
                    </div>

                    <!-- Path (Tooltip or small text) -->
                    <div class="mt-2 text-xs text-gray-400 truncate font-mono" title="{{ .Path }}">
                        {{ .Path }}
                    </div>
                </div>
            </div>
            {{ else }}
            <div
                class="col-span-full py-16 text-center text-gray-400 border-2 border-dashed border-gray-100 rounded-xl">
                <div class="text-6xl mb-4 grayscale opacity-20">ğŸ“¦</div>
                <p class="text-lg">æš‚æ— æœ¬åœ°ç•ªå‰§</p>
                <p class="text-sm mt-2">è¯·å…ˆæ·»åŠ ç›®å½•å¹¶ç‚¹å‡»â€œé‡æ–°æ‰«æâ€</p>
            </div>
            {{ end }}
        </div>
    </div>

    <!-- Add Directory Modal -->
    <div x-show="showAddModal" style="display: none;"
        class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900/60 backdrop-blur-sm"
        x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">

        <div class="bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl w-full max-w-md p-8 relative border border-white/50"
            @click.away="showAddModal = false">
            <h3 class="text-2xl font-bold mb-6 text-gray-800 flex items-center gap-2">
                <span class="bg-primary/10 text-primary p-2 rounded-lg">ğŸ“‚</span> æ·»åŠ æœ¬åœ°ç›®å½•
            </h3>

            <form hx-post="/api/local-directories" hx-swap="none"
                @htmx:after-request="if(event.detail.successful) { showAddModal = false; window.location.reload() }">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">ç›®å½•è·¯å¾„</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">/</span>
                        <input type="text" name="path" required
                            class="w-full pl-6 pr-4 py-3 rounded-xl bg-gray-50 border border-gray-200 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none font-mono text-sm transition-all shadow-inner"
                            placeholder="path/to/anime/library">
                    </div>
                    <p class="text-xs text-gray-400 mt-2 ml-1">ğŸ’¡ è¯·è¾“å…¥æœåŠ¡å™¨ä¸Šçš„ç»å¯¹è·¯å¾„ï¼Œåº”ç”¨å°†æ‰«æè¯¥ç›®å½•ä¸‹çš„å­æ–‡ä»¶å¤¹ã€‚</p>
                </div>

                <div class="flex justify-end gap-3 mt-8 pt-6 border-t border-gray-100">
                    <button type="button" @click="showAddModal = false"
                        class="px-6 py-2.5 rounded-xl border border-gray-200 text-gray-600 font-medium hover:bg-gray-50 transition-all">å–æ¶ˆ</button>
                    <button type="submit" id="add-dir-btn" hx-indicator="#add-dir-btn"
                        class="px-6 py-2.5 rounded-xl bg-primary text-white font-bold hover:bg-accent shadow-lg shadow-pink-200 transition-all active:scale-95 disabled:opacity-70 flex items-center gap-2">
                        <span class="htmx-indicator hidden animate-spin">âŒ›</span>
                        <span>ç¡®å®šæ·»åŠ </span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div x-show="toast.show" x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0"
        x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0"
        x-transition:leave-end="opacity-0 translate-y-2"
        class="fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg text-white font-medium z-50 flex items-center gap-2 max-w-sm break-all"
        :class="toast.type === 'success' ? 'bg-green-500' : 'bg-red-500'" style="display: none;">
        <span x-text="toast.type === 'success' ? 'âœ…' : 'âŒ'"></span>
        <span x-text="toast.message"></span>
    </div>

    <!-- Anime Details Modal -->
    <div x-show="showDetailsModal" style="display: none;"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm p-4"
        x-transition.opacity>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col"
            @click.away="showDetailsModal = false">
            <!-- Header -->
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h3 class="text-lg font-bold text-gray-800">ç•ªå‰§è¯¦æƒ…</h3>
                <button @click="showDetailsModal = false" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <!-- Content -->
            <div class="p-6 overflow-y-auto custom-scrollbar">
                <div x-show="loadingDetails" class="flex flex-col items-center justify-center py-12">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mb-4"></div>
                    <span class="text-gray-500">æ­£åœ¨ä» Bangumi è·å–ä¿¡æ¯...</span>
                </div>

                <div x-show="!loadingDetails && detailsData" class="flex flex-col md:flex-row gap-6">
                    <!-- Cover -->
                    <div class="w-full md:w-1/3 flex-shrink-0">
                        <img :src="detailsData?.images?.large" alt="Cover"
                            class="w-full rounded-lg shadow-md object-cover aspect-[2/3]">
                    </div>

                    <!-- Info -->
                    <div class="flex-1 space-y-4">
                        <div>
                            <h2 x-text="detailsData?.name" class="text-2xl font-bold text-gray-900 leading-tight"></h2>
                            <h3 x-text="detailsData?.name_cn" class="text-lg text-gray-600 mt-1"></h3>
                        </div>

                        <div class="flex items-center gap-4">
                            <div
                                class="flex items-center gap-1 bg-amber-50 px-2 py-1 rounded-md border border-amber-100">
                                <span class="text-amber-500 text-lg">â˜…</span>
                                <span x-text="detailsData?.rating?.score" class="font-bold text-gray-800"></span>
                            </div>
                            <span class="text-sm text-gray-500" x-text="detailsData?.air_date"></span>
                        </div>

                        <!-- Tags -->
                        <div class="flex flex-wrap gap-2">
                            <template x-for="tag in (detailsData?.tags || []).slice(0, 5)">
                                <span x-text="tag.name"
                                    class="text-xs px-2 py-1 bg-indigo-50 text-indigo-600 rounded-full"></span>
                            </template>
                        </div>

                        <div class="prose prose-sm text-gray-600 max-h-40 overflow-y-auto pr-2">
                            <p x-text="detailsData?.summary" class="whitespace-pre-line"></p>
                        </div>

                        <!-- Actions Area -->
                        <div class="pt-4 mt-auto border-t border-gray-100">

                            <!-- 1. Collection Status -->
                            <div class="mb-4">
                                <label
                                    class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 block">æ”¶è—çŠ¶æ€</label>
                                <div class="flex gap-2">
                                    <!-- Watching (Status 3) -->
                                    <button type="button" :disabled="updatingCollection" @click="
                                                updatingCollection = true;
                                                fetch('/api/bangumi/subject/' + detailsData?.id + '/collection', { 
                                                    method: 'POST',
                                                    headers: {'Content-Type': 'application/json'},
                                                    body: JSON.stringify({status: 3}) 
                                                })
                                                .then(r => r.json())
                                                .then(d => {
                                                    if(d.error) showToast(d.error, 'error');
                                                    else showToast('âœ… ' + (d.message || 'å·²æ ‡è®°ä¸ºåœ¨çœ‹'));
                                                })
                                                .catch(e => showToast('âŒ è¯·æ±‚å¤±è´¥', 'error'))
                                                .finally(() => updatingCollection = false)
                                            "
                                        class="flex-1 bg-pink-100 text-pink-600 px-3 py-2 rounded-lg hover:bg-pink-200 transition flex items-center justify-center gap-2 disabled:opacity-50 font-medium text-sm">
                                        <span x-show="!updatingCollection">ğŸ“º</span>
                                        <span x-show="updatingCollection" class="animate-spin">â³</span>
                                        <span>åœ¨çœ‹</span>
                                    </button>

                                    <!-- Completed (Status 2) -->
                                    <button type="button" :disabled="updatingComplete" @click="
                                                updatingComplete = true;
                                                // 1. Update Collection Status to 2 (Collect)
                                                fetch('/api/bangumi/subject/' + detailsData?.id + '/collection', { 
                                                    method: 'POST',
                                                    headers: {'Content-Type': 'application/json'},
                                                    body: JSON.stringify({status: 2}) 
                                                })
                                                .then(r => r.json())
                                                .then(d => {
                                                    if(d.error) throw new Error(d.error);
                                                    showToast('âœ… å·²æ ‡è®°ä¸ºçœ‹è¿‡');
                                                    
                                                    // 2. Auto Update Progress to Max (if eps > 0)
                                                    const totalEps = detailsData?.eps || 0;
                                                    if (totalEps > 0) {
                                                        return fetch('/api/bangumi/subject/' + detailsData?.id + '/progress', { 
                                                            method: 'POST', 
                                                            headers: {'Content-Type': 'application/json'},
                                                            body: JSON.stringify({episode_count: totalEps}) 
                                                        });
                                                    }
                                                })
                                                .then(r => r ? r.json() : null)
                                                .then(d => {
                                                    if(d && d.error) showToast('âš ï¸ çŠ¶æ€æ›´æ–°æˆåŠŸä½†è¿›åº¦åŒæ­¥å¤±è´¥: ' + d.error, 'error');
                                                    else if(d) showToast('âœ… å·²è‡ªåŠ¨åŒæ­¥è¿›åº¦è‡³ ' + (detailsData?.eps || 0) + ' é›†');
                                                })
                                                .catch(e => showToast('âŒ ' + e.message, 'error'))
                                                .finally(() => updatingComplete = false)
                                            "
                                        class="flex-1 bg-green-100 text-green-600 px-3 py-2 rounded-lg hover:bg-green-200 transition flex items-center justify-center gap-2 disabled:opacity-50 font-medium text-sm">
                                        <span x-show="!updatingComplete">âœ…</span>
                                        <span x-show="updatingComplete" class="animate-spin">â³</span>
                                        <span>çœ‹è¿‡ (å®Œæˆ)</span>
                                    </button>
                                </div>
                            </div>

                            <!-- 2. Progress Control -->
                            <div>
                                <label
                                    class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 block">è§‚çœ‹è¿›åº¦</label>
                                <div class="flex gap-2 items-center">
                                    <!-- Input -->
                                    <div class="relative w-24">
                                        <input type="number" x-model="inputProgress" min="0"
                                            class="w-full px-3 py-2 border rounded-lg text-center font-mono focus:ring-2 focus:ring-indigo-500 outline-none">
                                    </div>

                                    <!-- Update Button -->
                                    <button type="button" :disabled="updatingProgress" @click="
                                                updatingProgress = true;
                                                fetch('/api/bangumi/subject/' + detailsData?.id + '/progress', { 
                                                    method: 'POST', 
                                                    headers: {'Content-Type': 'application/json'},
                                                    body: JSON.stringify({episode_count: parseInt(inputProgress)}) 
                                                })
                                                .then(r => r.json())
                                                .then(d => {
                                                    if(d.error) showToast(d.error, 'error');
                                                    else showToast('âœ… ' + d.message);
                                                })
                                                .catch(e => showToast('âŒ è¯·æ±‚å¤±è´¥', 'error'))
                                                .finally(() => updatingProgress = false)
                                            "
                                        class="flex-1 bg-indigo-500 text-white px-3 py-2 rounded-lg hover:bg-indigo-600 transition flex items-center justify-center gap-2 disabled:opacity-70 shadow-sm text-sm font-medium">
                                        <span x-show="updatingProgress" class="animate-spin">â³</span>
                                        <span>åŒæ­¥</span>
                                    </button>

                                    <!-- Reset Button -->
                                    <button type="button" @click="
                                                if(!confirm('ç¡®å®šè¦é‡ç½®è§‚çœ‹è¿›åº¦ä¸º 0 å—ï¼Ÿ')) return;
                                                inputProgress = 0;
                                                updatingProgress = true;
                                                fetch('/api/bangumi/subject/' + detailsData?.id + '/progress', { 
                                                    method: 'POST', 
                                                    headers: {'Content-Type': 'application/json'},
                                                    body: JSON.stringify({episode_count: 0}) 
                                                })
                                                .then(r => r.json())
                                                .then(d => {
                                                    if(d.error) showToast(d.error, 'error');
                                                    else showToast('ğŸ”„ å·²é‡ç½®è¿›åº¦');
                                                })
                                                .catch(e => showToast('âŒ è¯·æ±‚å¤±è´¥', 'error'))
                                                .finally(() => updatingProgress = false)
                                            "
                                        class="px-3 py-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition"
                                        title="é‡ç½®è¿›åº¦">
                                        <span class="text-lg">â†º</span>
                                    </button>
                                </div>
                                <p class="text-[10px] text-gray-400 mt-1 pl-1"> * é»˜è®¤ä¸ºæœ¬åœ°æ–‡ä»¶æ•°é‡ï¼Œå¯æ‰‹åŠ¨ä¿®æ”¹å¹¶åŒæ­¥</p>
                            </div>
                        </div>

                        <a :href="'https://bgm.tv/subject/' + detailsData?.id" target="_blank"
                            class="block text-center text-xs text-indigo-400 hover:text-indigo-600 mt-2 transition-colors">
                            åœ¨ Bangumi ä¸ŠæŸ¥çœ‹è¯¦æƒ… &rarr;
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

{{ if not .SkipLayout }}
</main>
</div>
</body>

</html>
{{ end }}