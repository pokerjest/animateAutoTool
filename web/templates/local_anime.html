{{ if not .SkipLayout }}{{ template "header.html" . }}{{ end }}

<div class="space-y-6" x-data="{ 
    showAddModal: false,
    toast: { show: false, message: '', type: 'success' },
    showToast(msg, type = 'success') {
        this.toast.message = msg;
        this.toast.type = type;
        this.toast.show = true;
        setTimeout(() => { this.toast.show = false }, 3000);
    },
    async deleteDirectory(id) {
        if (!confirm('ç¡®å®šè¦ç§»é™¤è¯¥ç›®å½•å—ï¼Ÿ')) return;
        try {
            const resp = await fetch('/api/local-directories/' + id, { method: 'DELETE' });
            if (resp.ok) {
                this.showToast('âœ… ç›®å½•å·²ç§»é™¤');
                setTimeout(() => window.location.reload(), 500);
            } else {
                this.showToast('âŒ ç§»é™¤å¤±è´¥', 'error');
            }
        } catch (e) {
            this.showToast('âŒ ç½‘ç»œé”™è¯¯', 'error');
        }
    },
    async scanDirectory() {
        try {
            const resp = await fetch('/api/local-directories/scan', { method: 'POST' });
            if (resp.ok) {
                this.showToast('âœ… æ‰«æä»»åŠ¡å·²å¯åŠ¨');
                // Optional: Reload after some time to show results
                setTimeout(() => window.location.reload(), 2000);
            } else {
                this.showToast('âŒ å¯åŠ¨æ‰«æå¤±è´¥', 'error');
            }
        } catch (e) {
            this.showToast('âŒ ç½‘ç»œé”™è¯¯', 'error');
        }
    }
}">
    <!-- Header Section -->
    <div class="flex justify-between items-center">
        <h2 class="text-2xl font-bold text-gray-700 flex items-center gap-2">
            <span>ğŸ“‚</span> æœ¬åœ°ç•ªå‰§ç›®å½•
        </h2>
        <div class="flex gap-2">
            <button @click="scanDirectory()"
                class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition shadow-md flex items-center gap-2">
                <span>ğŸ”„</span> é‡æ–°æ‰«æ
            </button>
            <button @click="showAddModal = true"
                class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-accent transition shadow-md flex items-center gap-2">
                <span>â•</span> æ·»åŠ ç›®å½•
            </button>
        </div>
    </div>

    <!-- Directories List -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
        <h3 class="text-lg font-bold text-gray-800 mb-3">å·²é…ç½®ç›®å½•</h3>
        <div class="space-y-2">
            {{ range .Directories }}
            <div
                class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-100 group hover:border-blue-200 transition">
                <div class="flex items-center gap-3">
                    <span class="text-xl">ğŸ“</span>
                    <span class="font-mono text-sm text-gray-600 tracking-tight">{{ .Path }}</span>
                </div>
                <button @click="deleteDirectory({{ .ID }})"
                    class="text-gray-400 hover:text-red-500 p-2 rounded-full hover:bg-red-50 transition opacity-0 group-hover:opacity-100">
                    ğŸ—‘ï¸
                </button>
            </div>
            {{ else }}
            <p class="text-gray-400 text-sm italic">æš‚æœªé…ç½®ä»»ä½•æœ¬åœ°ç›®å½•</p>
            {{ end }}
        </div>
    </div>

    <!-- Anime List Grid -->
    <div>
        <h3 class="text-lg font-bold text-gray-800 mb-4">æ‰«æåˆ°çš„ç•ªå‰§ ({{ len .AnimeList }})</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
            {{ range .AnimeList }}
            <div
                class="bg-white rounded-xl border border-gray-100 overflow-hidden hover:shadow-lg transition group relative">
                <div class="aspect-[3/4] bg-gray-100 flex items-center justify-center relative overflow-hidden">
                    <span class="text-4xl opacity-20 group-hover:scale-110 transition-transform duration-500">ğŸ“º</span>
                    <!-- Overlay Info -->
                    <div
                        class="absolute inset-0 bg-gradient-to-t from-gray-900/80 to-transparent opacity-0 group-hover:opacity-100 transition duration-300 flex flex-col justify-end p-3">
                        <p class="text-white text-xs font-mono">{{ .Path }}</p>
                    </div>
                </div>
                <div class="p-3">
                    <h4 class="font-bold text-gray-800 text-sm line-clamp-2 mb-1" title="{{ .Title }}">{{ .Title }}</h4>
                    <div class="flex justify-between items-center text-xs text-gray-500">
                        <span>{{ .FileCount }} ä¸ªè§†é¢‘</span>
                        <span>{{ .TotalSize | toGB }}</span>
                    </div>
                </div>
            </div>
            {{ else }}
            <div
                class="col-span-full py-12 text-center text-gray-400 border-2 border-dashed border-gray-100 rounded-xl">
                <div class="text-4xl mb-4 grayscale opacity-30">ğŸ“¦</div>
                <p>æš‚æ— å†…å®¹ï¼Œè¯·æ·»åŠ ç›®å½•å¹¶ç‚¹å‡»æ‰«æ</p>
            </div>
            {{ end }}
        </div>
    </div>

    <!-- Add Directory Modal -->
    <div x-show="showAddModal" style="display: none;"
        class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm"
        x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">

        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 relative" @click.away="showAddModal = false">
            <h3 class="text-xl font-bold mb-4 text-gray-800">æ·»åŠ æœ¬åœ°ç›®å½•</h3>

            <form hx-post="/api/local-directories" hx-swap="none"
                @htmx:after-request="if(event.detail.successful) { showAddModal = false; window.location.reload() }">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ç›®å½•è·¯å¾„</label>
                    <input type="text" name="path" required
                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none font-mono text-sm"
                        placeholder="/path/to/anime/library">
                    <p class="text-xs text-gray-400 mt-1">è¯·è¾“å…¥æœåŠ¡å™¨ä¸Šçš„ç»å¯¹è·¯å¾„ï¼Œåº”ç”¨å°†æ‰«æè¯¥ç›®å½•ä¸‹çš„å­æ–‡ä»¶å¤¹ä½œä¸ºç•ªå‰§ã€‚</p>
                </div>

                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" @click="showAddModal = false"
                        class="px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100">å–æ¶ˆ</button>
                    <button type="submit" id="add-dir-btn" hx-indicator="#add-dir-btn"
                        class="px-6 py-2 rounded-lg bg-primary text-white hover:bg-accent shadow-lg shadow-pink-200 transition disabled:opacity-70 flex items-center gap-2">
                        <span class="htmx-indicator hidden animate-spin">âŒ›</span>
                        <span>ç¡®å®šæ·»åŠ </span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div x-show="toast.show" x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0"
        x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0"
        x-transition:leave-end="opacity-0 translate-y-2"
        class="fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg text-white font-medium z-50 flex items-center gap-2 max-w-sm break-all"
        :class="toast.type === 'success' ? 'bg-green-500' : 'bg-red-500'" style="display: none;">
        <span x-text="toast.type === 'success' ? 'âœ…' : 'âŒ'"></span>
        <span x-text="toast.message"></span>
    </div>

</div>

{{ if not .SkipLayout }}
</main>
</div>
</body>

</html>
{{ end }}