{{ if not .SkipLayout }}{{ template "header.html" . }}{{ end }}

<div class="space-y-6" x-data="{ 
    activeTab: 'download',
    tabs: [
        { id: 'download', name: 'ä¸‹è½½ç®¡ç†', icon: 'ğŸ“¥' },
        { id: 'metadata', name: 'å…ƒæ•°æ®', icon: 'ğŸ·ï¸' },
        { id: 'media', name: 'åª’ä½“/åŒæ­¥', icon: 'ğŸ¬' },
        { id: 'network', name: 'ç½‘ç»œä»£ç†', icon: 'ğŸŒ' },
        { id: 'security', name: 'è´¦æˆ·å®‰å…¨', icon: 'ğŸ”' }
    ]
}">
    <div class="flex items-end justify-between border-b border-gray-200/50 pb-4">
        <h2 class="text-3xl font-black text-gray-800 tracking-tight">ç³»ç»Ÿè®¾ç½®</h2>
        <div class="flex gap-2 bg-gray-100/50 p-1 rounded-xl">
            <template x-for="tab in tabs" :key="tab.id">
                <button @click="activeTab = tab.id; $nextTick(() => $dispatch('tab-' + tab.id))"
                    :class="activeTab === tab.id ? 'bg-white text-primary shadow-sm ring-1 ring-black/5' : 'text-gray-500 hover:text-gray-700'"
                    class="px-4 py-2 rounded-lg text-sm font-bold transition-all flex items-center gap-2">
                    <span x-text="tab.icon"></span>
                    <span x-text="tab.name"></span>
                </button>
            </template>
        </div>
    </div>

    <form hx-post="/api/settings" hx-target="#save-result" hx-swap="innerHTML" class="relative">
        <!-- Download Tab -->
        <div x-show="activeTab === 'download'" x-transition class="space-y-6">
            <div class="glass-panel p-8">
                <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <span class="w-2 h-6 bg-primary rounded-full"></span>
                    qBittorrent è®¾ç½®
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-1.5">
                        <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">Web UI åœ°å€</label>
                        <input type="text" name="qb_url" value='{{ index .Config "qb_url" }}'
                            class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-primary focus:ring-4 focus:ring-primary/10 outline-none transition-all font-medium"
                            placeholder="http://localhost:8080">
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">ä¸‹è½½ä¿å­˜ç›®å½•</label>
                        <input type="text" name="base_download_dir" value='{{ index .Config "base_download_dir" }}'
                            class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-primary focus:ring-4 focus:ring-primary/10 outline-none transition-all font-medium"
                            placeholder="/downloads/anime">
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">ç”¨æˆ·å</label>
                        <input type="text" name="qb_username" value='{{ index .Config "qb_username" }}'
                            class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-primary focus:ring-4 focus:ring-primary/10 outline-none transition-all font-medium">
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">å¯†ç </label>
                        <div class="relative" x-data="{ show: false }">
                            <input :type="show ? 'text' : 'password'" name="qb_password"
                                value='{{ index .Config "qb_password" }}'
                                class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-primary focus:ring-4 focus:ring-primary/10 outline-none transition-all font-medium pr-12">
                            <button type="button" @click="show = !show"
                                class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                <span x-text="show ? 'ğŸ™ˆ' : 'ğŸ‘ï¸'"></span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="relative">
                    <div id="qb-status" class="mt-6 p-4 rounded-xl bg-gray-50/50 border border-gray-100 min-h-[50px]"
                        hx-get="/api/settings/qb-status" hx-trigger="revealed" hx-target="this" hx-swap="innerHTML">
                        <span class="text-sm text-gray-400 flex items-center gap-2">
                            <span class="animate-spin text-xs">âŒ›</span> ç­‰å¾…æ£€æŸ¥...
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Metadata Tab -->
        <div x-show="activeTab === 'metadata'" x-transition x-cloak class="space-y-6">
            <div class="glass-panel p-8">
                <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <span class="w-2 h-6 bg-pink-400 rounded-full"></span>
                    Bangumi é›†æˆ
                </h3>
                <div class="space-y-4">
                    <div class="space-y-1.5" x-data="{ show: false }">
                        <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">Access
                            Token</label>
                        <div class="relative">
                            <input :type="show ? 'text' : 'password'" name="bangumi_access_token"
                                value='{{ index .Config "bangumi_access_token" }}'
                                class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-pink-300 focus:ring-4 focus:ring-pink-500/10 outline-none transition-all font-medium pr-12"
                                placeholder="Personal Access Token">
                            <button type="button" @click="show = !show"
                                class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                <span x-text="show ? 'ğŸ™ˆ' : 'ğŸ‘ï¸'"></span>
                            </button>
                        </div>
                    </div>
                    <div class="relative">
                        <div id="bangumi-status" hx-get="/api/bangumi/profile" hx-trigger="revealed" hx-target="this"
                            hx-swap="innerHTML"
                            class="p-4 rounded-xl bg-pink-50/30 border border-pink-100/50 min-h-[60px]">
                            <span class="text-xs text-gray-400">ç­‰å¾…åŠ è½½ Bangumi çŠ¶æ€...</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-panel p-8">
                <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <span class="w-2 h-6 bg-blue-400 rounded-full"></span>
                    The Movie Database (TMDB)
                </h3>
                <div class="space-y-4">
                    <div class="space-y-1.5" x-data="{ show: false }">
                        <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">API Key (v4
                            Token)</label>
                        <div class="relative">
                            <input :type="show ? 'text' : 'password'" name="tmdb_token"
                                value='{{ index .Config "tmdb_token" }}'
                                class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-blue-300 focus:ring-4 focus:ring-blue-500/10 outline-none transition-all font-medium pr-12">
                            <button type="button" @click="show = !show"
                                class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                <span x-text="show ? 'ğŸ™ˆ' : 'ğŸ‘ï¸'"></span>
                            </button>
                        </div>
                    </div>
                    <div class="relative">
                        <div id="tmdb-status" hx-get="/api/settings/tmdb-status" hx-trigger="revealed" hx-target="this"
                            hx-swap="innerHTML"
                            class="p-4 rounded-xl bg-blue-50/30 border border-blue-100/50 min-h-[50px]">
                            <span class="text-xs text-gray-400">ç­‰å¾…åŠ è½½ TMDB çŠ¶æ€...</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-panel p-8">
                <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <span class="w-2 h-6 bg-cyan-400 rounded-full"></span>
                    AniList é›†æˆ
                </h3>
                <div class="space-y-6">
                    <div class="space-y-4">
                        <div class="space-y-1.5">
                            <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">æ­¥éª¤ 1: Client
                                ID</label>
                            <div class="flex gap-3">
                                <input type="text" id="anilist_client_id"
                                    class="flex-1 px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-cyan-300 focus:ring-4 focus:ring-cyan-500/10 outline-none transition-all font-medium"
                                    placeholder="ä¾‹å¦‚: 12345">
                                <button type="button" onclick="openAniListAuth()"
                                    class="bg-cyan-500 text-white px-6 py-3 rounded-2xl font-bold hover:bg-cyan-600 transition-all shadow-lg active:scale-95 whitespace-nowrap">
                                    ğŸ”— è·å– Token
                                </button>
                            </div>
                        </div>

                        <div class="space-y-1.5" x-data="{ show: false }">
                            <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">æ­¥éª¤ 2: Access
                                Token</label>
                            <div class="relative">
                                <input :type="show ? 'text' : 'password'" id="anilist_token_input" name="anilist_token"
                                    value='{{ index .Config "anilist_token" }}'
                                    class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-cyan-300 focus:ring-4 focus:ring-cyan-500/10 outline-none transition-all font-medium pr-12"
                                    placeholder="ç²˜è´´è·å–åˆ°çš„ Token">
                                <button type="button" @click="show = !show"
                                    class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                    <span x-text="show ? 'ğŸ™ˆ' : 'ğŸ‘ï¸'"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="relative">
                        <div id="anilist-status" hx-get="/api/settings/anilist-status" hx-trigger="revealed"
                            hx-target="this" hx-swap="innerHTML"
                            class="p-4 rounded-xl bg-cyan-50/30 border border-cyan-100/50 min-h-[50px]">
                            <span class="text-xs text-gray-400">ç­‰å¾…åŠ è½½ AniList çŠ¶æ€...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Media Tab -->
        <div x-show="activeTab === 'media'" x-transition x-cloak class="space-y-6">
            <div class="glass-panel p-8">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <span class="w-2 h-6 bg-orange-400 rounded-full"></span>
                        Jellyfin ç®¡ç†
                    </h3>
                    <button type="button" onclick="openJellyfin()"
                        class="text-sm font-bold text-orange-600 hover:text-orange-700 hover:underline flex items-center gap-1.5">
                        <span>ğŸ”— æ‰“å¼€æ§åˆ¶å°</span>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-1.5">
                        <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">æœåŠ¡å™¨
                            URL</label>
                        <input type="text" id="jellyfin_url_input" name="jellyfin_url"
                            value='{{ index .Config "jellyfin_url" }}'
                            class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-orange-300 focus:ring-4 focus:ring-orange-500/10 outline-none transition-all font-medium">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-1.5">
                            <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">ç”¨æˆ·å</label>
                            <input type="text" name="jellyfin_username" value='{{ index .Config "jellyfin_username" }}'
                                class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-orange-300 focus:ring-4 focus:ring-orange-500/10 outline-none transition-all font-medium"
                                placeholder="é»˜è®¤ä¸º admin">
                        </div>
                        <div class="space-y-1.5" x-data="{ show: false }">
                            <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">å¯†ç </label>
                            <div class="relative">
                                <input :type="show ? 'text' : 'password'" name="jellyfin_password"
                                    value='{{ index .Config "jellyfin_password" }}'
                                    class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-orange-300 focus:ring-4 focus:ring-orange-500/10 outline-none transition-all font-medium pr-12"
                                    placeholder="é»˜è®¤ä¸º admin">
                                <button type="button" @click="show = !show"
                                    class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                    <span x-text="show ? 'ğŸ™ˆ' : 'ğŸ‘ï¸'"></span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-1.5 opacity-75">
                        <label
                            class="text-xs font-bold text-gray-400 uppercase tracking-wider ml-1 flex items-center gap-2">
                            <span>API å¯†é’¥ (è‡ªåŠ¨ç”Ÿæˆ)</span>
                        </label>
                        <div class="relative">
                            <input type="text" name="jellyfin_api_key" value='{{ index .Config "jellyfin_api_key" }}'
                                readonly
                                class="w-full px-5 py-2 rounded-xl bg-gray-50 border border-gray-200 text-gray-500 text-sm font-mono focus:outline-none cursor-not-allowed">
                        </div>
                    </div>
                </div>
                <div class="relative">
                    <div id="jellyfin-status" hx-get="/api/settings/jellyfin-status" hx-trigger="revealed"
                        hx-target="this" hx-swap="innerHTML"
                        class="mt-6 p-4 rounded-xl bg-orange-50/30 border border-orange-100/50 min-h-[50px]">
                        <span class="text-xs text-gray-400">ç­‰å¾…åŠ è½½ Jellyfin çŠ¶æ€...</span>
                    </div>
                </div>
            </div>

            <div class="glass-panel p-8">
                <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <span class="w-2 h-6 bg-purple-400 rounded-full"></span>
                    PikPak é›†æˆ (Via AList)
                </h3>
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-1.5">
                            <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">ç”¨æˆ·å</label>
                            <input type="text" name="pikpak_username" value='{{ index .Config "pikpak_username" }}'
                                class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-purple-300 focus:ring-4 focus:ring-purple-500/10 outline-none transition-all font-medium"
                                placeholder="PikPak ç”¨æˆ·å">
                        </div>
                        <div class="space-y-1.5" x-data="{ show: false }">
                            <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">å¯†ç </label>
                            <div class="relative">
                                <input :type="show ? 'text' : 'password'" name="pikpak_password"
                                    value='{{ index .Config "pikpak_password" }}'
                                    class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-purple-300 focus:ring-4 focus:ring-purple-500/10 outline-none transition-all font-medium pr-12"
                                    placeholder="PikPak å¯†ç ">
                                <button type="button" @click="show = !show"
                                    class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                    <span x-text="show ? 'ğŸ™ˆ' : 'ğŸ‘ï¸'"></span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-1.5" x-data="{ show: false }">
                        <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">Refresh
                            Token
                            (æ¨è)</label>
                        <div class="relative">
                            <input :type="show ? 'text' : 'password'" id="pikpak_refresh_token_input"
                                name="pikpak_refresh_token" value='{{ index .Config "pikpak_refresh_token" }}'
                                class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-purple-300 focus:ring-4 focus:ring-purple-500/10 outline-none transition-all font-medium pr-12"
                                placeholder="é‡åˆ° Captcha é”™è¯¯æ—¶å¡«å†™">
                            <button type="button" @click="show = !show"
                                class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                <span x-text="show ? 'ğŸ™ˆ' : 'ğŸ‘ï¸'"></span>
                            </button>
                        </div>
                    </div>

                    <div class="space-y-1.5" x-data="{ show: false }">
                        <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">éªŒè¯ç 
                            Token (Captcha
                            Token)</label>
                        <div class="relative">
                            <input :type="show ? 'text' : 'password'" name="pikpak_captcha_token"
                                class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-purple-300 focus:ring-4 focus:ring-purple-500/10 outline-none transition-all font-medium pr-12"
                                placeholder="å¦‚æœ Alist æŠ¥é”™ 'captcha_token expired'ï¼Œè¯·åœ¨æ­¤å¡«å†™">
                            <button type="button" @click="show = !show"
                                class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                <span x-text="show ? 'ğŸ™ˆ' : 'ğŸ‘ï¸'"></span>
                            </button>
                        </div>
                        <p class="text-xs text-gray-400 ml-1">ä»æµè§ˆå™¨æ§åˆ¶å°è·å–ï¼Œæˆ–åœ¨ Alist ç½‘é¡µç‰ˆç™»å½•åæŠ“åŒ…è·å–ã€‚</p>
                    </div>

                    <div
                        class="flex items-center justify-between gap-4 p-4 rounded-xl bg-purple-50/30 border border-purple-100/50">
                        <div class="relative flex-1">
                            <div id="pikpak-status" hx-get="/api/settings/pikpak-status" hx-trigger="revealed"
                                hx-target="this" hx-swap="innerHTML" class="text-sm font-medium text-purple-700">
                                ç­‰å¾…æ£€æŸ¥...
                            </div>
                        </div>
                        <button type="button" hx-post="/api/settings/pikpak-sync" hx-target="#pikpak-sync-status"
                            class="bg-purple-600 text-white px-6 py-2.5 rounded-xl font-bold hover:bg-purple-700 transition-all shadow-md active:scale-95 flex items-center gap-2">
                            <span class="htmx-indicator animate-spin text-xs">âŒ›</span>
                            <span>ğŸ’¾ ä¿å­˜å¹¶åŒæ­¥</span>
                        </button>
                    </div>
                    <div id="pikpak-sync-status" class="text-xs font-bold text-purple-400 text-right mt-1">
                    </div>

                    <!-- Token Guide -->
                    <div
                        class="mt-4 p-4 rounded-xl bg-purple-50/50 border border-purple-100/50 text-sm text-purple-900 space-y-3">
                        <h4 class="font-bold flex items-center gap-2">ğŸ“š å¦‚ä½•è·å– Token?</h4>
                        <ul class="list-disc list-inside space-y-1.5 opacity-90 text-xs">
                            <li>
                                <span class="font-bold">Refresh Token (æ¨è):</span>
                                ç™»å½• <a href="https://mypikpak.com" target="_blank"
                                    class="underline hover:text-purple-600 font-bold">PikPak ç½‘é¡µç‰ˆ</a>ï¼ŒæŒ‰ F12
                                æ‰“å¼€å¼€å‘è€…å·¥å…· â†’
                                Application (åº”ç”¨) â†’ Local Storage â†’ æ‰¾åˆ° <code
                                    class="bg-purple-100 px-1 rounded">refresh_token</code>ã€‚
                            </li>
                            <li>
                                <span class="font-bold">Captcha Token:</span>
                                ä»…åœ¨ Alist æŠ¥é”™ <code
                                    class="bg-red-50 text-red-600 px-1 rounded">captcha_token expired</code>
                                æ—¶éœ€è¦ã€‚
                                <a href="https://alist.nn.ci/zh/guide/drivers/pikpak.html" target="_blank"
                                    class="underline hover:text-purple-600 font-bold">ğŸ‘‰ æŸ¥çœ‹ Alist å®˜æ–¹æ–‡æ¡£</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Network Tab -->
        <div x-show="activeTab === 'network'" x-transition x-cloak class="space-y-6">
            <div class="glass-panel p-8">
                <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <span class="w-2 h-6 bg-indigo-400 rounded-full"></span>
                    ä»£ç†é…ç½®
                </h3>
                <div class="space-y-6">
                    <div class="space-y-1.5">
                        <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">HTTP
                            ä»£ç†åœ°å€</label>
                        <input type="text" name="proxy_url" value='{{ index .Config "proxy_url" }}'
                            class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-indigo-300 focus:ring-4 focus:ring-indigo-500/10 outline-none transition-all font-medium"
                            placeholder="http://127.0.0.1:7890">
                    </div>
                    <div class="flex flex-wrap gap-4">
                        <label
                            class="flex items-center gap-3 bg-white/60 px-4 py-2 rounded-xl border border-white/60 cursor-pointer shadow-sm hover:shadow-md transition-all">
                            <input type="checkbox" name="proxy_bangumi_enabled" value="true"
                                class="w-4 h-4 accent-indigo-500" {{ if eq (index .Config "proxy_bangumi_enabled"
                                ) "true" }}checked{{ end }}>
                            <span class="text-sm font-bold text-gray-700">Bangumi ä½¿ç”¨ä»£ç†</span>
                        </label>
                        <label
                            class="flex items-center gap-3 bg-white/60 px-4 py-2 rounded-xl border border-white/60 cursor-pointer shadow-sm hover:shadow-md transition-all">
                            <input type="checkbox" name="proxy_tmdb_enabled" value="true"
                                class="w-4 h-4 accent-indigo-500" {{ if eq (index .Config "proxy_tmdb_enabled" ) "true"
                                }}checked{{ end }}>
                            <span class="text-sm font-bold text-gray-700">TMDB ä½¿ç”¨ä»£ç†</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Tab -->
        <div x-show="activeTab === 'security'" x-transition x-cloak class="space-y-6">
            <div class="glass-panel p-8" x-data="{
                        oldPwd: '', newPwd: '', confirmPwd: '', loading: false,
                        async submit() {
                            if (this.newPwd !== this.confirmPwd) {
                                window.dispatchEvent(new CustomEvent('toast', { detail: { msg: 'æ–°å¯†ç ä¸ä¸€è‡´', type: 'error' } }));
                                return;
                            }
                            this.loading = true;
                            try {
                                const res = await fetch('/api/change-password', {
                                    method: 'POST',
                                    headers: {'Content-Type': 'application/json'},
                                    body: JSON.stringify({ old_password: this.oldPwd, new_password: this.newPwd })
                                });
                                const data = await res.json();
                                if (res.ok) {
                                    window.dispatchEvent(new CustomEvent('toast', { detail: { msg: 'å¯†ç å·²æ›´æ–°', type: 'success' } }));
                                    this.oldPwd = ''; this.newPwd = ''; this.confirmPwd = '';
                                } else {
                                    window.dispatchEvent(new CustomEvent('toast', { detail: { msg: data.error || 'æ›´æ–°å¤±è´¥', type: 'error' } }));
                                }
                            } catch (e) { console.error(e); }
                            finally { this.loading = false; }
                        }
                    }">
                <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <span class="w-2 h-6 bg-gray-800 rounded-full"></span>
                    æ›´æ¢å¯†ç 
                </h3>
                <div class="max-w-md space-y-4">
                    <input type="password" x-model="oldPwd" placeholder="å½“å‰å¯†ç "
                        class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 outline-none font-medium">
                    <input type="password" x-model="newPwd" placeholder="æ–°å¯†ç "
                        class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 outline-none font-medium">
                    <input type="password" x-model="confirmPwd" placeholder="ç¡®è®¤æ–°å¯†ç "
                        class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 outline-none font-medium">
                    <button type="button" @click="submit" :disabled="loading"
                        class="w-full bg-gray-800 text-white py-3 rounded-2xl font-bold hover:bg-black transition-all shadow-xl active:scale-95 disabled:opacity-50">
                        <span x-show="!loading">æ›´æ–°å®‰å…¨å‡­è¯</span>
                        <span x-show="loading">ä¼˜åŒ–ä¸­...</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Global Save FAB -->
        <div class="fixed bottom-10 right-10 z-[40]">
            <button type="submit" id="save-settings-btn"
                class="bg-primary text-white p-6 rounded-full hover:bg-accent transition-all shadow-[0_15px_30px_-5px_rgba(255,182,193,0.5)] active:scale-90 flex items-center gap-3 group relative overflow-hidden"
                hx-indicator="#save-settings-btn">
                <span class="text-2xl [.htmx-request_&]:hidden">ğŸ’¾</span>
                <span class="hidden [.htmx-request_&]:inline animate-spin text-2xl">âŒ›</span>
                <span
                    class="max-w-0 overflow-hidden group-hover:max-w-xs transition-all duration-500 font-black uppercase tracking-widest text-sm whitespace-nowrap">ä¿å­˜å¹¶åŒæ­¥æ‰€æœ‰é…ç½®</span>
            </button>
        </div>
    </form>

    <div id="save-result" class="hidden"></div>

    <script>
        const jellyfinServerId = '{{.JellyfinServerID}}';

        function openAniListAuth() {
            const clientId = document.getElementById('anilist_client_id').value;
            if (!clientId) {
                alert('è¯·å…ˆè¾“å…¥ Client ID');
                return;
            }
            const url = `https://anilist.co/api/v2/oauth/authorize?client_id=${clientId}&response_type=token`;
            window.open(url, '_blank');
        }

        function openJellyfin() {
            let url = document.getElementById('jellyfin_url_input').value;
            if (!url) {
                console.error('è¯·å…ˆè¾“å…¥ Jellyfin URL');
                return;
            }
            url = url.replace(/\/$/, '');
            let targetUrl = url;
            if (jellyfinServerId) {
                targetUrl = url + "/web/index.html?serverId=" + jellyfinServerId;
            }
            window.open(targetUrl, '_blank');
        }
    </script>
</div>

<style>
    [x-cloak] {
        display: none !important;
    }

    .htmx-indicator {
        opacity: 0;
        pointer-events: none;
        transition: opacity 200ms ease-in;
    }

    .htmx-indicator.htmx-request {
        opacity: 1;
        pointer-events: auto;
    }
</style>
{{ if not .SkipLayout }}{{ template "footer.html" . }}{{ end }}
```