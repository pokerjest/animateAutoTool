{{ if not .SkipLayout }}{{ template "header.html" . }}{{ end }}

<div class="space-y-6" x-data="{ 
    activeTab: 'download',
    tabs: [
        { id: 'download', name: 'ä¸‹è½½ç®¡ç†', icon: 'ğŸ“¥' },
        { id: 'metadata', name: 'æ•°æ®æº', icon: 'ğŸ·ï¸' },
        { id: 'media', name: 'åª’ä½“/åŒæ­¥', icon: 'ğŸ¬' },
        { id: 'network', name: 'ç½‘ç»œ', icon: 'ğŸŒ' },
        { id: 'backup', name: 'å¤‡ä»½è¿˜åŸ', icon: 'ğŸ“¦' },
        { id: 'security', name: 'è´¦æˆ·å®‰å…¨', icon: 'ğŸ”' }
    ]
}">
    <div class="flex items-end justify-between border-b border-gray-200/50 pb-4">
        <h2 class="text-3xl font-black text-gray-800 tracking-tight">ç³»ç»Ÿè®¾ç½®</h2>
        <div class="flex gap-2 bg-gray-100/50 p-1 rounded-xl">
            <template x-for="tab in tabs" :key="tab.id">
                <button @click="activeTab = tab.id; $nextTick(() => $dispatch('tab-' + tab.id))"
                    :class="activeTab === tab.id ? 'bg-white text-primary shadow-sm ring-1 ring-black/5' : 'text-gray-500 hover:text-gray-700'"
                    class="px-4 py-2 rounded-lg text-sm font-bold transition-all flex items-center gap-2">
                    <span x-text="tab.icon"></span>
                    <span x-text="tab.name"></span>
                </button>
            </template>
        </div>
    </div>

    <div id="save-result" class="hidden"></div>

    <!-- Download Tab -->
    <div x-show="activeTab === 'download'" x-transition class="space-y-6">
        <form hx-post="/api/settings" hx-target="#save-result" hx-swap="innerHTML">
            <input type="hidden" name="settings_scope" value="download">
            <div class="glass-panel p-8">
                <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <span class="w-2 h-6 bg-primary rounded-full"></span>
                    qBittorrent è®¾ç½®
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-1.5">
                        <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">Web UI åœ°å€</label>
                        <input type="text" name="qb_url" value='{{ index .Config "qb_url" }}'
                            class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-primary focus:ring-4 focus:ring-primary/10 outline-none transition-all font-medium"
                            placeholder="http://localhost:8080">
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">ä¸‹è½½ä¿å­˜ç›®å½•</label>
                        <input type="text" name="base_download_dir" value='{{ index .Config "base_download_dir" }}'
                            class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-primary focus:ring-4 focus:ring-primary/10 outline-none transition-all font-medium"
                            placeholder="/downloads/anime">
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">ç”¨æˆ·å</label>
                        <input type="text" name="qb_username" value='{{ index .Config "qb_username" }}'
                            class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-primary focus:ring-4 focus:ring-primary/10 outline-none transition-all font-medium">
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">å¯†ç </label>
                        <div class="relative" x-data="{ show: false }">
                            <input :type="show ? 'text' : 'password'" name="qb_password"
                                value='{{ index .Config "qb_password" }}'
                                class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-primary focus:ring-4 focus:ring-primary/10 outline-none transition-all font-medium pr-12">
                            <button type="button" @click="show = !show"
                                class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                <span x-text="show ? 'ğŸ™ˆ' : 'ğŸ‘ï¸'"></span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="relative">
                    <div id="qb-status"
                        class="mt-6 p-4 rounded-xl bg-gray-50/50 border border-gray-100 min-h-[50px] relative group"
                        hx-get="/api/settings/qb-status" hx-trigger="revealed, load delay:500ms" hx-target="this"
                        hx-swap="innerHTML">
                        <span class="text-sm text-gray-400 flex items-center gap-2">
                            <span class="animate-spin text-xs">âŒ›</span> ç­‰å¾…æ£€æŸ¥...
                        </span>
                        <button type="button" hx-get="/api/settings/qb-status" hx-target="#qb-status"
                            hx-indicator="#qb-status"
                            class="absolute right-2 top-2 p-1.5 text-gray-400 hover:text-primary hover:bg-white rounded-lg opacity-0 group-hover:opacity-100 transition-all"
                            title="åˆ·æ–°çŠ¶æ€">
                            ğŸ”„
                        </button>
                    </div>
                </div>

                <!-- Save Button for Download Tab -->
                <div class="mt-6 flex justify-end">
                    <button type="submit"
                        class="bg-primary text-white px-8 py-3 rounded-xl font-bold hover:bg-accent transition-all shadow-lg active:scale-95 flex items-center gap-2">
                        <span class="[.htmx-request_&]:hidden">ğŸ’¾ ä¿å­˜æ›´æ”¹</span>
                        <span class="hidden [.htmx-request_&]:inline animate-spin">âŒ›</span>
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Metadata Tab -->
    <div x-show="activeTab === 'metadata'" x-transition x-cloak class="space-y-6">
        <form hx-post="/api/settings" hx-target="#save-result" hx-swap="innerHTML">
            <input type="hidden" name="settings_scope" value="data-sources">
            <div class="glass-panel p-8 space-y-8">

                <!-- Bangumi Section -->
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <span class="w-2 h-6 bg-pink-400 rounded-full"></span>
                        Bangumi (ä¸»æ•°æ®æº)
                    </h3>
                    <div class="space-y-4">
                        <div class="space-y-1.5 mb-4">
                            <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">Access Token
                                (æ‰‹åŠ¨å¡«å…¥)</label>
                            <input type="password" name="bangumi_access_token"
                                value='{{ index .Config "bangumi_access_token" }}'
                                class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-pink-300 focus:ring-4 focus:ring-pink-500/10 outline-none transition-all font-medium"
                                placeholder="å¦‚æœå·²æœ‰ Access Token å¯ç›´æ¥åœ¨æ­¤å¡«å…¥ï¼Œæ— éœ€ App ID">
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-1.5">
                                <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">App
                                    ID</label>
                                <input type="text" name="bangumi_app_id" value='{{ index .Config "bangumi_app_id" }}'
                                    class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-pink-300 focus:ring-4 focus:ring-pink-500/10 outline-none transition-all font-medium"
                                    placeholder="Bangumi App ID">
                            </div>
                            <div class="space-y-1.5">
                                <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">App
                                    Secret</label>
                                <input type="password" name="bangumi_app_secret"
                                    value='{{ index .Config "bangumi_app_secret" }}'
                                    class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-pink-300 focus:ring-4 focus:ring-pink-500/10 outline-none transition-all font-medium"
                                    placeholder="Bangumi App Secret">
                            </div>
                        </div>

                        <div class="flex items-center gap-4">
                            <div id="bangumi-status" hx-get="/api/bangumi/profile"
                                hx-trigger="intersect once, tab-metadata from:body" hx-target="#bangumi-status"
                                hx-swap="innerHTML"
                                class="flex-grow p-4 rounded-xl bg-pink-50/30 border border-pink-100/50 min-h-[50px] relative group px-4">
                                <span class="text-xs text-gray-400 flex items-center gap-2">
                                    <span class="animate-spin">âŒ›</span> ç­‰å¾…åŠ è½½ Bangumi çŠ¶æ€...
                                </span>
                                <button type="button" hx-get="/api/bangumi/profile" hx-target="#bangumi-status"
                                    hx-swap="innerHTML"
                                    class="absolute right-2 top-2 p-1.5 text-pink-300 hover:text-pink-500 hover:bg-white rounded-lg opacity-0 group-hover:opacity-100 transition-all"
                                    title="åˆ·æ–°çŠ¶æ€">
                                    ğŸ”„
                                </button>
                            </div>
                            <a href="/api/bangumi/login" target="_blank"
                                class="px-6 py-3 bg-pink-500 text-white rounded-xl font-bold hover:bg-pink-600 transition-all shadow-lg shadow-pink-200/50 flex items-center gap-2 whitespace-nowrap">
                                ğŸš€ ç™»å½•/æˆæƒ
                            </a>
                        </div>
                        <p class="text-xs text-gray-400 ml-1">æ³¨ï¼šå¦‚æœå¡«å†™äº† Tokenï¼Œå¯å¿½ç•¥ App ID/Secret å’Œç™»å½•æŒ‰é’®ã€‚</p>
                    </div>
                </div>

                <hr class="border-gray-200/50">

                <!-- TMDB Section -->
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <span class="w-2 h-6 bg-blue-400 rounded-full"></span>
                        TMDB (å…ƒæ•°æ®å¢å¼º)
                    </h3>
                    <div class="space-y-4">
                        <div class="space-y-1.5" x-data="{ show: false }">
                            <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">API Read Access
                                Token</label>
                            <div class="relative">
                                <input :type="show ? 'text' : 'password'" name="tmdb_token"
                                    value='{{ index .Config "tmdb_token" }}'
                                    class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-blue-300 focus:ring-4 focus:ring-blue-500/10 outline-none transition-all font-medium pr-12"
                                    placeholder="eyJhbGciOiJIUzI1Ni...">
                                <button type="button" @click="show = !show"
                                    class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                    <span x-text="show ? 'ğŸ™ˆ' : 'ğŸ‘ï¸'"></span>
                                </button>
                            </div>
                        </div>
                        <div id="tmdb-status" hx-get="/api/settings/tmdb-status"
                            hx-trigger="intersect once, tab-metadata from:body" hx-target="#tmdb-status"
                            hx-swap="innerHTML"
                            class="p-4 rounded-xl bg-blue-50/30 border border-blue-100/50 min-h-[50px] relative group">
                            <span class="text-xs text-gray-400 flex items-center gap-2">
                                <span class="animate-spin">âŒ›</span> ç­‰å¾…åŠ è½½ TMDB çŠ¶æ€...
                            </span>
                            <button type="button" hx-get="/api/settings/tmdb-status" hx-target="#tmdb-status"
                                hx-swap="innerHTML"
                                class="absolute right-2 top-2 p-1.5 text-blue-300 hover:text-blue-500 hover:bg-white rounded-lg opacity-0 group-hover:opacity-100 transition-all"
                                title="åˆ·æ–°çŠ¶æ€">
                                ğŸ”„
                            </button>
                        </div>
                    </div>
                </div>

                <hr class="border-gray-200/50">

                <!-- AniList Section -->
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <span class="w-2 h-6 bg-cyan-400 rounded-full"></span>
                        AniList (å¤‡ç”¨æ•°æ®æº)
                    </h3>
                    <div class="space-y-4">
                        <div class="space-y-1.5" x-data="{ show: false }">
                            <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">Personal Access
                                Token</label>
                            <div class="relative">
                                <input :type="show ? 'text' : 'password'" name="anilist_token"
                                    value='{{ index .Config "anilist_token" }}'
                                    class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-cyan-300 focus:ring-4 focus:ring-cyan-500/10 outline-none transition-all font-medium pr-12"
                                    placeholder="Paste AniList Token Here">
                                <button type="button" @click="show = !show"
                                    class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                    <span x-text="show ? 'ğŸ™ˆ' : 'ğŸ‘ï¸'"></span>
                                </button>
                            </div>
                        </div>
                        <div id="anilist-status" hx-get="/api/settings/anilist-status"
                            hx-trigger="intersect once, tab-metadata from:body" hx-target="#anilist-status"
                            hx-swap="innerHTML"
                            class="p-4 rounded-xl bg-cyan-50/30 border border-cyan-100/50 min-h-[50px] relative group">
                            <span class="text-xs text-gray-400 flex items-center gap-2">
                                <span class="animate-spin">âŒ›</span> ç­‰å¾…åŠ è½½ AniList çŠ¶æ€...
                            </span>
                            <button type="button" hx-get="/api/settings/anilist-status" hx-target="#anilist-status"
                                hx-swap="innerHTML"
                                class="absolute right-2 top-2 p-1.5 text-cyan-300 hover:text-cyan-500 hover:bg-white rounded-lg opacity-0 group-hover:opacity-100 transition-all"
                                title="åˆ·æ–°çŠ¶æ€">
                                ğŸ”„
                            </button>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Data Sources Save Button -->
            <div class="mt-6 flex justify-end">
                <button type="submit"
                    class="bg-pink-500 text-white px-8 py-3 rounded-xl font-bold hover:bg-pink-600 transition-all shadow-lg shadow-pink-200 active:scale-95 flex items-center gap-2">
                    <span class="[.htmx-request_&]:hidden">ğŸ’¾ ä¿å­˜æ•°æ®æºè®¾ç½®</span>
                    <span class="hidden [.htmx-request_&]:inline animate-spin">âŒ›</span>
                </button>
            </div>
        </form>
    </div>

    <!-- Media & Sync Tab -->
    <div x-show="activeTab === 'media'" x-transition x-cloak class="space-y-6">

        <!-- Jellyfin Config Form -->
        <form hx-post="/api/settings" hx-target="#save-result" hx-swap="innerHTML">
            <input type="hidden" name="settings_scope" value="media">
            <div class="glass-panel p-8">
                <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <span class="w-2 h-6 bg-purple-400 rounded-full"></span>
                    Jellyfin é›†æˆ
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-1.5">
                        <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">æœåŠ¡å™¨åœ°å€</label>
                        <div class="flex gap-2">
                            <input type="text" id="jellyfin_url_input" name="jellyfin_url"
                                value='{{ index .Config "jellyfin_url" }}'
                                class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-purple-300 focus:ring-4 focus:ring-purple-500/10 outline-none transition-all font-medium"
                                placeholder="http://localhost:8096">
                            <button type="button" onclick="openJellyfin()"
                                class="bg-gray-100 text-gray-600 px-4 rounded-xl hover:bg-gray-200 transition">â†—</button>
                        </div>
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">API Key</label>
                        <input type="text" name="jellyfin_api_key" value='{{ index .Config "jellyfin_api_key" }}'
                            class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-purple-300 focus:ring-4 focus:ring-purple-500/10 outline-none transition-all font-medium"
                            placeholder="ç•™ç©ºåˆ™è‡ªåŠ¨è·å–">
                    </div>

                    <!-- New Username/Password Fields -->
                    <div class="space-y-1.5">
                        <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">ç”¨æˆ·å</label>
                        <input type="text" name="jellyfin_username" value='{{ index .Config "jellyfin_username" }}'
                            class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-purple-300 focus:ring-4 focus:ring-purple-500/10 outline-none transition-all font-medium"
                            placeholder="Admin User">
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">å¯†ç </label>
                        <div class="relative" x-data="{ show: false }">
                            <input :type="show ? 'text' : 'password'" name="jellyfin_password"
                                value='{{ index .Config "jellyfin_password" }}'
                                class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-purple-300 focus:ring-4 focus:ring-purple-500/10 outline-none transition-all font-medium pr-12">
                            <button type="button" @click="show = !show"
                                class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                <span x-text="show ? 'ğŸ™ˆ' : 'ğŸ‘ï¸'"></span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Jellyfin Save Button -->
                <div class="mt-6 flex justify-end">
                    <button type="submit"
                        class="bg-purple-500 text-white px-6 py-2 rounded-xl font-bold hover:bg-purple-600 transition-all shadow-md active:scale-95 flex items-center gap-2">
                        <span class="[.htmx-request_&]:hidden">ğŸ’¾ ä¿å­˜ Jellyfin è®¾ç½®</span>
                        <span class="hidden [.htmx-request_&]:inline animate-spin">âŒ›</span>
                    </button>
                </div>

                <div class="relative mt-4">
                    <div id="jellyfin-status" hx-get="/api/settings/jellyfin-status"
                        hx-trigger="revealed, load delay:500ms" hx-target="this"
                        class="p-4 rounded-xl bg-purple-50/50 border border-purple-100 min-h-[50px] relative group">
                        <span class="text-sm text-purple-400 flex items-center gap-2">
                            <span class="animate-spin text-xs">âŒ›</span> æ£€æŸ¥è¿æ¥...
                        </span>
                        <button type="button" hx-get="/api/settings/jellyfin-status" hx-target="#jellyfin-status"
                            class="absolute right-2 top-2 p-1.5 text-purple-300 hover:text-purple-500 hover:bg-white rounded-lg opacity-0 group-hover:opacity-100 transition-all"
                            title="åˆ·æ–°çŠ¶æ€">
                            ğŸ”„
                        </button>
                    </div>
                </div>
            </div>
        </form>

        <!-- PikPak Config Form -->
        <form hx-post="/api/settings" hx-target="#save-result" hx-swap="innerHTML">
            <input type="hidden" name="settings_scope" value="pikpak">
            <div class="glass-panel p-8">
                <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <span class="w-2 h-6 bg-purple-600 rounded-full"></span>
                    PikPak & AList
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-1.5">
                        <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">PikPak ç”¨æˆ·å</label>
                        <input type="text" name="pikpak_username" value='{{ index .Config "pikpak_username" }}'
                            class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-purple-300 focus:ring-4 focus:ring-purple-500/10 outline-none transition-all font-medium">
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">PikPak å¯†ç </label>
                        <div class="relative" x-data="{ show: false }">
                            <input :type="show ? 'text' : 'password'" name="pikpak_password"
                                value='{{ index .Config "pikpak_password" }}'
                                class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-purple-300 focus:ring-4 focus:ring-purple-500/10 outline-none transition-all font-medium pr-12">
                            <button type="button" @click="show = !show"
                                class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                <span x-text="show ? 'ğŸ™ˆ' : 'ğŸ‘ï¸'"></span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Separate logic for Tokens which are long -->
                <div class="mt-4 space-y-4">
                    <div class="space-y-1.5">
                        <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">Refresh Token (å¯é€‰,
                            æ¨è)</label>
                        <div class="relative" x-data="{ show: false }">
                            <input :type="show ? 'text' : 'password'" name="pikpak_refresh_token"
                                value='{{ index .Config "pikpak_refresh_token" }}'
                                class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-purple-300 focus:ring-4 focus:ring-purple-500/10 outline-none transition-all font-medium pr-12"
                                placeholder="å¡«å…¥ Refresh Token å¯é¿å…é¢‘ç¹é‡æ–°ç™»å½•">
                            <button type="button" @click="show = !show"
                                class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                <span x-text="show ? 'ğŸ™ˆ' : 'ğŸ‘ï¸'"></span>
                            </button>
                        </div>
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">Captcha Token
                            (éªŒè¯ç æŠ¥é”™æ—¶å¡«)</label>
                        <div class="relative" x-data="{ show: false }">
                            <input :type="show ? 'text' : 'password'" name="pikpak_captcha_token"
                                value='{{ index .Config "pikpak_captcha_token" }}'
                                class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 focus:bg-white focus:border-purple-300 focus:ring-4 focus:ring-purple-500/10 outline-none transition-all font-medium pr-12"
                                placeholder="å¦‚æœ Alist æŠ¥é”™ 'captcha_token expired'ï¼Œè¯·åœ¨æ­¤å¡«å†™">
                            <button type="button" @click="show = !show"
                                class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                <span x-text="show ? 'ğŸ™ˆ' : 'ğŸ‘ï¸'"></span>
                            </button>
                        </div>
                        <p class="text-xs text-gray-400 ml-1">ä»æµè§ˆå™¨æ§åˆ¶å°è·å–ï¼Œæˆ–åœ¨ Alist ç½‘é¡µç‰ˆç™»å½•åæŠ“åŒ…è·å–ã€‚</p>
                    </div>
                </div>

                <div
                    class="flex items-center justify-between gap-4 p-4 rounded-xl bg-purple-50/30 border border-purple-100/50 mt-4">
                    <div class="relative flex-1 group">
                        <div id="pikpak-status" hx-get="/api/settings/pikpak-status"
                            hx-trigger="revealed, load delay:500ms" hx-target="this" hx-swap="innerHTML"
                            class="text-sm font-medium text-purple-700 min-h-[24px]">
                            ç­‰å¾…æ£€æŸ¥...
                        </div>
                        <button type="button" hx-get="/api/settings/pikpak-status" hx-target="#pikpak-status"
                            class="absolute right-0 top-1/2 -translate-y-1/2 p-1 text-purple-300 hover:text-purple-500 rounded-lg opacity-0 group-hover:opacity-100 transition-all"
                            title="åˆ·æ–°çŠ¶æ€">
                            ğŸ”„
                        </button>
                    </div>
                    <div class="flex gap-2">
                        <button type="submit"
                            class="bg-gray-700 text-white px-4 py-2.5 rounded-xl font-bold hover:bg-gray-800 transition-all shadow-md active:scale-95 flex items-center gap-2">
                            <span class="[.htmx-request_&]:hidden">ğŸ’¾ ä»…ä¿å­˜</span>
                            <span class="hidden [.htmx-request_&]:inline animate-spin">âŒ›</span>
                        </button>
                        <button type="button" hx-post="/api/settings/pikpak-sync" hx-target="#pikpak-sync-status"
                            class="bg-purple-600 text-white px-4 py-2.5 rounded-xl font-bold hover:bg-purple-700 transition-all shadow-md active:scale-95 flex items-center gap-2">
                            <span class="htmx-indicator animate-spin text-xs">âŒ›</span>
                            <span>ğŸ”„ ä¿å­˜å¹¶åŒæ­¥</span>
                        </button>
                    </div>
                </div>
                <div id="pikpak-sync-status" class="text-xs font-bold text-purple-400 text-right mt-1">
                </div>

                <!-- Token Guide -->
                <div
                    class="mt-4 p-4 rounded-xl bg-purple-50/50 border border-purple-100/50 text-sm text-purple-900 space-y-3">
                    <h4 class="font-bold flex items-center gap-2">ğŸ“š å¦‚ä½•è·å– Token?</h4>
                    <ul class="list-disc list-inside space-y-1.5 opacity-90 text-xs">
                        <li>
                            <span class="font-bold">Refresh Token (æ¨è):</span>
                            ç™»å½• <a href="https://mypikpak.com" target="_blank"
                                class="underline hover:text-purple-600 font-bold">PikPak ç½‘é¡µç‰ˆ</a>ï¼ŒæŒ‰ F12
                            æ‰“å¼€å¼€å‘è€…å·¥å…· â†’
                            Application (åº”ç”¨) â†’ Local Storage â†’ æ‰¾åˆ° <code
                                class="bg-purple-100 px-1 rounded">refresh_token</code>ã€‚
                        </li>
                        <li>
                            <span class="font-bold">Captcha Token:</span>
                            ä»…åœ¨ Alist æŠ¥é”™ <code class="bg-red-50 text-red-600 px-1 rounded">captcha_token expired</code>
                            æ—¶éœ€è¦ã€‚
                            <a href="https://alist.nn.ci/zh/guide/drivers/pikpak.html" target="_blank"
                                class="underline hover:text-purple-600 font-bold">ğŸ‘‰ æŸ¥çœ‹ Alist å®˜æ–¹æ–‡æ¡£</a>
                        </li>
                    </ul>
                </div>
            </div>
        </form>
    </div>

    <!-- Network Tab -->
    <div x-show="activeTab === 'network'" x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 translate-y-4" x-transition:enter-end="opacity-100 translate-y-0"
        class="space-y-6">

        <form hx-post="/api/settings" hx-target="#save-result" hx-swap="innerHTML">
            <input type="hidden" name="settings_scope" value="network">
            <div class="bg-white/60 p-6 rounded-xl border border-white/70 shadow-sm relative overflow-hidden group">
                <div class="relative z-10">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800 flex items-center gap-2">
                        <span>ğŸŒ</span> ç½‘ç»œè®¾ç½®
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">HTTP/S Proxy URL</label>
                            <input type="text" name="proxy_url" value="{{ .Config.proxy_url }}"
                                placeholder="http://127.0.0.1:7890"
                                class="w-full px-4 py-2 bg-white/50 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-all hover:bg-white/80">
                            <p class="mt-1 text-xs text-gray-500">
                                æ ¼å¼: http://ip:port æˆ– socks5://ip:port. ç•™ç©ºåˆ™ä¸ä½¿ç”¨ä»£ç†ã€‚
                            </p>
                        </div>

                        <!-- Proxy Scope -->
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">åº”ç”¨èŒƒå›´</label>
                            <div class="flex flex-wrap gap-4">
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="proxy_bangumi_enabled" value="true" {{ if eq
                                        .Config.proxy_bangumi_enabled "true" }}checked{{ end }}
                                        class="form-checkbox h-5 w-5 text-primary rounded border-gray-300 focus:ring-primary">
                                    <span class="ml-2 text-gray-700">Bangumi API</span>
                                </label>
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="proxy_tmdb_enabled" value="true" {{ if eq
                                        .Config.proxy_tmdb_enabled "true" }}checked{{ end }}
                                        class="form-checkbox h-5 w-5 text-primary rounded border-gray-300 focus:ring-primary">
                                    <span class="ml-2 text-gray-700">TMDB API</span>
                                </label>
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="proxy_anilist_enabled" value="true" {{ if eq
                                        .Config.proxy_anilist_enabled "true" }}checked{{ end }}
                                        class="form-checkbox h-5 w-5 text-primary rounded border-gray-300 focus:ring-primary">
                                    <span class="ml-2 text-gray-700">AniList API</span>
                                </label>
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="proxy_jellyfin_enabled" value="true" {{ if eq
                                        .Config.proxy_jellyfin_enabled "true" }}checked{{ end }}
                                        class="form-checkbox h-5 w-5 text-primary rounded border-gray-300 focus:ring-primary">
                                    <span class="ml-2 text-gray-700">Jellyfin API</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Network Save Button -->
                    <div class="mt-6 flex justify-end">
                        <button type="submit"
                            class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-blue-700 transition-all shadow-lg shadow-blue-200 active:scale-95 flex items-center gap-2">
                            <span class="[.htmx-request_&]:hidden">ğŸ’¾ ä¿å­˜ç½‘ç»œè®¾ç½®</span>
                            <span class="hidden [.htmx-request_&]:inline animate-spin">âŒ›</span>
                        </button>
                    </div>
                </div>
                <!-- Decor -->
                <div
                    class="absolute -right-6 -bottom-6 text-9xl text-blue-100 opacity-50 group-hover:scale-110 transition duration-500 select-none">
                    ğŸŒ
                </div>
            </div>
        </form>
    </div>

    <!-- Backup Tab -->
    <div x-show="activeTab === 'backup'" x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 translate-y-4" x-transition:enter-end="opacity-100 translate-y-0"
        class="space-y-6">

        <script>
            document.addEventListener('alpine:init', () => {
                Alpine.data('r2Backup', () => ({
                    config: { endpoint: '', access_key: '', secret_key: '', bucket: '' },
                    backups: [],
                    loading: true,

                    init() {
                        this.loadConfig();
                        this.loadBackups();
                    },

                    loadConfig() {
                        fetch('/api/backup/r2/config')
                            .then(r => r.json())
                            .then(data => {
                                this.config = data;
                            });
                    },

                    testMessage: '',
                    testError: false,
                    testConnection() {
                        this.loading = true;
                        this.testMessage = 'æµ‹è¯•ä¸­...';
                        this.testError = false;

                        fetch('/api/backup/r2/test', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.config)
                        })
                            .then(r => r.json())
                            .then(data => {
                                this.loading = false;
                                if (data.error) {
                                    this.testError = true;
                                    this.testMessage = 'è¿æ¥å¤±è´¥: ' + data.error;
                                } else {
                                    this.testError = false;
                                    this.testMessage = 'è¿æ¥æˆåŠŸ: ' + data.message;
                                }
                                setTimeout(() => this.testMessage = '', 5000);
                            })
                            .catch(e => {
                                this.loading = false;
                                this.testError = true;
                                this.testMessage = 'è¯·æ±‚é”™è¯¯: ' + e;
                                setTimeout(() => this.testMessage = '', 5000);
                            });
                    },

                    saveConfig() {
                        this.testMessage = 'ä¿å­˜ä¸­...';
                        fetch('/api/backup/r2/config', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.config)
                        })
                            .then(r => r.json())
                            .then(() => {
                                this.testError = false;
                                this.testMessage = 'é…ç½®å·²ä¿å­˜';
                                this.loadBackups();
                                setTimeout(() => this.testMessage = '', 3000);
                            })
                            .catch(e => {
                                this.testError = true;
                                this.testMessage = 'ä¿å­˜å¤±è´¥: ' + e;
                                setTimeout(() => this.testMessage = '', 5000);
                            });
                    },

                    uploadMessage: '',
                    uploadError: false,
                    upload() {
                        this.loading = true;
                        this.uploadMessage = 'ä¸Šä¼ ä¸­...';
                        this.uploadError = false;

                        fetch('/api/backup/r2/upload', { method: 'POST' })
                            .then(r => r.json())
                            .then(data => {
                                if (data.error) {
                                    this.uploadError = true;
                                    this.uploadMessage = 'ä¸Šä¼ å¤±è´¥: ' + data.error;
                                } else {
                                    this.uploadError = false;
                                    this.uploadMessage = 'ä¸Šä¼ æˆåŠŸ';
                                    this.loadBackups();
                                }
                                setTimeout(() => this.uploadMessage = '', 5000);
                            })
                            .catch(e => {
                                this.uploadError = true;
                                this.uploadMessage = 'ä¸Šä¼ é”™è¯¯: ' + e;
                                setTimeout(() => this.uploadMessage = '', 5000);
                            })
                            .finally(() => this.loading = false);
                    },

                    loadBackups() {
                        // Only show global loading if we have no data
                        if (this.backups.length === 0) {
                            this.loading = true;
                        }

                        fetch('/api/backup/r2/list')
                            .then(r => r.json())
                            .then(data => {
                                if (data.error) console.error(data.error);
                                else this.backups = data.backups || [];
                            })
                            .catch(console.error)
                            .finally(() => this.loading = false);
                    },

                    showConfirm: false,
                    confirmTitle: '',
                    confirmMessage: '',
                    confirmButtonText: '',
                    confirmType: '',
                    currentKey: '',
                    modalLoading: false,

                    confirmRestore(key) {
                        // Scroll to preview area
                        const previewEl = document.getElementById('restore-preview');
                        if (previewEl) previewEl.scrollIntoView({ behavior: 'smooth' });

                        // Initial State
                        this.renderProgress(previewEl, key, 0, 'starting');

                        const formData = new FormData();
                        formData.append('key', key);

                        fetch('/api/backup/r2/stage', {
                            method: 'POST',
                            body: formData
                        })
                            .then(r => r.json())
                            .then(data => {
                                if (data.error) throw new Error(data.error);
                                if (!data.task_id) throw new Error("No Task ID returned");
                                this.startPolling(data.task_id, key, previewEl);
                            })
                            .catch(e => {
                                this.renderError(previewEl, e);
                            });
                    },

                    startPolling(taskId, key, previewEl) {
                        const interval = setInterval(() => {
                            fetch('/api/backup/r2/progress/' + taskId)
                                .then(r => r.json())
                                .then(data => {
                                    if (data.status === 'completed') {
                                        clearInterval(interval);
                                        if (previewEl) {
                                            previewEl.innerHTML = data.result_html;
                                            if (window.htmx) htmx.process(previewEl);
                                        }
                                    } else if (data.status === 'error') {
                                        clearInterval(interval);
                                        throw new Error(data.error || 'Unknown error');
                                    } else {
                                        // Update Progress
                                        let percent = 0;
                                        if (data.total_bytes > 0) {
                                            percent = (data.downloaded / data.total_bytes) * 100;
                                        }
                                        this.renderProgress(previewEl, key, percent, data.status);
                                    }
                                })
                                .catch(e => {
                                    clearInterval(interval);
                                    this.renderError(previewEl, "Progress check failed: " + e);
                                });
                        }, 1000);
                    },

                    renderProgress(el, key, percent, status) {
                        if (!el) return;
                        const statusText = status === 'analyzing' ? 'æ­£åœ¨åˆ†ææ•°æ®...' : (status === 'starting' ? 'æ­£åœ¨å¯åŠ¨ä»»åŠ¡...' : `å·²ä¸‹è½½ ${percent.toFixed(1)}%`);

                        el.innerHTML = `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 text-center animate-fade-in-up">
                            <div class="mb-3">
                                <span class="inline-block animate-bounce text-3xl">â˜ï¸</span>
                            </div>
                            <h4 class="text-blue-800 font-bold text-lg mb-1">æ­£åœ¨ä»äº‘ç«¯ä¸‹è½½å¤‡ä»½...</h4>
                            <p class="text-blue-600 text-sm mb-4">æ–‡ä»¶å: ${key}</p>
                            
                            <div class="w-full max-w-xs mx-auto bg-blue-200 rounded-full h-4 overflow-hidden relative">
                                <div class="bg-blue-500 h-full rounded-full transition-all duration-500 ease-out" style="width: ${percent}%"></div>
                            </div>
                            <div class="mt-2 flex justify-between text-xs text-blue-500 max-w-xs mx-auto">
                                <span>${statusText}</span>
                                <span>${percent.toFixed(0)}%</span>
                            </div>
                        </div>
                    `;
                    },

                    renderError(el, error) {
                        if (!el) return;
                        el.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                            <div class="text-red-500 font-bold mb-1">ä¸‹è½½/åˆ†æå¤±è´¥</div>
                            <div class="text-sm text-red-600">${error}</div>
                        </div>
                    `;
                    },

                    confirmDelete(key) {
                        this.currentKey = key;
                        this.confirmType = 'delete';
                        this.confirmTitle = 'ç¡®è®¤åˆ é™¤';
                        this.confirmMessage = 'ç¡®å®šè¦åˆ é™¤å¤‡ä»½ ' + key + ' å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼';
                        this.confirmButtonText = 'ç¡®è®¤åˆ é™¤';
                        this.showConfirm = true;
                    },

                    executeConfirmAction() {
                        this.modalLoading = true;
                        if (this.confirmType === 'delete') {
                            this.doDelete();
                        }
                    },

                    doDelete() {
                        const formData = new FormData();
                        formData.append('key', this.currentKey);
                        fetch('/api/backup/r2/delete', { method: 'POST', body: formData })
                            .then(r => r.json())
                            .then(data => {
                                if (data.error) {
                                    this.confirmMessage = 'åˆ é™¤å¤±è´¥: ' + data.error;
                                    this.confirmTitle = 'é”™è¯¯';
                                } else {
                                    this.showConfirm = false;
                                    this.loadBackups();
                                }
                            })
                            .catch(e => {
                                this.confirmMessage = 'åˆ é™¤é”™è¯¯: ' + e;
                                this.confirmTitle = 'é”™è¯¯';
                            })
                            .finally(() => this.modalLoading = false);
                    }
                }));
            });
        </script>

        <!-- Backup UI -->
        <div class="space-y-6 text-gray-800">
            <!-- Backup Section -->
            <div class="bg-white/60 p-6 rounded-xl border border-white/70 shadow-sm relative overflow-hidden group">
                <div class="relative z-10">
                    <h3 class="text-lg font-semibold mb-2 flex items-center gap-2">
                        <span>ğŸ“¦</span> å¤‡ä»½æ•°æ®
                    </h3>
                    <div class="mb-4 text-sm text-gray-600 space-y-1 bg-white/50 p-3 rounded-lg border border-gray-100">
                        <div class="flex justify-between"><span>è®¢é˜…æ€»æ•°:</span> <span class="font-bold">{{
                                .Stats.SubscriptionCount }}</span></div>
                        <div class="flex justify-between"><span>å†å²è®°å½•:</span> <span class="font-bold">{{
                                .Stats.DownloadLogCount }}</span></div>
                        <div class="flex justify-between"><span>ç”¨æˆ·è´¦å·:</span> <span class="font-bold">{{ .Stats.UserCount
                                }}</span></div>
                        <div class="flex justify-between text-gray-400"><span>æœ¬åœ°ç•ªå‰§:</span> <span class="font-bold">{{
                                .Stats.LocalAnimeCount }} (ä»…æœ¬åœ°)</span></div>
                        <div class="flex justify-between"><span>æ•°æ®åº“å¤§å°:</span> <span class="font-bold">{{
                                .Stats.DatabaseSize }}</span></div>
                        <div class="flex justify-between"><span>æœ€åä¿®æ”¹:</span> <span class="font-mono text-xs">{{
                                .Stats.LastModified }}</span></div>

                        {{ if .Stats.SubscriptionTitles }}
                        <div class="mt-2 pt-2 border-t border-gray-200">
                            <div class="text-xs text-gray-500 mb-1">åŒ…å«çš„è®¢é˜…:</div>
                            <div class="max-h-[100px] overflow-y-auto space-y-1 pr-1 custom-scrollbar">
                                {{ range .Stats.SubscriptionTitles }}
                                <div class="text-xs bg-white px-2 py-1 rounded border border-gray-100 truncate">{{ . }}
                                </div>
                                {{ end }}
                            </div>
                        </div>
                        {{ end }}
                    </div>
                    <p class="text-sm text-gray-600 mb-4">
                        ä¸‹è½½ç»è¿‡ç­›é€‰çš„æ•°æ®åº“æ–‡ä»¶ (ä»…åŒ…å«è®¢é˜…ã€æ—¥å¿—å’Œè®¾ç½®ï¼Œä¸å«æœ¬åœ°ç•ªå‰§ç´¢å¼•)ã€‚
                    </p>
                    <a href="/api/backup/export" target="_blank"
                        class="inline-flex items-center gap-2 px-6 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition shadow-lg shadow-emerald-200">
                        <span>â¬‡ï¸</span> ä¸‹è½½å¤‡ä»½
                    </a>
                </div>
                <div
                    class="absolute -right-10 -bottom-10 text-9xl text-emerald-100 opacity-50 group-hover:scale-110 transition duration-500 select-none">
                    ğŸ’¾
                </div>
            </div>

            <!-- Restore Section -->
            <div class="bg-white/60 p-6 rounded-xl border border-white/70 shadow-sm relative overflow-hidden group">
                <div class="relative z-10">
                    <h3 class="text-lg font-semibold mb-2 flex items-center gap-2 text-red-600">
                        <span>âš ï¸</span> è¿˜åŸæ•°æ®
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">
                        ä¸Šä¼ å¤‡ä»½æ–‡ä»¶è¿›è¡Œåˆ†æï¼Œé¢„è§ˆæ•°æ®åå†ç¡®è®¤è¿˜åŸã€‚
                    </p>

                    <form hx-post="/api/backup/analyze" hx-encoding="multipart/form-data" hx-target="#restore-preview"
                        hx-indicator="#analyze-btn" class="flex items-end gap-4 mb-4">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">é€‰æ‹©å¤‡ä»½æ–‡ä»¶ (.db)</label>
                            <input type="file" name="backup_file" accept=".db" required
                                class="w-full px-4 py-2 bg-white/50 rounded-lg border border-gray-300 focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100">
                        </div>
                        <div>
                            <button type="submit" id="analyze-btn"
                                class="inline-flex items-center gap-2 px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition shadow-lg shadow-blue-200 cursor-pointer h-[42px]">
                                <span class="[.htmx-request_&]:hidden">ğŸ”</span>
                                <span class="hidden [.htmx-request_&]:inline animate-spin">âŒ›</span>
                                åˆ†ææ–‡ä»¶
                            </button>
                        </div>
                    </form>

                    <!-- Preview Container -->
                    <div id="restore-preview" class="mt-4"></div>
                </div>
                <div
                    class="absolute -right-6 -bottom-6 text-9xl text-red-100 opacity-50 group-hover:rotate-12 transition duration-500 select-none">
                    â™»ï¸
                </div>
            </div>

            <!-- Cloudflare R2 Section -->
            <div class="bg-white/60 p-6 rounded-xl border border-white/70 shadow-sm relative overflow-hidden group">
                <div class="relative z-10">
                    <h3 class="text-lg font-semibold mb-2 flex items-center gap-2 text-orange-600">
                        <span>â˜ï¸</span> Cloudflare R2 äº‘å¤‡ä»½
                    </h3>

                    <div x-data="r2Backup" @tab-backup.window="loadBackups()" class="space-y-4">

                        <!-- Config Form -->
                        <div
                            class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-white/50 p-4 rounded-lg border border-gray-100">
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 mb-1">R2 Endpoint (ç«¯ç‚¹åœ°å€)</label>
                                <input type="text" x-model="config.endpoint"
                                    placeholder="https://<account>.r2.cloudflarestorage.com"
                                    class="w-full text-sm px-3 py-2 bg-white rounded border border-gray-200 focus:border-orange-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 mb-1">Bucket Name
                                    (å­˜å‚¨æ¡¶åç§°)</label>
                                <input type="text" x-model="config.bucket" placeholder="animate-backup"
                                    class="w-full text-sm px-3 py-2 bg-white rounded border border-gray-200 focus:border-orange-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 mb-1">Access Key ID</label>
                                <input type="text" x-model="config.access_key"
                                    class="w-full text-sm px-3 py-2 bg-white rounded border border-gray-200 focus:border-orange-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 mb-1">Secret Access Key</label>
                                <input type="password" x-model="config.secret_key" placeholder="********"
                                    class="w-full text-sm px-3 py-2 bg-white rounded border border-gray-200 focus:border-orange-500 outline-none">
                            </div>
                            <div class="md:col-span-2 text-right space-x-2 flex items-center justify-end gap-2">
                                <span x-show="testMessage" x-text="testMessage"
                                    :class="testError ? 'text-red-500' : 'text-green-500'"
                                    class="text-xs font-semibold transition-opacity duration-500"></span>
                                <button @click="testConnection" :disabled="loading"
                                    :class="loading ? 'bg-blue-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-500'"
                                    class="text-xs text-white px-3 py-1.5 rounded transition flex items-center gap-1">
                                    <span x-show="loading && testMessage === 'æµ‹è¯•ä¸­...'"
                                        class="animate-spin h-3 w-3 border-2 border-white rounded-full border-t-transparent"></span>
                                    <span x-text="loading && testMessage === 'æµ‹è¯•ä¸­...' ? 'æµ‹è¯•ä¸­...' : 'æµ‹è¯•è¿æ¥'"></span>
                                </button>
                                <button @click="saveConfig"
                                    class="text-xs bg-gray-800 text-white px-3 py-1.5 rounded hover:bg-gray-700 transition">ä¿å­˜é…ç½®</button>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="flex items-center justify-between border-b border-gray-200 pb-2">
                            <h4 class="text-sm font-semibold text-gray-700">äº‘ç«¯å¤‡ä»½åˆ—è¡¨</h4>
                            <div class="flex items-center gap-2">
                                <span x-show="uploadMessage" x-text="uploadMessage"
                                    :class="uploadError ? 'text-red-500' : 'text-green-500'"
                                    class="text-xs font-semibold transition-opacity duration-500"></span>
                                <button @click="upload" :disabled="loading"
                                    :class="loading ? 'bg-orange-400 cursor-not-allowed' : 'bg-orange-500 hover:bg-orange-600'"
                                    class="text-sm flex items-center gap-1 text-white px-4 py-1.5 rounded-lg transition shadow-lg shadow-orange-200">
                                    <span x-show="loading && uploadMessage === 'ä¸Šä¼ ä¸­...'"
                                        class="animate-spin h-3 w-3 border-2 border-white rounded-full border-t-transparent inline-block"></span>
                                    <span x-show="!(loading && uploadMessage === 'ä¸Šä¼ ä¸­...')">â˜ï¸</span>
                                    ç«‹å³ä¸Šä¼ 
                                </button>
                            </div>
                        </div>

                        <!-- Backup List -->
                        <div
                            class="bg-white/50 rounded-lg border border-gray-100 min-h-[100px] max-h-[300px] overflow-y-auto custom-scrollbar p-2">
                            <template x-if="loading">
                                <div class="flex items-center justify-center h-20 text-gray-400 text-sm">åŠ è½½ä¸­...</div>
                            </template>
                            <template x-if="!loading && backups.length === 0">
                                <div class="flex items-center justify-center h-20 text-gray-400 text-sm">æš‚æ— å¤‡ä»½</div>
                            </template>

                            <div class="space-y-2">
                                <template x-for="file in backups" :key="file.key">
                                    <div
                                        class="flex items-center justify-between bg-white p-3 rounded border border-gray-100 hover:border-orange-200 transition">
                                        <div class="flex items-center gap-3">
                                            <div class="text-xl">ğŸ“¦</div>
                                            <div>
                                                <div class="text-sm font-medium text-gray-800"
                                                    x-text="file.key.replace('animate_backup_', '').replace('.db', '')">
                                                </div>
                                                <div class="text-xs text-gray-400 mt-0.5">
                                                    <span x-text="file.last_modified"></span> â€¢ <span
                                                        x-text="(file.size / 1024 / 1024).toFixed(2) + ' MB'"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <button @click="confirmRestore(file.key)"
                                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100 transition border border-blue-200">
                                                é¢„è§ˆ / è¿˜åŸ
                                            </button>
                                            <button @click="confirmDelete(file.key)"
                                                class="text-xs bg-red-50 text-red-600 px-2 py-1.5 rounded hover:bg-red-100 transition border border-red-200"
                                                title="åˆ é™¤">
                                                ğŸ—‘ï¸
                                            </button>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Delete Confirm Modal (Simplified, only for Delete) -->
                        <div x-show="showConfirm" style="display: none;"
                            class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
                            x-transition.opacity>
                            <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6 space-y-4"
                                @click.outside="showConfirm = false">
                                <h3 class="text-lg font-bold text-gray-800" x-text="confirmTitle"></h3>
                                <p class="text-sm text-gray-600" x-text="confirmMessage"></p>

                                <!-- Loading Spinner inside Modal -->
                                <div x-show="modalLoading" class="flex justify-center py-2">
                                    <span
                                        class="animate-spin h-6 w-6 border-2 border-orange-500 rounded-full border-t-transparent"></span>
                                </div>

                                <div x-show="!modalLoading" class="flex justify-end gap-3 pt-2">
                                    <button @click="showConfirm = false"
                                        class="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded transition">å–æ¶ˆ</button>
                                    <button @click="executeConfirmAction"
                                        class="bg-red-500 hover:bg-red-600 px-4 py-2 text-sm text-white rounded transition shadow-md"
                                        x-text="confirmButtonText"></button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                <div
                    class="absolute -right-8 -bottom-8 text-9xl text-orange-100 opacity-50 group-hover:scale-105 transition duration-500 select-none">
                    â˜ï¸
                </div>
            </div>
        </div>
    </div>

    <!-- Security Tab -->
    <div x-show="activeTab === 'security'" x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 translate-y-4" x-transition:enter-end="opacity-100 translate-y-0"
        class="space-y-6">
        <div class="glass-panel p-8" x-data="{
                        oldPwd: '', newPwd: '', confirmPwd: '', loading: false,
                        async submit() {
                            if (this.newPwd !== this.confirmPwd) {
                                window.dispatchEvent(new CustomEvent('toast', { detail: { msg: 'æ–°å¯†ç ä¸ä¸€è‡´', type: 'error' } }));
                                return;
                            }
                            this.loading = true;
                            try {
                                const res = await fetch('/api/change-password', {
                                    method: 'POST',
                                    headers: {'Content-Type': 'application/json'},
                                    body: JSON.stringify({ old_password: this.oldPwd, new_password: this.newPwd })
                                });
                                const data = await res.json();
                                if (res.ok) {
                                    window.dispatchEvent(new CustomEvent('toast', { detail: { msg: 'å¯†ç å·²æ›´æ–°', type: 'success' } }));
                                    this.oldPwd = ''; this.newPwd = ''; this.confirmPwd = '';
                                } else {
                                    window.dispatchEvent(new CustomEvent('toast', { detail: { msg: data.error || 'æ›´æ–°å¤±è´¥', type: 'error' } }));
                                }
                            } catch (e) { console.error(e); }
                            finally { this.loading = false; }
                        }
                    }">
            <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                <span class="w-2 h-6 bg-gray-800 rounded-full"></span>
                æ›´æ¢å¯†ç 
            </h3>
            <div class="max-w-md space-y-4">
                <input type="password" x-model="oldPwd" placeholder="å½“å‰å¯†ç "
                    class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 outline-none font-medium">
                <input type="password" x-model="newPwd" placeholder="æ–°å¯†ç "
                    class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 outline-none font-medium">
                <input type="password" x-model="confirmPwd" placeholder="ç¡®è®¤æ–°å¯†ç "
                    class="w-full px-5 py-3 rounded-2xl bg-white/50 border border-gray-200 outline-none font-medium">
                <button type="button" @click="submit" :disabled="loading"
                    class="w-full bg-gray-800 text-white py-3 rounded-2xl font-bold hover:bg-black transition-all shadow-xl active:scale-95 disabled:opacity-50">
                    <span x-show="!loading">æ›´æ–°å®‰å…¨å‡­è¯</span>
                    <span x-show="loading">ä¼˜åŒ–ä¸­...</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Global Save FAB -->


    <div id="save-result" class="hidden"></div>

    <script>
        const jellyfinServerId = '{{.JellyfinServerID}}';

        function openAniListAuth() {
            const clientId = document.getElementById('anilist_client_id').value;
            if (!clientId) {
                alert('è¯·å…ˆè¾“å…¥ Client ID');
                return;
            }
            const url = `https://anilist.co/api/v2/oauth/authorize?client_id=${clientId}&response_type=token`;
            window.open(url, '_blank');
        }

        function openJellyfin() {
            let url = document.getElementById('jellyfin_url_input').value;
            if (!url) {
                console.error('è¯·å…ˆè¾“å…¥ Jellyfin URL');
                return;
            }
            url = url.replace(/\/$/, '');
            let targetUrl = url;
            if (jellyfinServerId) {
                targetUrl = url + "/web/index.html?serverId=" + jellyfinServerId;
            }
            window.open(targetUrl, '_blank');
        }
    </script>
</div>

<style>
    [x-cloak] {
        display: none !important;
    }

    .htmx-indicator {
        opacity: 0;
        pointer-events: none;
        transition: opacity 200ms ease-in;
    }

    .htmx-indicator.htmx-request {
        opacity: 1;
        pointer-events: auto;
    }
</style>
{{ if not .SkipLayout }}{{ template "footer.html" . }}{{ end }}
```