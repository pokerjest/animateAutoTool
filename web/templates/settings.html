{{ if not .SkipLayout }}{{ template "header.html" . }}{{ end }}

<div class="space-y-6">
    <h2 class="text-2xl font-bold text-gray-700">ç³»ç»Ÿè®¾ç½®</h2>

    <!-- qBittorrent Settings -->
    <!-- qBittorrent Settings -->
    <form hx-post="/api/settings" hx-target="#save-result" hx-swap="innerHTML" novalidate>

        <!-- qBittorrent Settings -->
        <div class="bg-white/60 p-6 rounded-xl border border-white/70 shadow-sm mb-6">
            <div class="mb-4">
                <h3 class="text-lg font-semibold text-gray-800 border-b border-gray-200 pb-2 mb-4">qBittorrent è®¾ç½®</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Web UI åœ°å€</label>
                        <input type="text" name="qb_url" value='{{ index .Config "qb_url" }}'
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
                            placeholder="http://localhost:8080 (è¯·åŒ…å« http://)">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ä¸‹è½½ä¿å­˜ç›®å½•</label>
                        <input type="text" name="base_download_dir" value='{{ index .Config "base_download_dir" }}'
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
                            placeholder="/downloads/anime">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ç”¨æˆ·å</label>
                        <input type="text" name="qb_username" value='{{ index .Config "qb_username" }}'
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å¯†ç </label>
                        <div class="relative">
                            <input type="password" id="qb_password_input" name="qb_password"
                                value='{{ index .Config "qb_password" }}'
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none pr-10">
                            <button type="button" onclick="togglePassword()"
                                class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600 cursor-pointer focus:outline-none"
                                title="æ˜¾ç¤º/éšè—å¯†ç ">
                                <span id="pwd-toggle-icon">ğŸ‘ï¸</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- QB Connection Status -->
            <!-- QB Connection Status -->
            <div id="qb-status" class="min-h-[40px]" hx-get="/api/settings/qb-status" hx-trigger="load" hx-target="this"
                hx-swap="innerHTML">
                <!-- Default state empty or loading handled by OOB -->
                <div class="htmx-indicator flex items-center gap-2 text-gray-400">
                    <span class="animate-spin">âŒ›</span>
                    <span>æ£€æŸ¥è¿æ¥çŠ¶æ€...</span>
                </div>
            </div>
        </div>

        <!-- Bangumi Integration -->
        <div class="bg-white/60 p-6 rounded-xl border border-white/70 shadow-sm mb-6">
            <div class="mb-8">
                <div class="flex items-center gap-2 border-b border-gray-200 pb-2 mb-4">
                    <span class="text-xl">ğŸŒ¸</span>
                    <h3 class="text-lg font-semibold text-gray-800">Bangumi é›†æˆ</h3>
                </div>

                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Personal Access Token</label>
                        <div class="relative">
                            <input type="password" id="bangumi_token_input" name="bangumi_access_token"
                                value='{{ index .Config "bangumi_access_token" }}'
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none pr-10"
                                placeholder="è¯·åœ¨ Bangumi å¼€å‘è€…è®¾ç½®ä¸­ç”Ÿæˆ Access Token">
                            <button type="button" onclick="toggleTokenVisibility()"
                                class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600 cursor-pointer focus:outline-none"
                                title="æ˜¾ç¤º/éšè— Token">
                                <span id="token-toggle-icon">ğŸ‘ï¸</span>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">
                            è¯·å‰å¾€ <a href="https://bgm.tv/dev/app" target="_blank"
                                class="text-pink-500 hover:underline">Bangumi å¼€å‘è€…ä¸­å¿ƒ</a> åˆ›å»ºåº”ç”¨å¹¶ç”Ÿæˆ Access Tokenã€‚
                        </p>
                    </div>

                    <!-- Connection Status -->
                    <div id="bangumi-status" hx-get="/api/bangumi/profile" hx-trigger="load, refresh-bangumi from:body"
                        hx-target="this" hx-swap="innerHTML" class="min-h-[80px]">
                        <!-- Default state if not connected (loading handled by htmx) -->
                        <div class="htmx-indicator flex items-center gap-2 text-gray-500">
                            <span class="animate-spin">âŒ›</span>
                            <span>æ£€æŸ¥è¿æ¥çŠ¶æ€...</span>
                        </div>
                        <div class="text-sm text-gray-500 flex items-center gap-2">
                            <span>ğŸ”´ æœªè¿æ¥</span>
                            <span class="text-xs text-gray-400">(è¯·å…ˆè¾“å…¥ Access Token å¹¶ä¿å­˜)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sticky Footer for Save Button? Or just at bottom -->
        <div
            class="fixed bottom-0 left-0 lg:left-64 right-0 bg-white/80 backdrop-blur-md border-t border-gray-200 p-4 flex justify-between items-center z-10">
            <div id="save-result" class="text-sm transition-all duration-300"></div>

            <button type="submit" id="save-settings-btn"
                class="bg-primary text-white px-8 py-2.5 rounded-lg hover:bg-accent transition shadow-lg shadow-pink-200 disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center gap-2 text-lg font-semibold"
                hx-indicator="#save-settings-btn">
                <span class="hidden [.htmx-request_&]:inline animate-spin">âŒ›</span>
                <span class="[.htmx-request_&]:hidden">ğŸ’¾ ä¿å­˜æ‰€æœ‰é…ç½®</span>
                <span class="hidden [.htmx-request_&]:inline">æ­£åœ¨ä¿å­˜...</span>
            </button>
        </div>
        <!-- Spacer for sticky footer -->
        <div class="h-20"></div>

    </form>

    <script>
        function togglePassword() {
            const input = document.getElementById('qb_password_input');
            const icon = document.getElementById('pwd-toggle-icon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.innerText = 'ğŸ™ˆ';
            } else {
                input.type = 'password';
                icon.innerText = 'ğŸ‘ï¸';
            }
        }

        function toggleTokenVisibility() {
            const input = document.getElementById('bangumi_token_input');
            const icon = document.getElementById('token-toggle-icon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.innerText = 'ğŸ™ˆ';
            } else {
                input.type = 'password';
                icon.innerText = 'ğŸ‘ï¸';
            }
        }
    </script>
</div>

{{ if not .SkipLayout }}{{ template "footer.html" . }}{{ end }}