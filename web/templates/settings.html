{{ if not .SkipLayout }}{{ template "header.html" . }}{{ end }}

<div class="space-y-6">
    <h2 class="text-2xl font-bold text-gray-700">ç³»ç»Ÿè®¾ç½®</h2>

    <form hx-post="/api/settings" hx-target="#save-result" hx-swap="innerHTML" novalidate>
        <div class="space-y-6">
            <!-- qBittorrent Settings -->
            <div class="bg-white/60 p-6 rounded-xl border border-white/70 shadow-sm">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 border-b border-gray-200 pb-2 mb-4">qBittorrent è®¾ç½®
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Web UI åœ°å€</label>
                            <input type="text" name="qb_url" value='{{ index .Config "qb_url" }}'
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
                                placeholder="http://localhost:8080 (è¯·åŒ…å« http://)">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ä¸‹è½½ä¿å­˜ç›®å½•</label>
                            <input type="text" name="base_download_dir" value='{{ index .Config "base_download_dir" }}'
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
                                placeholder="/downloads/anime">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ç”¨æˆ·å</label>
                            <input type="text" name="qb_username" value='{{ index .Config "qb_username" }}'
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å¯†ç </label>
                            <div class="relative">
                                <input type="password" id="qb_password_input" name="qb_password"
                                    value='{{ index .Config "qb_password" }}'
                                    class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none pr-10">
                                <button type="button" onclick="togglePassword()"
                                    class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600 cursor-pointer focus:outline-none"
                                    title="æ˜¾ç¤º/éšè—å¯†ç ">
                                    <span id="pwd-toggle-icon">ğŸ‘ï¸</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- QB Connection Status -->
                <div id="qb-status" class="min-h-[40px]" hx-get="/api/settings/qb-status" hx-trigger="load"
                    hx-target="this" hx-swap="innerHTML">
                    <!-- Default state empty or loading handled by OOB -->
                    <div class="htmx-indicator flex items-center gap-2 text-gray-400">
                        <span class="animate-spin">âŒ›</span>
                        <span>æ£€æŸ¥è¿æ¥çŠ¶æ€...</span>
                    </div>
                </div>
            </div>

            <!-- Network Proxy Settings -->
            <div class="bg-white/60 p-6 rounded-xl border border-white/70 shadow-sm">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 border-b border-gray-200 pb-2 mb-4">ç½‘ç»œä»£ç†è®¾ç½®</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">HTTP ä»£ç†åœ°å€</label>
                            <input type="text" name="proxy_url" value='{{ index .Config "proxy_url" }}'
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
                                placeholder="http://127.0.0.1:7890">
                            <p class="text-xs text-gray-500 mt-1">
                                ä¸º Bangumi å’Œ TMDB è¯·æ±‚é…ç½®ä»£ç†ã€‚ç•™ç©ºåˆ™ä¸ä½¿ç”¨ä»£ç†ã€‚
                            </p>
                        </div>
                        <div class="col-span-2 flex flex-col gap-3 justify-center">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" name="proxy_bangumi_enabled" value="true"
                                    class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary" {{ if eq
                                    (index .Config "proxy_bangumi_enabled" ) "true" }}checked{{ end }}>
                                <span class="text-sm text-gray-700">Bangumi ä½¿ç”¨ä»£ç†</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" name="proxy_tmdb_enabled" value="true"
                                    class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary" {{ if eq
                                    (index .Config "proxy_tmdb_enabled" ) "true" }}checked{{ end }}>
                                <span class="text-sm text-gray-700">TMDB ä½¿ç”¨ä»£ç†</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" name="proxy_anilist_enabled" value="true"
                                    class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary" {{ if eq
                                    (index .Config "proxy_anilist_enabled" ) "true" }}checked{{ end }}>
                                <span class="text-sm text-gray-700">AniList ä½¿ç”¨ä»£ç†</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bangumi Integration -->
            <div class="bg-white/60 p-6 rounded-xl border border-white/70 shadow-sm">
                <div class="mb-8">
                    <div class="flex items-center gap-2 border-b border-gray-200 pb-2 mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Bangumi é›†æˆ</h3>
                    </div>

                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Personal Access Token</label>
                            <div class="relative">
                                <input type="password" id="bangumi_token_input" name="bangumi_access_token"
                                    value='{{ index .Config "bangumi_access_token" }}'
                                    class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none pr-10"
                                    placeholder="è¯·åœ¨ Bangumi å¼€å‘è€…è®¾ç½®ä¸­ç”Ÿæˆ Access Token">
                                <button type="button" onclick="toggleTokenVisibility()"
                                    class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600 cursor-pointer focus:outline-none"
                                    title="æ˜¾ç¤º/éšè— Token">
                                    <span id="token-toggle-icon">ğŸ‘ï¸</span>
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">
                                è¯·å‰å¾€ <a href="https://bgm.tv/dev/app" target="_blank"
                                    class="text-pink-500 hover:underline">Bangumi
                                    å¼€å‘è€…ä¸­å¿ƒ</a> åˆ›å»ºåº”ç”¨å¹¶ç”Ÿæˆ Access Tokenã€‚
                            </p>
                        </div>

                        <!-- Connection Status -->
                        <div id="bangumi-status" hx-get="/api/bangumi/profile"
                            hx-trigger="load, refresh-bangumi from:body" hx-target="this" hx-swap="innerHTML"
                            class="min-h-[80px]">
                            <!-- Default state if not connected (loading handled by htmx) -->
                            <div class="htmx-indicator flex items-center gap-2 text-gray-500">
                                <span class="animate-spin">âŒ›</span>
                                <span>æ£€æŸ¥è¿æ¥çŠ¶æ€...</span>
                            </div>
                            <div class="text-sm text-gray-500 flex items-center gap-2">
                                <span>ğŸ”´ æœªè¿æ¥</span>
                                <span class="text-xs text-gray-400">(è¯·å…ˆè¾“å…¥ Access Token å¹¶ä¿å­˜)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TMDB Integration -->
            <div class="bg-white/60 p-6 rounded-xl border border-white/70 shadow-sm">
                <div class="mb-4">
                    <div class="flex items-center gap-2 border-b border-gray-200 pb-2 mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">The Movie Database (TMDB)</h3>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">API Read Access Token (v4
                                Auth)</label>
                            <div class="relative">
                                <input type="password" id="tmdb_token_input" name="tmdb_token"
                                    value='{{ index .Config "tmdb_token" }}'
                                    class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none pr-10"
                                    placeholder="eyJhbGciOiJIUzI1Ni...">
                                <button type="button" onclick="toggleTMDBTokenVisibility()"
                                    class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600 cursor-pointer focus:outline-none"
                                    title="æ˜¾ç¤º/éšè— Token">
                                    <span id="tmdb-token-toggle-icon">ğŸ‘ï¸</span>
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">
                                è¯·å‰å¾€ <a href="https://www.themoviedb.org/settings/api" target="_blank"
                                    class="text-blue-500 hover:underline">TMDB API Settings</a> ç”Ÿæˆ "API Read Access
                                Token"ã€‚
                            </p>
                        </div>

                        <!-- Connection Status -->
                        <div id="tmdb-status" hx-get="/api/settings/tmdb-status" hx-trigger="load" hx-target="this"
                            hx-swap="innerHTML" class="min-h-[40px]">
                            <div class="htmx-indicator flex items-center gap-2 text-gray-500">
                                <span class="animate-spin">âŒ›</span>
                                <span>æ£€æŸ¥è¿æ¥çŠ¶æ€...</span>
                            </div>
                            <div class="text-sm text-gray-500 flex items-center gap-2">
                                <span>ğŸ”´ æœªè¿æ¥</span>
                                <span class="text-xs text-gray-400">(è¯·å…ˆè¾“å…¥ Token å¹¶ä¿å­˜)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AniList Integration -->
            <div class="bg-white/60 p-6 rounded-xl border border-white/70 shadow-sm">
                <div class="mb-4">
                    <div class="flex items-center gap-2 border-b border-gray-200 pb-2 mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">AniList é›†æˆ</h3>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Authorization</label>

                            <!-- Client ID Input -->
                            <div class="mb-4">
                                <label class="block text-xs text-gray-500 mb-1">æ­¥éª¤ 1: è¾“å…¥ Apps çš„ Client ID (ä¸æ˜¯ Secret)
                                </label>
                                <div class="flex gap-2">
                                    <input type="text" id="anilist_client_id"
                                        class="flex-1 px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
                                        placeholder="ä¾‹å¦‚: 12345">
                                    <a href="#" onclick="openAniListAuth()" id="anilist-auth-btn"
                                        class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition flex items-center gap-2 text-sm whitespace-nowrap">
                                        ğŸ”— è·å– Token
                                    </a>
                                </div>
                            </div>

                            <!-- Token Input -->
                            <label class="block text-xs text-gray-500 mb-1">æ­¥éª¤ 2: ç²˜è´´è·å–åˆ°çš„ Access Token</label>
                            <div class="relative">
                                <input type="password" id="anilist_token_input" name="anilist_token"
                                    value='{{ index .Config "anilist_token" }}'
                                    class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none pr-10"
                                    placeholder="eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9...">
                                <button type="button" onclick="toggleAniListTokenVisibility()"
                                    class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600 cursor-pointer focus:outline-none"
                                    title="æ˜¾ç¤º/éšè— Token">
                                    <span id="anilist-token-toggle-icon">ğŸ‘ï¸</span>
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">
                                Tips: å¦‚æœæ‚¨åªæœ‰ Client Secretï¼Œè¯·å¿½ç•¥å®ƒã€‚æˆ‘ä»¬éœ€è¦çš„æ˜¯é€šè¿‡ Client ID æˆæƒåè·å¾—çš„ Access Token (ä»¥ ey å¼€å¤´)ã€‚
                                <br>
                                <a href="https://anilist.co/settings/developer" target="_blank"
                                    class="text-blue-500 hover:underline">ç®¡ç†æˆ‘çš„ Apps</a>
                            </p>
                        </div>

                        <!-- Connection Status -->
                        <div id="anilist-status" hx-get="/api/settings/anilist-status" hx-trigger="load"
                            hx-target="this" hx-swap="innerHTML" class="min-h-[40px]">
                            <div class="htmx-indicator flex items-center gap-2 text-gray-500">
                                <span class="animate-spin">âŒ›</span>
                                <span>æ£€æŸ¥è¿æ¥çŠ¶æ€...</span>
                            </div>
                            <div class="text-sm text-gray-500 flex items-center gap-2">
                                <span>ğŸ”´ æœªè¿æ¥</span>
                                <span class="text-xs text-gray-400">(è¯·å…ˆè¾“å…¥ Token å¹¶ä¿å­˜)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Jellyfin Integration -->
            <div class="bg-white/60 p-6 rounded-xl border border-white/70 shadow-sm">
                <div class="mb-4">
                    <div class="flex items-center gap-2 border-b border-gray-200 pb-2 mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Jellyfin é›†æˆ</h3>
                    </div>

                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Server URL</label>
                                <input type="text" name="jellyfin_url" value='{{ index .Config "jellyfin_url" }}'
                                    class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
                                    placeholder="http://localhost:8096">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                                <div class="relative">
                                    <input type="password" id="jellyfin_api_key_input" name="jellyfin_api_key"
                                        value='{{ index .Config "jellyfin_api_key" }}'
                                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none pr-10"
                                        placeholder="è¯·åœ¨ Jellyfin æ§åˆ¶å°ç”Ÿæˆ API å¯†é’¥">
                                    <button type="button" onclick="toggleJellyfinTokenVisibility()"
                                        class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600 cursor-pointer focus:outline-none"
                                        title="æ˜¾ç¤º/éšè— API Key">
                                        <span id="jellyfin-token-toggle-icon">ğŸ‘ï¸</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="flex items-center gap-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" name="proxy_jellyfin_enabled" value="true"
                                    class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary" {{ if eq
                                    (index .Config "proxy_jellyfin_enabled" ) "true" }}checked{{ end }}>
                                <span class="text-sm text-gray-700">Jellyfin ä½¿ç”¨ä»£ç†</span>
                            </label>
                        </div>

                        <!-- Connection Status -->
                        <div id="jellyfin-status" hx-get="/api/settings/jellyfin-status" hx-trigger="load"
                            hx-target="this" hx-swap="innerHTML" class="min-h-[40px]">
                            <div class="htmx-indicator flex items-center gap-2 text-gray-500">
                                <span class="animate-spin">âŒ›</span>
                                <span>æ£€æŸ¥è¿æ¥çŠ¶æ€...</span>
                            </div>
                            <div class="text-sm text-gray-500 flex items-center gap-2">
                                <span>ğŸ”´ æœªè¿æ¥</span>
                                <span class="text-xs text-gray-400">(è¯·å…ˆè¾“å…¥ URL å’Œ API Key å¹¶ä¿å­˜)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PikPak Integration -->
            <div class="bg-white/60 p-6 rounded-xl border border-white/70 shadow-sm mt-6">
                <div class="mb-4">
                    <div class="flex items-center gap-2 border-b border-gray-200 pb-2 mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">PikPak é›†æˆ (To AList)</h3>
                    </div>

                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                <input type="text" name="pikpak_username" value='{{ index .Config "pikpak_username" }}'
                                    class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
                                    placeholder="PikPak ç”¨æˆ·å">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                <div class="relative">
                                    <input type="password" id="pikpak_password_input" name="pikpak_password"
                                        value='{{ index .Config "pikpak_password" }}'
                                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none pr-10"
                                        placeholder="PikPak å¯†ç ">
                                    <button type="button" onclick="togglePikPakPasswordVisibility()"
                                        class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600 cursor-pointer focus:outline-none"
                                        title="æ˜¾ç¤º/éšè— å¯†ç ">
                                        <span id="pikpak-pwd-toggle-icon">ğŸ‘ï¸</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Refresh Token (æ¨è:
                                è§£å†³éªŒè¯ç é”™è¯¯)</label>
                            <div class="relative">
                                <input type="password" id="pikpak_refresh_token_input" name="pikpak_refresh_token"
                                    value=""
                                    class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none pr-10"
                                    placeholder="è‹¥é‡åˆ° 4001/Captcha é”™è¯¯ï¼Œè¯·ç²˜è´´ Refresh Token ä»¥ç›´è¿">
                                <button type="button"
                                    onclick="var i=document.getElementById('pikpak_refresh_token_input'); i.type = i.type==='password'?'text':'password';"
                                    class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600 cursor-pointer focus:outline-none"
                                    title="æ˜¾ç¤º/éšè— Token">
                                    <span>ğŸ‘ï¸</span>
                                </button>
                            </div>
                            <div class="text-xs text-slate-500 mt-1">
                                å½“å¯†ç ç™»å½•æŠ¥ "4001: captcha_required" é”™æ—¶ï¼Œè¯·ä»æµè§ˆå™¨ (F12 > Application > Storage) è·å–
                                `refresh_token` å¹¶å¡«å…¥æ­¤å¤„ã€‚
                            </div>
                        </div>

                        <div class="flex items-start justify-between gap-4 mt-6">
                            <!-- Connection Status -->
                            <div id="pikpak-status" hx-get="/api/settings/pikpak-status"
                                hx-trigger="load, pikpak-synced from:body" hx-target="this" hx-swap="innerHTML"
                                class="flex-grow min-h-[40px]">
                                <div class="htmx-indicator flex items-center gap-2 text-gray-500">
                                    <span class="animate-spin">âŒ›</span>
                                    <span>æ£€æŸ¥è¿æ¥çŠ¶æ€...</span>
                                </div>
                                <div class="text-sm text-gray-500 flex items-center gap-2">
                                    <span>âšª ç­‰å¾…æ£€æŸ¥...</span>
                                </div>
                            </div>

                            <button type="button" hx-post="/api/settings/pikpak-sync" hx-target="#pikpak-sync-status"
                                class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition flex items-center gap-2 text-sm font-medium shadow-sm shadow-indigo-200 whitespace-nowrap"
                                hx-indicator="#pikpak-indicator">
                                <span class="hidden [.htmx-request_&]:inline animate-spin">âŒ›</span>
                                <span>ğŸ’¾ ä¿å­˜å¹¶è¿æ¥ PikPak</span>
                            </button>
                        </div>

                        <div class="flex justify-end items-center gap-2 mt-2">
                            <div id="pikpak-indicator" class="htmx-indicator text-xs text-gray-500">æ­£åœ¨è¿æ¥ AList...</div>
                            <div id="pikpak-sync-status" class="text-xs"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security Settings: Change Password -->
            <div class="bg-white/60 p-6 rounded-xl border border-white/70 shadow-sm mt-6">
                <div class="mb-4">
                    <div class="flex items-center gap-2 border-b border-gray-200 pb-2 mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">å®‰å…¨è®¾ç½®</h3>
                    </div>

                    <div x-data="{
                        oldPassword: '',
                        newPassword: '',
                        confirmPassword: '',
                        loading: false,
                        message: '',
                        isError: false,
                        changePassword() {
                            if (this.newPassword !== this.confirmPassword) {
                                this.message = 'ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´';
                                this.isError = true;
                                return;
                            }
                            this.loading = true;
                            this.message = '';
                            fetch('/api/change-password', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({
                                    old_password: this.oldPassword,
                                    new_password: this.newPassword
                                })
                            })
                            .then(async r => {
                                const data = await r.json();
                                if (r.ok) {
                                    this.message = 'å¯†ç ä¿®æ”¹æˆåŠŸ';
                                    this.isError = false;
                                    this.oldPassword = '';
                                    this.newPassword = '';
                                    this.confirmPassword = '';
                                } else {
                                    this.message = data.error || 'ä¿®æ”¹å¤±è´¥';
                                    this.isError = true;
                                }
                            })
                            .catch(() => {
                                this.message = 'ç½‘ç»œè¯·æ±‚å¤±è´¥';
                                this.isError = true;
                            })
                            .finally(() => this.loading = false);
                        }
                    }" class="space-y-4 max-w-md">

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ—§å¯†ç </label>
                            <input type="password" x-model="oldPassword"
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ–°å¯†ç </label>
                            <input type="password" x-model="newPassword"
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ç¡®è®¤æ–°å¯†ç </label>
                            <input type="password" x-model="confirmPassword"
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
                        </div>

                        <div x-show="message" x-text="message" :class="isError ? 'text-red-500' : 'text-green-500'"
                            class="text-sm font-bold"></div>

                        <button type="button" @click="changePassword()"
                            :disabled="loading || !oldPassword || !newPassword"
                            class="bg-gray-800 text-white px-4 py-2 rounded-lg hover:bg-gray-900 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                            <span x-show="loading" class="animate-spin text-white">âŒ›</span>
                            <span>ä¿®æ”¹å¯†ç </span>
                        </button>

                    </div>
                </div>
            </div>

            <!-- Save Actions -->
            <div
                class="bg-white/60 p-6 rounded-xl border border-white/70 shadow-sm mt-6 flex justify-between items-center">
                <div id="save-result" class="text-sm transition-all duration-300"></div>

                <button type="submit" id="save-settings-btn"
                    class="bg-primary text-white px-8 py-2.5 rounded-lg hover:bg-accent transition shadow-lg shadow-pink-200 disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center gap-2 text-lg font-semibold"
                    hx-indicator="#save-settings-btn">
                    <span class="hidden [.htmx-request_&]:inline animate-spin">âŒ›</span>
                    <span class="[.htmx-request_&]:hidden">ğŸ’¾ ä¿å­˜æ‰€æœ‰é…ç½®</span>
                    <span class="hidden [.htmx-request_&]:inline">æ­£åœ¨ä¿å­˜...</span>
                </button>
            </div>

    </form>

    <script>
        function togglePassword() {
            const input = document.getElementById('qb_password_input');
            const icon = document.getElementById('pwd-toggle-icon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.innerText = 'ğŸ™ˆ';
            } else {
                input.type = 'password';
                icon.innerText = 'ğŸ‘ï¸';
            }
        }

        function toggleTokenVisibility() {
            const input = document.getElementById('bangumi_token_input');
            const icon = document.getElementById('token-toggle-icon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.innerText = 'ğŸ™ˆ';
            } else {
                input.type = 'password';
                icon.innerText = 'ğŸ‘ï¸';
            }
        }

        function toggleTMDBTokenVisibility() {
            const input = document.getElementById('tmdb_token_input');
            const icon = document.getElementById('tmdb-token-toggle-icon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.innerText = 'ğŸ™ˆ';
            } else {
                input.type = 'password';
                icon.innerText = 'ğŸ‘ï¸';
            }
        }

        function toggleAniListTokenVisibility() {
            const input = document.getElementById('anilist_token_input');
            const icon = document.getElementById('anilist-token-toggle-icon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.innerText = 'ğŸ™ˆ';
            } else {
                input.type = 'password';
                icon.innerText = 'ğŸ‘ï¸';
            }
        }

        function openAniListAuth() {
            const clientId = document.getElementById('anilist_client_id').value;
            if (!clientId) {
                alert('è¯·å…ˆè¾“å…¥ Client ID');
                return;
            }
            const url = `https://anilist.co/api/v2/oauth/authorize?client_id=${clientId}&response_type=token`;
            window.open(url, '_blank');
        }

        function toggleJellyfinTokenVisibility() {
            const input = document.getElementById('jellyfin_api_key_input');
            const icon = document.getElementById('jellyfin-token-toggle-icon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.innerText = 'ğŸ™ˆ';
            } else {
                input.type = 'password';
                icon.innerText = 'ğŸ‘ï¸';
            }
        }



        function togglePikPakPasswordVisibility() {
            const input = document.getElementById('pikpak_password_input');
            const icon = document.getElementById('pikpak-pwd-toggle-icon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.innerText = 'ğŸ™ˆ';
            } else {
                input.type = 'password';
                icon.innerText = 'ğŸ‘ï¸';
            }
        }
    </script>
</div>

{{ if not .SkipLayout }}{{ template "footer.html" . }}{{ end }}