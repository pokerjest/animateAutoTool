{{ define "calendar.html" }}
{{ if not .SkipLayout }}{{ template "header.html" . }}{{ end }}

<div class="min-h-screen text-gray-800 font-sans selection:bg-pink-200 selection:text-pink-900" x-data="{
    currentTab: {{ if .Today }}{{ .Today }}{{ else }}new Date().getDay() || 7{{ end }},

    init() {
        console.log('Calendar initialized. Today:', this.currentTab);
    },

    showDetailModal: false,
    showSubscribeModal: false,

    selectedAnime: null,
    episodes: [],
    filteredEpisodes: [],
    subgroups: [],
    selectedSubgroup: 'all',
    subscribeGroup: '',
    mikanId: null,

    loadingEpisodes: false,
    errorMessage: '',

    openDetail(anime) {
        console.log('Open Detail:', anime);
        this.selectedAnime = anime;
        this.showDetailModal = true;
        this.episodes = [];
        this.filteredEpisodes = [];
        this.subgroups = [];
        this.selectedSubgroup = 'all';
        this.loadingEpisodes = false;
        this.errorMessage = '';
        this.mikanId = null;
    },

    closeDetail() {
        this.showDetailModal = false;
    },

    async watchNow() {
        if(!this.selectedAnime) return;
        this.loadingEpisodes = true;
        this.episodes = [];
        this.filteredEpisodes = [];
        this.errorMessage = '';

        try {
            const resp = await fetch('/api/mikan/episodes?bangumiId=' + this.selectedAnime.id + '&title=' + encodeURIComponent(this.selectedAnime.name));
            if (resp.ok) {
                const data = await resp.json();
                if (data.episodes) {
                    this.episodes = data.episodes;
                    this.mikanId = data.mikanId;
                } else {
                    this.episodes = Array.isArray(data) ? data : [];
                }

                this.extractSubgroups();
                this.filterEpisodes();

                this.$nextTick(() => {
                    const el = document.getElementById('episode-list-section');
                    if (el) el.scrollIntoView({ behavior: 'smooth' });
                });
            } else {
                console.error('Failed to load episodes');
                this.errorMessage = 'æ— æ³•è·å–èµ„æºåˆ—è¡¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•';
            }
        } catch (e) {
            console.error(e);
            this.errorMessage = 'ç½‘ç»œè¯·æ±‚å¤±è´¥ (' + e.message + ')';
        } finally {
            this.loadingEpisodes = false;
        }
    },

    extractSubgroups() {
        const groups = new Set();
        const regex = /^\[([^\]]+)\]/;

        this.episodes.forEach(ep => {
            const match = ep.title.match(regex);
            if (match && match[1]) {
                groups.add(match[1]);
            }
        });
        this.subgroups = Array.from(groups).sort();
    },

    filterEpisodes() {
        if (this.selectedSubgroup === 'all') {
            this.filteredEpisodes = this.episodes;
        } else {
            this.filteredEpisodes = this.episodes.filter(ep => ep.title.includes('[' + this.selectedSubgroup + ']'));
        }
    },

    async openSubscribe() {
        this.showDetailModal = false;
        this.showSubscribeModal = true;

        if (this.episodes.length === 0) {
            await this.watchNow();
        }

        const validID = this.mikanId || this.selectedAnime.id;
        const rss = 'https://mikanani.me/RSS/Bangumi?bangumiId=' + validID;

        this.subscribeGroup = this.selectedSubgroup !== 'all' ? this.selectedSubgroup : '';
        this.selectedAnime.rss = rss;

        this.$nextTick(() => {
            const el = document.getElementById('calendar-preview-results');
            if (el) el.innerHTML = '';
        });
    },

    async previewRSS() {
        const rssInput = document.getElementById('calendar-rss-url');
        const url = rssInput ? rssInput.value : '';
        if (!url) return;

        const previewContainer = document.getElementById('calendar-preview-results');
        if (!previewContainer) return;

        previewContainer.innerHTML = '<div class=\'p-8 text-center text-gray-400 flex flex-col items-center gap-2\'>' +
        '<div class=\'animate-spin h-6 w-6 border-2 border-pink-500 border-t-transparent rounded-full\'></div>' +
        '<span>æ­£åœ¨è§£æé¢„è§ˆ...</span>' +
        '</div>';

        try {
            const resp = await fetch('/api/preview?RSSUrl=' + encodeURIComponent(url));
            if (resp.ok) {
                const html = await resp.text();
                previewContainer.innerHTML = html;
            } else {
                previewContainer.innerHTML = '<div class=\'p-4 text-center text-red-500 bg-red-50 rounded-lg\'>è§£æå¤±è´¥: ' + resp.statusText + '</div>';
            }
        } catch (e) {
            previewContainer.innerHTML = '<div class=\'p-4 text-center text-red-500 bg-red-50 rounded-lg\'>ç½‘ç»œé”™è¯¯: ' + e.message + '</div>';
        }
    },

    async playEpisode(magnet) {
        try {
            const resp = await fetch('/api/play/magnet', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ magnet: magnet })
            });
            if (resp.ok) {
                const data = await resp.json();
                window.open(data.alistViewUrl, '_blank');
            } else {
                console.error('æ·»åŠ ä»»åŠ¡å¤±è´¥');
                alert('æ’­æ”¾å¤±è´¥: æ— æ³•æ·»åŠ ä¸‹è½½ä»»åŠ¡');
            }
        } catch (e) {
            console.error(e);
            alert('è¯·æ±‚å¤±è´¥');
        }
    }
}">
    <!-- Main Content Container with Sticky Header -->
    <div class="-m-8"> <!-- Negate global padding -->

        <!-- Header & Navigation -->
        <div
            class="sticky top-0 z-40 bg-white/90 backdrop-blur-xl px-8 py-4 border-b border-white/40 shadow-sm transition-all duration-300">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 max-w-[2000px] mx-auto">
                <div class="text-center md:text-left">
                    <h1
                        class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-br from-pink-500 to-violet-600 drop-shadow-sm flex items-center gap-3">
                        <span>æ¯æ—¥æ”¾é€</span>
                        <span
                            class="text-xs font-medium text-gray-400 bg-gray-100 px-2 py-1 rounded-full border border-gray-200">New
                            Era</span>
                    </h1>
                </div>

                <!-- Desktop/Tablet Tabs -->
                <div
                    class="hidden md:flex bg-gray-100/80 p-1.5 rounded-full border border-gray-200/50 shadow-inner overflow-hidden backdrop-blur-md">
                    {{ range .Calendar }}
                    <button @click="currentTab = {{.Weekday.ID}}"
                        :class="currentTab === {{.Weekday.ID}} ? 'bg-white text-pink-600 shadow-md ring-1 ring-black/5' : 'text-gray-500 hover:text-gray-700 hover:bg-gray-200/50'"
                        class="px-6 py-2 rounded-full transition-all duration-300 font-bold text-sm relative group overflow-hidden">
                        <span class="relative z-10">{{ .Weekday.CN }}</span>
                        <div x-show="currentTab === {{.Weekday.ID}}"
                            class="absolute inset-x-0 bottom-0 h-0.5 bg-pink-500/50"></div>
                    </button>
                    {{ end }}
                </div>
            </div>

            <!-- Mobile Tabs -->
            <div class="md:hidden mt-4 flex overflow-x-auto gap-3 pb-2 scrollbar-hide snap-x px-2">
                {{ range .Calendar }}
                <button @click="currentTab = {{.Weekday.ID}}"
                    class="snap-start shrink-0 px-5 py-2 rounded-full text-sm font-bold transition-all duration-300 border"
                    :class="currentTab === {{.Weekday.ID}} 
                        ? 'bg-pink-500 text-white border-pink-500 shadow-lg shadow-pink-500/30' 
                        : 'bg-white/80 backdrop-blur text-gray-600 border-gray-200 hover:border-pink-200'">
                    {{ .Weekday.CN }}
                </button>
                {{ end }}
            </div>
        </div>

        <!-- Content Area -->
        <div class="p-8 min-h-screen"> <!-- Restore padding -->
            <div class="container mx-auto">
                <!-- Error Alert -->
                {{ if .Error }}
                <div
                    class="mx-auto max-w-2xl bg-red-50/90 backdrop-blur border border-red-200 text-red-700 p-4 rounded-2xl shadow-lg flex items-center gap-4 animate-bounce-in mb-8">
                    <div class="p-2 bg-red-100 rounded-full">âš ï¸</div>
                    <div>
                        <p class="font-bold">è·å–æ•°æ®å¤±è´¥</p>
                        <p class="text-sm opacity-80">{{ .Error }}</p>
                    </div>
                </div>
                {{ else }}

                <!-- Content Grid -->
                <div class="relative">
                    {{ range .Calendar }}
                    <div x-show="currentTab === {{.Weekday.ID}}" x-transition:enter="transition ease-out duration-500"
                        x-transition:enter-start="opacity-0 translate-y-8 blur-sm"
                        x-transition:enter-end="opacity-100 translate-y-0 blur-0"
                        class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6 sm:gap-8">

                        {{ if .Items }}
                        {{ range .Items }}
                        {{ $isSubscribed := index $.SubMap .ID }}

                        <!-- Anime Card -->
                        <div class="group relative perspective-1000 cursor-pointer" @click="openDetail({
                                name: {{if .NameCN}}{{.NameCN | json}}{{else}}{{.Name | json}}{{end}}, 
                                id: {{.ID | json}}, 
                                image: {{.Images.Large | json}}, 
                                score: {{.Rating.Score | json}}, 
                                date: {{.Date | json}}, 
                                summary: {{.Summary | json}} 
                            })">

                            <div
                                class="relative bg-white rounded-[20px] overflow-hidden shadow-sm hover:shadow-2xl hover:shadow-pink-500/10 transition-all duration-500 transform group-hover:-translate-y-2 group-hover:scale-[1.02] border border-gray-100 h-full flex flex-col">

                                <!-- Image Container -->
                                <div class="aspect-[11/16] relative overflow-hidden bg-gray-50">
                                    <img src="{{ .Images.Large }}"
                                        alt="{{ if .NameCN }}{{ .NameCN }}{{ else }}{{ .Name }}{{ end }}"
                                        class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                                        loading="lazy" onerror="this.src='/static/img/placeholder.png'">

                                    <!-- Rating Badge -->
                                    {{ if .Rating.Score }}
                                    <div
                                        class="absolute top-2 left-2 bg-black/40 backdrop-blur-md text-white text-[10px] font-bold px-2 py-1 rounded-full flex items-center gap-1 shadow-sm border border-white/10 group-hover:bg-black/60 transition-colors">
                                        <span class="text-yellow-400">â˜…</span> {{ .Rating.Score }}
                                    </div>
                                    {{ end }}

                                    <!-- Status Badge -->
                                    {{ if or (gt $isSubscribed.BangumiStatus 0) (gt $isSubscribed.ID 0) }}
                                    {{ if eq $isSubscribed.BangumiStatus 1 }}
                                    <div
                                        class="absolute top-2 right-2 bg-pink-400 text-white text-[10px] font-bold px-2 py-1 rounded-lg shadow-lg ring-2 ring-white/20">
                                        æƒ³çœ‹</div>
                                    {{ else if eq $isSubscribed.BangumiStatus 2 }}
                                    <div
                                        class="absolute top-2 right-2 bg-blue-500 text-white text-[10px] font-bold px-2 py-1 rounded-lg shadow-lg ring-2 ring-white/20">
                                        çœ‹è¿‡</div>
                                    {{ else if eq $isSubscribed.BangumiStatus 3 }}
                                    <div
                                        class="absolute top-2 right-2 bg-emerald-500 text-white text-[10px] font-bold px-2 py-1 rounded-lg shadow-lg ring-2 ring-white/20">
                                        åœ¨çœ‹</div>
                                    {{ else if eq $isSubscribed.BangumiStatus 4 }}
                                    <div
                                        class="absolute top-2 right-2 bg-gray-500 text-white text-[10px] font-bold px-2 py-1 rounded-lg shadow-lg ring-2 ring-white/20">
                                        æç½®</div>
                                    {{ else if eq $isSubscribed.BangumiStatus 5 }}
                                    <div
                                        class="absolute top-2 right-2 bg-red-500 text-white text-[10px] font-bold px-2 py-1 rounded-lg shadow-lg ring-2 ring-white/20">
                                        æŠ›å¼ƒ</div>
                                    {{ else }}
                                    <!-- Fallback: Local Sub subscription without Bangumi Status -->
                                    <div
                                        class="absolute top-2 right-2 bg-emerald-500 text-white text-[10px] font-bold px-2 py-1 rounded-lg shadow-lg ring-2 ring-white/20">
                                        åœ¨çœ‹</div>
                                    {{ end }}
                                    {{ end }}

                                    <!-- Hover Overlay with Simple View Action -->
                                    <div
                                        class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                        <span
                                            class="bg-white/90 backdrop-blur text-gray-900 px-4 py-2 rounded-full font-bold text-sm shadow-lg transform scale-95 group-hover:scale-100 transition-all">
                                            æŸ¥çœ‹è¯¦æƒ…
                                        </span>
                                    </div>
                                </div>

                                <!-- Info Section -->
                                <div class="p-3 relative bg-white flex-1 flex flex-col justify-between">
                                    <h3 class="font-bold text-gray-800 text-sm leading-snug group-hover:text-pink-600 transition-colors"
                                        title="{{ if .NameCN }}{{ .NameCN }}{{ else }}{{ .Name }}{{ end }}">
                                        {{ if .NameCN }}{{ .NameCN }}{{ else }}{{ .Name }}{{ end }}
                                    </h3>

                                    <div
                                        class="flex items-center justify-between mt-1 pt-2 border-t border-gray-50 text-[10px] text-gray-400">
                                        <span>{{ if .Date }}{{ .Date }}{{ else }}è¿è½½ä¸­{{ end }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {{ end }}
                        {{ else }}
                        <!-- Empty State -->
                        <div class="col-span-full flex flex-col items-center justify-center py-32 opacity-60">
                            <div
                                class="w-32 h-32 bg-gray-100 rounded-full flex items-center justify-center mb-6 animate-pulse">
                                <span class="text-6xl grayscale filter">ğŸ“º</span>
                            </div>
                            <p class="text-xl font-bold text-gray-400">æœ¬å‘¨è¯¥æ—¥æš‚æ— æ”¾é€</p>
                        </div>
                        {{ end }}
                    </div>
                    {{ end }}
                </div>
                {{ end }}
            </div>

            <!-- NEW: Anime Detail Modal -->
            <div x-show="showDetailModal" style="display: none;" class="fixed inset-0 z-[60] overflow-y-auto"
                role="dialog" aria-modal="true" x-cloak>
                <div class="flex items-center justify-center min-h-screen p-4 text-center">

                    <!-- Backdrop -->
                    <div x-show="showDetailModal" x-transition:enter="ease-out duration-300"
                        x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
                        x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100"
                        x-transition:leave-end="opacity-0"
                        class="fixed inset-0 bg-black/60 backdrop-blur-sm transition-opacity" @click="closeDetail()">
                    </div>

                    <!-- Modal Panel -->
                    <div x-show="showDetailModal" x-transition:enter="ease-out duration-300"
                        x-transition:enter-start="opacity-0 translate-y-8 scale-95"
                        x-transition:enter-end="opacity-100 translate-y-0 scale-100"
                        x-transition:leave="ease-in duration-200"
                        x-transition:leave-start="opacity-100 translate-y-0 scale-100"
                        x-transition:leave-end="opacity-0 translate-y-8 scale-95"
                        class="relative inline-block align-middle bg-white w-full max-w-4xl rounded-3xl text-left overflow-hidden shadow-2xl transform transition-all">

                        <!-- Header Image -->
                        <div class="relative h-64 md:h-80 w-full overflow-hidden bg-gray-900 group">
                            <img :src="selectedAnime?.image"
                                class="w-full h-full object-cover opacity-80 group-hover:scale-105 transition duration-700">
                            <div class="absolute inset-0 bg-gradient-to-t from-black via-black/40 to-transparent"></div>

                            <button @click="closeDetail()"
                                class="absolute top-4 right-4 bg-black/20 hover:bg-black/40 text-white rounded-full p-2 backdrop-blur transition z-20">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>

                            <div class="absolute bottom-0 left-0 p-8 w-full z-10">
                                <div class="flex items-end gap-6 text-white">
                                    <!-- Poster Shadow -->
                                    <div
                                        class="w-32 h-48 rounded-xl overflow-hidden shadow-2xl border-2 border-white/20 hidden md:block flex-shrink-0 bg-gray-800">
                                        <img :src="selectedAnime?.image" class="w-full h-full object-cover">
                                    </div>

                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span
                                                class="bg-pink-500 text-white text-xs font-bold px-2 py-0.5 rounded shadow-lg"
                                                x-show="selectedAnime?.score">
                                                <span x-text="selectedAnime?.score"></span> åˆ†
                                            </span>
                                            <span class="bg-white/20 backdrop-blur text-xs px-2 py-0.5 rounded"
                                                x-text="selectedAnime?.date"></span>
                                        </div>
                                        <h2 class="text-3xl md:text-4xl font-black leading-tight drop-shadow-lg"
                                            x-text="selectedAnime?.name"></h2>
                                        <!-- No summary available in model usually, can add if fetched -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Content Area -->
                        <div class="p-6 md:p-8 bg-white min-h-[300px]">

                            <!-- Action Buttons -->
                            <div class="flex gap-4 mb-8">
                                <button @click="watchNow()"
                                    class="flex-1 bg-gradient-to-r from-pink-500 to-rose-600 text-white py-3 rounded-xl font-bold text-lg shadow-lg hover:shadow-pink-500/30 hover:-translate-y-0.5 active:translate-y-0 transition-all flex items-center justify-center gap-2">
                                    <span>â–¶ï¸</span> ç«‹å³è§‚çœ‹
                                </button>
                                <button @click="openSubscribe()"
                                    class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 py-3 rounded-xl font-bold text-lg transition-all flex items-center justify-center gap-2">
                                    <span>â¤ï¸</span> è®¢é˜…è¿½ç•ª
                                </button>
                            </div>

                            <!-- Episode Section -->
                            <div id="episode-list-section" x-show="episodes.length > 0 || loadingEpisodes" x-transition>

                                <div class="flex items-center justify-between mb-4 border-b border-gray-100 pb-2">
                                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                        <span>ğŸ“º</span> é€‰é›†æ’­æ”¾
                                    </h3>

                                    <!-- Subgroup Filter -->
                                    <div x-show="subgroups.length > 0" class="flex items-center gap-2">
                                        <span class="text-sm text-gray-400">ç­›é€‰ç‰ˆæœ¬:</span>
                                        <select x-model="selectedSubgroup" @change="filterEpisodes()"
                                            class="bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-pink-500 focus:border-pink-500 block p-2 outline-none font-bold">
                                            <option value="all">å…¨éƒ¨å­—å¹•ç»„</option>
                                            <template x-for="g in subgroups" :key="g">
                                                <option :value="g" x-text="g"></option>
                                            </template>
                                        </select>
                                    </div>
                                </div>

                                <!-- Loading State -->
                                <div x-show="loadingEpisodes" class="py-12 text-center text-gray-400">
                                    <div
                                        class="animate-spin h-8 w-8 border-4 border-pink-500 border-t-transparent rounded-full mx-auto mb-3">
                                    </div>
                                    <p>æ­£åœ¨è·å–æœ€æ–°èµ„æº...</p>
                                </div>

                                <!-- Error State -->
                                <div x-show="errorMessage"
                                    class="py-8 text-center text-red-500 bg-red-50 rounded-xl mb-4">
                                    <p class="font-bold">âš ï¸ è·å–å¤±è´¥</p>
                                    <p class="text-sm mt-1" x-text="errorMessage"></p>
                                </div>

                                <!-- List -->
                                <div x-show="!loadingEpisodes && filteredEpisodes.length > 0"
                                    class="space-y-2 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                                    <template x-for="ep in filteredEpisodes" :key="ep.magnet">
                                        <div class="bg-gray-50 hover:bg-pink-50 border border-gray-100 hover:border-pink-200 rounded-xl p-3 cursor-pointer transition flex items-center gap-3 group"
                                            @click="playEpisode(ep.magnet)">
                                            <div
                                                class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-lg shadow-sm group-hover:scale-110 transition">
                                                â–¶ï¸
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <h4 class="font-medium text-gray-700 text-sm truncate group-hover:text-pink-600 transition"
                                                    x-text="ep.title"></h4>
                                                <div
                                                    class="flex items-center gap-2 mt-1 text-xs text-gray-400 font-mono">
                                                    <span class="bg-white px-1 rounded shadow-sm"
                                                        x-text="ep.size"></span>
                                                    <span x-text="ep.pub_date"></span>
                                                </div>
                                            </div>
                                            <div
                                                class="opacity-0 group-hover:opacity-100 transition px-2 text-pink-500 text-sm font-bold">
                                                æ’­æ”¾
                                            </div>
                                        </div>
                                    </template>
                                </div>

                                <!-- Empty State (No Episodes at all) -->
                                <div x-show="!loadingEpisodes && episodes.length === 0 && !errorMessage"
                                    class="py-12 text-center text-gray-400 flex flex-col items-center">
                                    <div class="text-4xl mb-2">ğŸ“­</div>
                                    <p class="font-bold">æœªæ‰¾åˆ°èµ„æº</p>
                                    <p class="text-xs mt-1">èœœæŸ‘ç«™æš‚æ— è¯¥ç•ªå‰§ RSS è®¢é˜…æº</p>
                                </div>

                                <!-- Empty Filter State -->
                                <div x-show="!loadingEpisodes && episodes.length > 0 && filteredEpisodes.length === 0"
                                    class="py-8 text-center text-gray-400">
                                    æœªæ‰¾åˆ°ç¬¦åˆè¯¥ç­›é€‰æ¡ä»¶çš„èµ„æº
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <!-- Subscribe Modal (Reuse old modalOpen/showSubscribeModal logic) -->
            <div x-show="showSubscribeModal" style="display: none;" class="fixed inset-0 z-[70] overflow-y-auto"
                role="dialog" aria-modal="true" x-cloak>
                <div class="flex items-center justify-center min-h-screen px-4 pb-20 text-center sm:block sm:p-0">

                    <div x-show="showSubscribeModal" x-transition:enter="ease-out duration-300"
                        x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
                        x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100"
                        x-transition:leave-end="opacity-0"
                        class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity"
                        @click="showSubscribeModal = false">
                    </div>

                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

                    <div x-show="showSubscribeModal" x-transition:enter="ease-out duration-300"
                        x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                        x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                        x-transition:leave="ease-in duration-200"
                        x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                        x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                        class="inline-block align-middle bg-white rounded-3xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:max-w-lg w-full border border-gray-100">

                        <div class="relative bg-gradient-to-br from-pink-500 to-rose-600 p-6 sm:p-8">
                            <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-white/10 rounded-full blur-2xl">
                            </div>
                            <h3 class="text-2xl font-black text-white relative z-10">æ·»åŠ è®¢é˜…</h3>
                            <p class="text-pink-100 text-sm mt-1 relative z-10">å¼€å§‹è¿½è¸ªè¿™éƒ¨ç•ªå‰§çš„æ›´æ–°</p>
                            <button @click="showSubscribeModal = false"
                                class="absolute top-4 right-4 text-pink-100 hover:text-white bg-white/20 hover:bg-white/30 rounded-full p-2 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>

                        <div class="p-6 sm:p-8 bg-white">
                            <form hx-post="/api/subscriptions" hx-swap="none"
                                @htmx:after-request="showSubscribeModal = false; window.location.reload()">
                                <div class="space-y-6">
                                    <div class="space-y-2">
                                        <label
                                            class="block text-xs font-bold text-gray-500 uppercase tracking-wider">ç•ªå‰§åç§°</label>
                                        <input type="text" name="Title" :value="selectedAnime?.name"
                                            class="w-full px-4 py-3 rounded-xl border-gray-200 bg-gray-50 text-gray-800 font-bold focus:border-pink-500 focus:ring-pink-500 transition-all">
                                    </div>

                                    <!-- Subgroup Filter -->
                                    <div class="space-y-2">
                                        <label
                                            class="block text-xs font-bold text-gray-500 uppercase tracking-wider">å­—å¹•ç»„è¿‡æ»¤
                                            (å¯é€‰)</label>
                                        <div class="relative">
                                            <!-- Toggle Input/Select -->
                                            <div class="flex gap-2 mb-2">
                                                <select x-model="subscribeGroup"
                                                    class="w-full px-4 py-3 rounded-xl border-gray-200 bg-gray-50 text-gray-800 font-bold focus:border-pink-500 focus:ring-pink-500 transition-all text-sm appearance-none cursor-pointer">
                                                    <option value="">-- é€‰æ‹©å­—å¹•ç»„ (å…¨éƒ¨) --</option>
                                                    <template x-for="g in subgroups">
                                                        <option :value="g" x-text="g"></option>
                                                    </template>
                                                </select>
                                                <!-- Fallback Input Toggle if needed, but simple is better -->
                                            </div>

                                            <!-- Hidden Input for Form Submission -->
                                            <input type="text" name="SubtitleGroup" x-model="subscribeGroup"
                                                placeholder="æˆ–æ‰‹åŠ¨è¾“å…¥å­—å¹•ç»„åç§°..."
                                                class="w-full px-4 py-2 rounded-lg border-gray-100 bg-white text-gray-400 text-xs focus:text-gray-800 transition-all mb-1"
                                                title="æ‰‹åŠ¨ä¿®æ­£å­—å¹•ç»„åç§°">
                                            <p class="text-[10px] text-gray-400 ml-1">ä¸Šæ–¹é€‰æ‹©æˆ–æ‰‹åŠ¨è¾“å…¥ã€‚ç•™ç©ºåˆ™ä¸‹è½½æ‰€æœ‰ç‰ˆæœ¬ã€‚</p>
                                        </div>
                                    </div>

                                    <div class="space-y-2">
                                        <div class="flex justify-between items-center">
                                            <label
                                                class="block text-xs font-bold text-gray-500 uppercase tracking-wider">RSS
                                                é“¾æ¥
                                                (Mikan Project)</label>
                                            <div class="flex items-center gap-2">
                                                <button type="button" @click="previewRSS()"
                                                    class="text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded-lg bg-gray-100 text-gray-500 hover:bg-pink-500 hover:text-white transition-all disabled:opacity-50">
                                                    é¢„è§ˆå†…å®¹
                                                </button>
                                                <button type="button"
                                                    @click="document.getElementById('calendar-preview-results').innerHTML = ''"
                                                    class="text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded-lg bg-gray-50 text-gray-300 hover:text-red-400 transition-all">
                                                    æ¸…é™¤
                                                </button>
                                            </div>
                                        </div>
                                        <div class="relative">
                                            <input type="text" id="calendar-rss-url" name="RSSUrl"
                                                :value="selectedAnime?.rss" placeholder="ç²˜è´´ RSS é“¾æ¥..."
                                                class="w-full px-4 py-3 rounded-xl border-gray-200 bg-gray-50 focus:border-pink-500 focus:ring-pink-500 transition-all text-sm pr-10">
                                            <div id="cal-preview-loading"
                                                class="htmx-indicator absolute inset-y-0 right-3 flex items-center">
                                                <div
                                                    class="animate-spin h-5 w-5 border-2 border-pink-500 border-t-transparent rounded-full">
                                                </div>
                                            </div>
                                        </div>
                                        <div id="calendar-preview-results" class="mt-2 rounded-xl overflow-hidden">
                                        </div>
                                        <p class="text-xs text-gray-400">å·²è‡ªåŠ¨ç”Ÿæˆ RSS é“¾æ¥ (é»˜è®¤èšåˆ)ã€‚</p>
                                    </div>
                                </div>

                                <div class="mt-8 flex justify-end gap-3">
                                    <button type="button" @click="showSubscribeModal = false"
                                        class="px-6 py-3 rounded-xl text-gray-500 font-bold hover:bg-gray-50 transition-colors">å–æ¶ˆ</button>
                                    <button type="submit"
                                        class="px-8 py-3 rounded-xl bg-gradient-to-r from-pink-500 to-rose-600 text-white font-bold hover:shadow-lg hover:shadow-pink-500/30 transform active:scale-95 transition-all">ç¡®è®¤è®¢é˜…</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <style>
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }

            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }

            .perspective-1000 {
                perspective: 1000px;
            }

            .animate-bounce-in {
                animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            }

            .custom-scrollbar::-webkit-scrollbar {
                width: 6px;
            }

            .custom-scrollbar::-webkit-scrollbar-track {
                background: transparent;
            }

            .custom-scrollbar::-webkit-scrollbar-thumb {
                background-color: #e5e7eb;
                border-radius: 20px;
            }

            .custom-scrollbar::-webkit-scrollbar-thumb:hover {
                background-color: #d1d5db;
            }

            @keyframes bounceIn {
                0% {
                    transform: scale(0.9) opacity(0);
                }

                100% {
                    transform: scale(1) opacity(1);
                }
            }

            [x-cloak] {
                display: none !important;
            }
        </style>

        {{ if not .SkipLayout }}{{ template "footer.html" . }}{{ end }}

        {{ if not .Error }}

        {{ end }}
        {{ end }}