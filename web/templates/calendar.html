{{ define "calendar.html" }}
{{ if not .SkipLayout }}{{ template "header.html" . }}{{ end }}

<div class="min-h-screen text-gray-800 font-sans selection:bg-pink-200 selection:text-pink-900" x-data="{ 
         currentTab: {{.Today}},
         modalOpen: false,
         selectedAnime: null,
         
         openSubscribeModal(anime) {
             this.selectedAnime = anime;
             this.modalOpen = true;
         }
     }">

    <!-- Main Content Container with Sticky Header -->
    <div class="container mx-auto px-4 pb-12">

        <!-- Header & Navigation -->
        <div
            class="sticky top-0 z-40 pt-6 pb-4 bg-white/80 backdrop-blur-xl -mx-4 px-4 mb-2 transition-all duration-300 border-b border-white/40">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="text-center md:text-left">
                    <h1
                        class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-br from-pink-500 to-violet-600 drop-shadow-sm">
                        æ¯æ—¥æ”¾é€
                    </h1>
                </div>

                <!-- Desktop/Tablet Tabs -->
                <div
                    class="hidden md:flex bg-gray-100/50 p-1 rounded-2xl border border-gray-200/50 shadow-inner overflow-hidden">
                    {{ range .Calendar }}
                    <button @click="currentTab = {{.Weekday.ID}}"
                        :class="currentTab === {{.Weekday.ID}} ? 'bg-white text-pink-600 shadow-md ring-1 ring-black/5' : 'text-gray-500 hover:text-gray-700 hover:bg-gray-200/50'"
                        class="px-5 py-2 rounded-xl transition-all duration-300 font-bold text-sm relative group overflow-hidden">
                        <span class="relative z-10">{{ .Weekday.CN }}</span>
                        <div x-show="currentTab === {{.Weekday.ID}}"
                            class="absolute inset-x-0 bottom-0 h-0.5 bg-pink-500/50"></div>
                    </button>
                    {{ end }}
                </div>
            </div>

            <!-- Mobile Tabs -->
            <div class="md:hidden mt-4 flex overflow-x-auto gap-3 pb-2 scrollbar-hide snap-x">
                {{ range .Calendar }}
                <button @click="currentTab = {{.Weekday.ID}}"
                    class="snap-start shrink-0 px-4 py-2 rounded-full text-sm font-bold transition-all duration-300 border"
                    :class="currentTab === {{.Weekday.ID}} 
                        ? 'bg-pink-500 text-white border-pink-500 shadow-lg shadow-pink-500/30' 
                        : 'bg-white text-gray-600 border-gray-200 hover:border-pink-200'">
                    {{ .Weekday.CN }}
                </button>
                {{ end }}
            </div>
        </div>

        <!-- Error Alert -->
        {{ if .Error }}
        <div
            class="mt-6 mx-auto max-w-2xl bg-red-50/90 backdrop-blur border border-red-200 text-red-700 p-4 rounded-2xl shadow-lg flex items-center gap-4 animate-bounce-in">
            <div class="p-2 bg-red-100 rounded-full">âš ï¸</div>
            <div>
                <p class="font-bold">è·å–æ•°æ®å¤±è´¥</p>
                <p class="text-sm opacity-80">{{ .Error }}</p>
            </div>
        </div>
        {{ else }}

        <!-- Content Grid -->
        <div class="min-h-[60vh] mt-4 relative">
            {{ range .Calendar }}
            <div x-show="currentTab === {{.Weekday.ID}}" x-transition:enter="transition ease-out duration-500"
                x-transition:enter-start="opacity-0 translate-y-8 blur-sm"
                x-transition:enter-end="opacity-100 translate-y-0 blur-0"
                class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6 sm:gap-8">

                {{ if .Items }}
                {{ range .Items }}
                {{ $isSubscribed := index $.SubMap .ID }}

                <!-- ID: {{.ID}} -->
                <div class="group relative perspective-1000"
                    @click="{{ if $isSubscribed }}window.location.href='/subscriptions'{{ else }}openSubscribeModal({name: '{{if .NameCN}}{{.NameCN}}{{else}}{{.Name}}{{end}}', id: {{.ID}} }){{ end }}">

                    <div
                        class="relative bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-2xl hover:shadow-pink-500/20 transition-all duration-500 transform group-hover:-translate-y-2 group-hover:scale-[1.02] border border-gray-100/50">

                        <!-- Image Container -->
                        <div class="aspect-[11/16] relative overflow-hidden bg-gray-100">
                            <img src="{{ .Images.Large }}"
                                alt="{{ if .NameCN }}{{ .NameCN }}{{ else }}{{ .Name }}{{ end }}"
                                class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                                loading="lazy" onerror="this.src='/static/img/placeholder.png'">

                            <!-- Rating Badge -->
                            {{ if .Rating.Score }}
                            <div
                                class="absolute top-2 left-2 bg-black/60 backdrop-blur-md text-white text-[10px] font-bold px-2 py-1 rounded-lg flex items-center gap-1 shadow-sm border border-white/10">
                                <span class="text-yellow-400">â˜…</span> {{ .Rating.Score }}
                            </div>
                            {{ end }}

                            <!-- Status Badge -->
                            {{ if $isSubscribed }}
                            <div
                                class="absolute top-2 right-2 bg-emerald-500 text-white text-[10px] font-bold px-2 py-1 rounded-lg shadow-lg flex items-center gap-1 ring-2 ring-white/20">
                                âœ“ è¿½ç•ªä¸­
                            </div>
                            {{ end }}

                            <!-- Hover Overlay -->
                            <div
                                class="absolute inset-0 bg-gradient-to-t from-gray-900 via-gray-900/40 to-transparent opacity-0 group-hover:opacity-100 transition-all duration-300 flex flex-col justify-end p-4">
                                {{ if not $isSubscribed }}
                                <div
                                    class="transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300 delay-75">
                                    <button
                                        class="w-full bg-gradient-to-r from-pink-500 to-rose-500 text-white py-2.5 rounded-xl font-bold text-sm shadow-lg hover:shadow-pink-500/50 active:scale-95 transition-all flex items-center justify-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20"
                                            fill="currentColor">
                                            <path fill-rule="evenodd"
                                                d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z"
                                                clip-rule="evenodd" />
                                        </svg>
                                        ç«‹å³è®¢é˜…
                                    </button>
                                </div>
                                {{ end }}
                            </div>
                        </div>

                        <!-- Info Section -->
                        <div class="p-3 relative bg-white h-24 flex flex-col justify-between">
                            <h3 class="font-bold text-gray-800 text-sm line-clamp-2 leading-snug group-hover:text-pink-600 transition-colors"
                                title="{{ if .NameCN }}{{ .NameCN }}{{ else }}{{ .Name }}{{ end }}">
                                {{ if .NameCN }}{{ .NameCN }}{{ else }}{{ .Name }}{{ end }}
                            </h3>

                            <div class="flex items-center justify-between mt-2 pt-2 border-t border-gray-50">
                                {{ if .Collection.Doing }}
                                <div
                                    class="flex items-center gap-1 text-[10px] font-medium text-gray-400 bg-gray-50 px-1.5 py-0.5 rounded-md">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-pink-400"
                                        viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                                        <path fill-rule="evenodd"
                                            d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z"
                                            clip-rule="evenodd" />
                                    </svg>
                                    {{ .Collection.Doing }} åœ¨çœ‹
                                </div>
                                {{ end }}

                                {{ if .Date }}
                                <span class="text-[10px] font-mono text-gray-300">{{ .Date }}</span>
                                {{ end }}
                            </div>
                        </div>
                    </div>
                </div>
                {{ end }}
                {{ else }}
                <!-- Empty State -->
                <div class="col-span-full flex flex-col items-center justify-center py-32 opacity-60">
                    <div class="w-32 h-32 bg-gray-100 rounded-full flex items-center justify-center mb-6 animate-pulse">
                        <span class="text-6xl grayscale filter">ğŸ“º</span>
                    </div>
                    <p class="text-xl font-bold text-gray-400">æœ¬å‘¨è¯¥æ—¥æš‚æ— æ”¾é€</p>
                    <p class="text-sm text-gray-400 mt-2">å»çœ‹çœ‹å…¶ä»–æ—¥æœŸçš„èŠ‚ç›®å§</p>
                </div>
                {{ end }}
            </div>
            {{ end }}
        </div>
        {{ end }}
    </div>

    <!-- Quick Subscribe Modal -->
    <div x-show="modalOpen" style="display: none;" class="fixed inset-0 z-[60] overflow-y-auto" role="dialog"
        aria-modal="true">
        <div class="flex items-center justify-center min-h-screen px-4 pb-20 text-center sm:block sm:p-0">

            <div x-show="modalOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0"
                x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200"
                x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
                class="fixed inset-0 bg-gray-900/40 backdrop-blur-sm transition-opacity" @click="modalOpen = false">
            </div>

            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

            <div x-show="modalOpen" x-transition:enter="ease-out duration-300"
                x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                x-transition:leave="ease-in duration-200"
                x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                class="inline-block align-middle bg-white rounded-3xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:max-w-lg w-full border border-gray-100">

                <div class="relative bg-gradient-to-br from-pink-500 to-rose-600 p-6 sm:p-8">
                    <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-white/10 rounded-full blur-2xl"></div>
                    <h3 class="text-2xl font-black text-white relative z-10">æ·»åŠ è®¢é˜…</h3>
                    <p class="text-pink-100 text-sm mt-1 relative z-10">å¼€å§‹è¿½è¸ªè¿™éƒ¨ç•ªå‰§çš„æ›´æ–°</p>
                    <button @click="modalOpen = false"
                        class="absolute top-4 right-4 text-pink-100 hover:text-white bg-white/20 hover:bg-white/30 rounded-full p-2 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>

                <div class="p-6 sm:p-8 bg-white">
                    <form hx-post="/api/subscriptions" hx-swap="none"
                        @htmx:after-request="modalOpen = false; window.location.reload()">
                        <div class="space-y-6">
                            <div class="space-y-2">
                                <label
                                    class="block text-xs font-bold text-gray-500 uppercase tracking-wider">ç•ªå‰§åç§°</label>
                                <input type="text" name="Title" :value="selectedAnime?.name"
                                    class="w-full px-4 py-3 rounded-xl border-gray-200 bg-gray-50 text-gray-800 font-bold focus:border-pink-500 focus:ring-pink-500 transition-all">
                            </div>

                            <div class="space-y-2">
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">RSS é“¾æ¥
                                    (Mikan Project)</label>
                                <div class="flex gap-2">
                                    <input type="text" name="RSSUrl" placeholder="ç²˜è´´ RSS é“¾æ¥..."
                                        class="w-full px-4 py-3 rounded-xl border-gray-200 bg-gray-50 focus:border-pink-500 focus:ring-pink-500 transition-all text-sm">
                                    <a :href="'https://mikanani.me/Home/Search?searchstr=' + encodeURIComponent(selectedAnime?.name)"
                                        target="_blank"
                                        class="shrink-0 px-4 py-3 bg-pink-100 text-pink-600 rounded-xl hover:bg-pink-200 flex items-center justify-center font-bold text-sm transition-colors group"
                                        title="å» Mikan æœç´¢">
                                        <span class="group-hover:scale-110 transition-transform">ğŸ”</span>
                                    </a>
                                </div>
                                <p class="text-xs text-gray-400">è¯·å‰å¾€ Mikan Project æœç´¢è¯¥ç•ªå‰§ï¼Œå¤åˆ¶ RSS é“¾æ¥å¡«å…¥æ­¤å¤„ã€‚</p>
                            </div>
                        </div>

                        <div class="mt-8 flex justify-end gap-3">
                            <button type="button" @click="modalOpen = false"
                                class="px-6 py-3 rounded-xl text-gray-500 font-bold hover:bg-gray-50 transition-colors">å–æ¶ˆ</button>
                            <button type="submit"
                                class="px-8 py-3 rounded-xl bg-gradient-to-r from-pink-500 to-rose-600 text-white font-bold hover:shadow-lg hover:shadow-pink-500/30 transform active:scale-95 transition-all">ç¡®è®¤è®¢é˜…</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }

    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    .perspective-1000 {
        perspective: 1000px;
    }

    .animate-bounce-in {
        animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    @keyframes bounceIn {
        0% {
            transform: scale(0.9) opacity(0);
        }

        100% {
            transform: scale(1) opacity(1);
        }
    }
</style>

{{ if not .SkipLayout }}{{ template "footer.html" . }}{{ end }}
{{ end }}